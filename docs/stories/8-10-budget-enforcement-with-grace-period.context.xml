<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>10</storyId>
    <title>Budget Enforcement with Grace Period</title>
    <status>drafted</status>
    <generatedAt>2025-11-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/8-10-budget-enforcement-with-grace-period.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>budget limits enforced per tenant with alerts and grace periods</iWant>
    <soThat>LLM costs are controlled while allowing flexibility during traffic spikes</soThat>
    <tasks>
      <task id="1" file="src/services/llm_service.py" acs="1,2,5">
        <description>Extend LLMService with Budget Management Methods</description>
        <subtasks>
          <subtask id="1.1">Add method get_budget_status(tenant_id: str) -> BudgetStatus</subtask>
          <subtask id="1.2">Add method check_budget_exceeded(tenant_id: str) -> tuple[bool, str]</subtask>
          <subtask id="1.3">Add method handle_budget_block(tenant_id: str, current_spend: float)</subtask>
          <subtask id="1.4">Update get_llm_client_for_tenant() to check budget before returning client</subtask>
          <subtask id="1.5">Add comprehensive docstrings (Google style) and type hints</subtask>
        </subtasks>
      </task>
      <task id="2" file="src/api/budget.py" acs="3,4">
        <description>Create Budget Webhook Endpoint</description>
        <subtasks>
          <subtask id="2.1">Create new FastAPI router: src/api/budget.py</subtask>
          <subtask id="2.2">Implement endpoint POST /api/v1/budget-alerts</subtask>
          <subtask id="2.3">Pydantic schema BudgetWebhookPayload with LiteLLM fields</subtask>
          <subtask id="2.4">Webhook signature validation (HMAC pattern)</subtask>
          <subtask id="2.5">Parse event field: handle budget_crossed, threshold_crossed, projected_limit_exceeded</subtask>
          <subtask id="2.6">Map user_id to tenant_id</subtask>
          <subtask id="2.7">At 80% threshold: Send alert notification</subtask>
          <subtask id="2.8">At 100%+: Send critical alert, log event</subtask>
          <subtask id="2.9">Return 200 OK immediately (async processing)</subtask>
          <subtask id="2.10">Add comprehensive error handling and audit logging</subtask>
        </subtasks>
      </task>
      <task id="3" file="src/services/notification_service.py" acs="4">
        <description>Implement Notification Service Integration</description>
      </task>
      <task id="4" file="src/admin/pages/02_Tenant_Management.py" acs="6">
        <description>Budget Dashboard UI</description>
      </task>
      <task id="5" file="src/admin/pages/02_Tenant_Management.py" acs="1,2">
        <description>Budget Configuration UI</description>
      </task>
      <task id="6" file="src/workers/tasks.py" acs="7">
        <description>Budget Reset Automation</description>
      </task>
      <task id="7" file="src/api/admin/tenants.py" acs="8">
        <description>Budget Override Mechanism</description>
      </task>
      <task id="8" file="alembic/versions/" acs="1,2,7,8">
        <description>Database Schema Updates</description>
      </task>
      <task id="9" file="src/workers/tasks.py, src/api/agents.py" acs="5">
        <description>Graceful Error Handling</description>
      </task>
      <task id="10" file="tests/unit/test_budget_enforcement.py" acs="1-8">
        <description>Unit Tests</description>
      </task>
      <task id="11" file="tests/integration/test_budget_workflow.py" acs="3,4,5,7">
        <description>Integration Tests</description>
      </task>
      <task id="12" file="litellm-config.yaml, docs/" acs="3,7">
        <description>LiteLLM Proxy Configuration Update</description>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Budget configuration UI: tenant settings page includes max_budget ($), alert_threshold (%), grace_threshold (%)</criterion>
    <criterion id="AC2">Default thresholds configured: alert at 80% ($400 of $500), block at 110% ($550 of $500)</criterion>
    <criterion id="AC3">LiteLLM webhook endpoint created: /api/v1/budget-alerts receives alerts from LiteLLM proxy</criterion>
    <criterion id="AC4">Alert logic implemented: at 80%, send email/Slack notification to tenant admin</criterion>
    <criterion id="AC5">Blocking logic implemented: at 110%, LiteLLM blocks requests, agent calls fail gracefully with "budget exceeded" error</criterion>
    <criterion id="AC6">Budget dashboard created: real-time usage display, progress bar, days remaining in period</criterion>
    <criterion id="AC7">Budget reset automation: resets monthly on anniversary of tenant creation (configurable period: 30d, 60d, 90d)</criterion>
    <criterion id="AC8">Override mechanism: platform admin can temporarily increase budget or disable enforcement</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/stories/8-9-virtual-key-management.md" title="Story 8.9: Virtual Key Management" section="Complete Story">
        <snippet>Prerequisite story that provides LLMService with virtual key management. Key integration point: get_llm_client_for_tenant() method where budget checks will be added. Story 8.9 completed and approved 2025-11-06.</snippet>
      </doc>
      <doc path="docs/epics.md" title="Epic 8: Agent Platform with LiteLLM" section="Story 8.10">
        <snippet>Budget Enforcement with Grace Period: Enforce per-tenant LLM budget limits with webhook alerts at 80%, blocking at 110% (grace period), budget reset automation (30d/60d/90d cycles), override mechanism for admins, budget dashboard UI.</snippet>
      </doc>
      <doc path="docs/architecture.md" title="Architecture Decision Record" section="ADR-003: OpenRouter API Gateway">
        <snippet>OpenRouter API Gateway with LiteLLM proxy provides multi-model LLM access. Integration point for budget enforcement via LiteLLM's native budget webhooks and virtual key management.</snippet>
      </doc>
      <doc path="docs/architecture.md" title="Architecture Decision Record" section="Security Architecture">
        <snippet>Fernet encryption for sensitive credentials, audit logging for all operations via AuditLog table. Budget enforcement must follow same security patterns: encrypt webhook secrets, log all budget events.</snippet>
      </doc>
      <doc path="docs/PRD.md" title="Product Requirements" section="NFR006: Cost Control">
        <snippet>Budget limits per tenant with alerts and enforcement. Real-time usage monitoring. Admin override capability for budget exceptions. Automated reset cycles.</snippet>
      </doc>
      <doc path="Context7: LiteLLM Budget Webhooks" title="LiteLLM Budget Enforcement (2025)" section="Webhook Events">
        <snippet>LiteLLM sends budget alerts to WEBHOOK_URL: event types are spend_tracked, threshold_crossed (soft budget at 80%), budget_crossed (100%), projected_limit_exceeded. Payload includes: spend, max_budget, token, user_id, team_id, event, event_group, event_message. Enable via general_settings: alerting: ["webhook"].</snippet>
      </doc>
      <doc path="Context7: LiteLLM Virtual Keys" title="LiteLLM Virtual Key Management (2025)" section="Budget Configuration">
        <snippet>Virtual keys support max_budget, soft_budget, budget_duration ("30s", "30m", "30h", "30d", "60d", "90d"), temp_budget_increase (override), model_max_budget (per-model limits). Budget resets automatically at end of duration. Key API endpoints: POST /key/generate, POST /key/update.</snippet>
      </doc>
      <doc path="Context7: LiteLLM" title="Grace Period Implementation (2025)" section="Budget Blocking">
        <snippet>LiteLLM blocks requests when max_budget exceeded. Grace period implemented via grace_threshold setting (e.g., 110% = $550 block point for $500 budget). Configurable per tenant via virtual key metadata.</snippet>
      </doc>
    </docs>
    <code>
      <artifact path="src/services/llm_service.py" kind="service" symbol="LLMService" lines="1-476" reason="Core integration point for budget enforcement. Contains get_llm_client_for_tenant() method (lines 288-344) where budget checks must be added before returning client. Provides audit logging pattern via log_audit_entry() (lines 442-475). File size: 476 lines (close to 500-line limit)." />
      <artifact path="src/services/llm_service.py" kind="service" symbol="LLMService.get_llm_client_for_tenant" lines="288-344" reason="THE integration point for budget enforcement. Add budget check at start of method before returning AsyncOpenAI client. This ensures all LLM calls are budget-checked transparently." />
      <artifact path="src/services/llm_service.py" kind="service" symbol="LLMService.log_audit_entry" lines="442-475" reason="Audit logging pattern to reuse for budget events (budget_crossed, threshold_crossed, budget_reset, budget_override). Logs to AuditLog table with tenant_id, operation, details (JSONB)." />
      <artifact path="src/database/models.py" kind="model" symbol="TenantConfig" lines="45-95" reason="Tenant configuration model to extend with budget columns: max_budget (FLOAT), alert_threshold (INTEGER), grace_threshold (INTEGER), budget_duration (VARCHAR), budget_reset_at (TIMESTAMPTZ), litellm_key_last_reset (TIMESTAMPTZ). Already has litellm_virtual_key, litellm_key_created_at from Story 8.9." />
      <artifact path="src/database/models.py" kind="model" symbol="AuditLog" lines="290-310" reason="Audit logging table for tracking operations. Reuse for budget events: budget_crossed, threshold_crossed, budget_reset, budget_override. Columns: tenant_id, operation, user, timestamp, details (JSONB)." />
      <artifact path="src/services/tenant_service.py" kind="service" symbol="TenantService" lines="1-520" reason="Tenant management service. Extend with budget configuration methods: update_budget_config(), get_budget_status(). Already integrated with tenant_configs table operations." />
      <artifact path="src/api/webhooks.py" kind="api" symbol="webhook_endpoint" lines="50-120" reason="Webhook endpoint pattern to follow for budget webhook. Shows signature validation, async processing, 200 OK return, error handling patterns." />
      <artifact path="src/services/webhook_service.py" kind="service" symbol="WebhookService.validate_signature" lines="25-55" reason="HMAC signature validation pattern. Reuse for LiteLLM budget webhook signature validation using litellm_webhook_secret." />
      <artifact path="src/admin/pages/02_Tenant_Management.py" kind="ui" symbol="tenant_detail_view" lines="150-250" reason="Tenant management UI to extend with budget dashboard and configuration sections. Shows existing patterns for displaying tenant metadata, configuration forms, real-time data with caching." />
      <artifact path="src/config.py" kind="config" symbol="Settings" lines="1-80" reason="Application settings. Add litellm_webhook_secret (str) for webhook signature validation. Already has litellm_proxy_url, litellm_master_key, encryption_key from Story 8.9." />
      <artifact path="src/workers/tasks.py" kind="worker" symbol="celery_app" lines="1-50" reason="Celery task definitions. Add budget_reset periodic task (runs daily at 00:00 UTC, checks tenants for budget reset)." />
      <artifact path="src/api/admin/tenants.py" kind="api" symbol="rotate_virtual_key" lines="375-486" reason="Virtual key rotation endpoint pattern from Story 8.9. Follow same pattern for budget override endpoints: POST /admin/tenants/{tenant_id}/budget-override, DELETE /admin/tenants/{tenant_id}/budget-override." />
      <artifact path="tests/unit/test_llm_service.py" kind="test" symbol="TestLLMService" lines="1-447" reason="Comprehensive testing pattern from Story 8.9 (25 tests, 100% passing). Follow same mocking strategy (pytest-mock for AsyncSession, httpx, encryption), edge case coverage (empty values, API failures, timeouts, encryption errors) for budget enforcement tests." />
    </code>
    <dependencies>
      <python version="3.12">
        <package name="httpx" version=">=0.25.2" usage="Async HTTP client for LiteLLM API calls (budget status, key updates, webhook outbound)" />
        <package name="cryptography" version=">=43.0.0" usage="Fernet encryption for webhook secret, virtual key encryption (established pattern from Story 8.9)" />
        <package name="pydantic" version=">=2.5.0" usage="BudgetWebhookPayload schema, BudgetStatus schema, validation" />
        <package name="sqlalchemy" version=">=2.0.23" usage="Database models for budget columns, budget_overrides table, budget_alert_history table" />
        <package name="alembic" version=">=1.12.1" usage="Database migration for budget schema changes" />
        <package name="celery" version=">=5.3.4" usage="Budget reset periodic task (daily at 00:00 UTC)" />
        <package name="redis" version=">=5.0.1" usage="Notification deduplication cache (1-hour TTL), budget status caching (60s)" />
        <package name="fastapi" version=">=0.104.0" usage="Budget webhook endpoint, budget override admin endpoints" />
        <package name="streamlit" version=">=1.44.0" usage="Budget dashboard UI, budget configuration forms" />
        <package name="loguru" version=">=0.7.2" usage="Logging for budget events, webhook processing" />
        <package name="prometheus-client" version=">=0.19.0" usage="Budget enforcement metrics (budget_exceeded_total, budget_alerts_total)" />
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="C1" priority="HIGH">File Size: â‰¤500 lines per file. llm_service.py currently 476 lines, adding ~100 lines will exceed limit. MITIGATION: Create separate src/services/budget_service.py (~300 lines) for budget-specific methods (get_budget_status, check_budget_exceeded, handle_budget_block), keep integration hook in llm_service.py.</constraint>
    <constraint id="C2" priority="HIGH">Test Coverage: Minimum 20 tests required (12 unit + 5 integration + 3 edge cases). Follow Story 8.9 testing pattern: comprehensive mocking (pytest-mock), 100% code paths, edge cases (API failures, timeouts, empty values, concurrent updates).</constraint>
    <constraint id="C3" priority="HIGH">Type Hints: All functions must have complete type hints. Mypy strict mode must pass (0 errors). Follow established patterns from llm_service.py.</constraint>
    <constraint id="C4" priority="HIGH">Async Patterns: All webhook handling, notification dispatch, database operations must be async. Use httpx.AsyncClient, async def, await patterns consistently.</constraint>
    <constraint id="C5" priority="HIGH">Security: Webhook signature validation required (HMAC constant-time comparison). Encrypt litellm_webhook_secret using Fernet. Admin-only endpoints for budget override (authorization check). All budget events logged to AuditLog.</constraint>
    <constraint id="C6" priority="MEDIUM">Performance: Webhook endpoint &lt;100ms p95 latency (async processing, immediate 200 OK). Budget status cached 60s (Redis). Notification deduplication 1-hour TTL. Budget reset batched (100 tenants per batch, 1s delay).</constraint>
    <constraint id="C7" priority="MEDIUM">Error Handling: Graceful degradation - budget check failures allow execution (fail-safe). Webhook failures return 200 OK (avoid LiteLLM retry storms). Notification failures don't block webhook (log error only).</constraint>
    <constraint id="C8" priority="MEDIUM">Database Schema: Use Alembic migration for schema changes. Add budget columns to tenant_configs, create budget_overrides table, create budget_alert_history table. Test upgrade and downgrade paths.</constraint>
    <constraint id="C9" priority="LOW">Documentation: Google-style docstrings for all functions. Update litellm-configuration.md with webhook setup. Document budget reset schedule in operational runbooks.</constraint>
    <constraint id="C10" priority="LOW">Code Style: Black formatting (line-length=100), Ruff linting, follow existing project conventions (PEP8, naming patterns).</constraint>
  </constraints>

  <interfaces>
    <interface name="LiteLLM Budget Webhook (Inbound)" kind="REST endpoint" path="src/api/budget.py">
      <signature>POST /api/v1/budget-alerts</signature>
      <description>Receives budget alert webhooks from LiteLLM proxy. Payload includes spend, max_budget, token, user_id (tenant_id), event (threshold_crossed, budget_crossed, projected_limit_exceeded), event_group, event_message.</description>
      <validation>HMAC signature validation using litellm_webhook_secret. Pydantic schema: BudgetWebhookPayload.</validation>
      <response>Returns 200 OK immediately. Async processing: parse event, send notifications, log audit entry.</response>
    </interface>

    <interface name="LiteLLM Virtual Key API (Outbound)" kind="REST API" path="external">
      <signature>POST {litellm_proxy_url}/key/generate</signature>
      <description>Create virtual key with max_budget, soft_budget (80% alert threshold), budget_duration ("30d", "60d", "90d"), grace_threshold (110% block point).</description>
      <auth>Authorization: Bearer {litellm_master_key}</auth>
      <response>JSON with key, expires, max_budget, budget_duration, created_at.</response>
    </interface>

    <interface name="LiteLLM Key Update API (Outbound)" kind="REST API" path="external">
      <signature>POST {litellm_proxy_url}/key/update</signature>
      <description>Update virtual key budget: temp_budget_increase (override amount), temp_budget_expiry (override duration). Used for budget override mechanism (AC8).</description>
      <auth>Authorization: Bearer {litellm_master_key}</auth>
      <response>JSON with updated key details, new max_budget, temp_budget_expires.</response>
    </interface>

    <interface name="Budget Service API (Internal)" kind="Python class" path="src/services/budget_service.py">
      <signature>async def get_budget_status(tenant_id: str) -> BudgetStatus</signature>
      <description>Returns BudgetStatus(spend: float, max_budget: float, percentage_used: float, grace_remaining: float, days_until_reset: int).</description>
    </interface>

    <interface name="Budget Service API (Internal)" kind="Python class" path="src/services/budget_service.py">
      <signature>async def check_budget_exceeded(tenant_id: str) -> tuple[bool, str]</signature>
      <description>Returns (exceeded: bool, error_message: str). Called by LLMService.get_llm_client_for_tenant() before returning client.</description>
    </interface>

    <interface name="Budget Override API (Admin)" kind="REST endpoint" path="src/api/admin/tenants.py">
      <signature>POST /admin/tenants/{tenant_id}/budget-override</signature>
      <description>Admin-only endpoint. Body: override_amount (float), duration (str, e.g., "7d"), reason (str). Updates virtual key with temp_budget_increase, stores override in budget_overrides table, logs audit entry.</description>
      <auth>Platform admin role required.</auth>
      <response>200 OK with updated budget details.</response>
    </interface>

    <interface name="Notification Service API (Internal)" kind="Python class" path="src/services/notification_service.py">
      <signature>async def send_budget_alert(tenant_id: str, alert_type: str, message: str) -> None</signature>
      <description>Sends email/Slack notification. Deduplication: 1-hour cache (Redis). Async dispatch via Celery task. Graceful failure handling (log error, don't block).</description>
    </interface>

    <interface name="TenantConfig Model Extension" kind="SQLAlchemy model" path="src/database/models.py">
      <signature>class TenantConfig(Base)</signature>
      <fields>max_budget: float = 500.00, alert_threshold: int = 80, grace_threshold: int = 110, budget_duration: str = "30d", budget_reset_at: datetime | None, litellm_key_last_reset: datetime | None</fields>
      <description>Extends existing TenantConfig model with budget enforcement columns. Migration required via Alembic.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>Testing framework: Pytest with pytest-asyncio for async tests. Mocking: pytest-mock for AsyncSession, httpx, Redis, encryption. Coverage target: 20+ tests (12 unit + 5 integration + 3 edge cases). Code quality: Mypy strict mode 0 errors, Black formatting, Bandit security scan clean. Test file locations: tests/unit/test_budget_enforcement.py, tests/integration/test_budget_workflow.py. Follow Story 8.9 testing excellence pattern: comprehensive mocking, 100% code path coverage, edge cases (API failures, timeouts, encryption errors, empty values, concurrent updates).</standards>

    <locations>
      <location>tests/unit/test_budget_enforcement.py</location>
      <location>tests/unit/test_budget_service.py</location>
      <location>tests/unit/test_notification_service.py</location>
      <location>tests/integration/test_budget_workflow.py</location>
      <location>tests/integration/test_budget_webhook_api.py</location>
    </locations>

    <ideas>
      <idea ac="AC1,AC2">Test budget configuration UI: valid inputs (max_budget=500, alert_threshold=80, grace_threshold=110), invalid inputs (negative budget, threshold out of range 50-150), validation error messages.</idea>
      <idea ac="AC3,AC4">Test webhook endpoint: valid payload at 80% threshold triggers alert notification, valid payload at 100% triggers critical alert, invalid signature rejected with 401, malformed payload returns 400, successful 200 OK response.</idea>
      <idea ac="AC4">Test notification deduplication: first alert sent successfully, duplicate alert within 1 hour skipped, alert after 1 hour sent successfully, Redis cache TTL verified.</idea>
      <idea ac="AC5">Test budget blocking: at 110% spend, check_budget_exceeded returns (True, error_message), get_llm_client_for_tenant raises BudgetExceededError, agent execution fails gracefully with 402 Payment Required, error message includes remediation steps.</idea>
      <idea ac="AC6">Test budget dashboard: get_budget_status returns correct spend/percentage/days_remaining, progress bar color changes (green &lt;80%, yellow 80-100%, red &gt;100%, dark red &gt;110%), cached data used (60s TTL), error handling displays "Budget data unavailable".</idea>
      <idea ac="AC7">Test budget reset automation: periodic task runs daily at 00:00 UTC, tenants with budget_reset_at &lt;= NOW() identified, virtual key budget reset via LiteLLM API, litellm_key_last_reset timestamp updated, audit log entry created, notification sent to tenant admin.</idea>
      <idea ac="AC8">Test budget override: admin grants override (temp_budget_increase), virtual key updated via LiteLLM API, override stored in budget_overrides table with expiry, audit log entry created, notification sent to tenant, override removed after expiry.</idea>
      <idea edge="concurrent_updates">Test concurrent budget updates: multiple webhooks processed simultaneously, no race conditions, database transactions handle conflicts, audit log maintains correct order.</idea>
      <idea edge="api_failures">Test LiteLLM API failures: timeout during budget status check (fail-safe allows execution), connection error during override (returns 503), retry logic with exponential backoff (2s, 4s, 8s), error logged to monitoring.</idea>
      <idea edge="zero_budget">Test edge case: tenant with 0 budget (blocks all requests), negative spend (validation error), budget exactly at threshold (80.00% triggers alert), grace period boundary (109.99% allowed, 110.00% blocked).</idea>
    </ideas>
  </tests>
</story-context>
