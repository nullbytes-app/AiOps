<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>10A</storyId>
    <title>Budget Enforcement - Testing & Migration</title>
    <status>drafted</status>
    <generatedAt>2025-11-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/8-10A-budget-testing-and-migration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>comprehensive test coverage and database migration applied for the budget enforcement system</iWant>
    <soThat>the core budget infrastructure is validated and ready for production deployment</soThat>
    <tasks>
      <task id="1" priority="high">
        <title>Apply Database Migration</title>
        <description>Apply alembic migration to create budget enforcement schema (columns and tables)</description>
        <acceptanceCriteria>#1, #5</acceptanceCriteria>
        <files>alembic/versions/001_add_budget_enforcement.py</files>
      </task>
      <task id="2" priority="high">
        <title>Complete Notification Service Unit Tests</title>
        <description>Write 10 unit tests for notification_service.py covering deduplication, templating, fail-safe patterns</description>
        <acceptanceCriteria>#2, #7</acceptanceCriteria>
        <files>tests/unit/test_notification_service.py</files>
      </task>
      <task id="3" priority="high">
        <title>Complete Budget Webhook Endpoint Tests</title>
        <description>Write 10 unit tests for budget webhook endpoint covering validation, signature, alerts</description>
        <acceptanceCriteria>#2, #3, #7</acceptanceCriteria>
        <files>tests/unit/test_budget_webhook.py</files>
      </task>
      <task id="4" priority="medium">
        <title>Write Integration Tests</title>
        <description>5 end-to-end tests covering budget workflow, blocking, grace period, validation, deduplication</description>
        <acceptanceCriteria>#3, #4</acceptanceCriteria>
        <files>tests/integration/test_budget_workflow.py</files>
      </task>
      <task id="5" priority="medium">
        <title>Test Edge Cases</title>
        <description>8 edge case tests: zero budget, boundaries, concurrent updates, API failures</description>
        <acceptanceCriteria>#7</acceptanceCriteria>
        <files>tests/unit/test_budget_edge_cases.py</files>
      </task>
      <task id="6" priority="medium">
        <title>Performance Validation</title>
        <description>Benchmark budget check &lt;50ms p95 and webhook processing &lt;100ms p95</description>
        <acceptanceCriteria>#8</acceptanceCriteria>
        <files>tests/performance/test_budget_performance.py</files>
      </task>
      <task id="7" priority="high">
        <title>Run Full Regression Test Suite</title>
        <description>Run all tests, generate coverage reports, verify no regressions</description>
        <acceptanceCriteria>#4</acceptanceCriteria>
        <files>tests/</files>
      </task>
      <task id="8" priority="low">
        <title>Documentation Updates</title>
        <description>Document testing strategy, coverage reports, migration steps</description>
        <acceptanceCriteria>#6</acceptanceCriteria>
        <files>docs/testing/budget-enforcement-testing.md, README.md</files>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" priority="critical">
      <title>Database migration applied</title>
      <description>alembic upgrade head successfully creates budget columns and tables</description>
      <verification>Run migration, verify tables/columns created via psql, test reversibility with downgrade</verification>
    </criterion>
    <criterion id="AC2" priority="critical">
      <title>Unit test coverage complete</title>
      <description>20+ unit tests passing (100% code coverage for budget service, notification service, webhook endpoint)</description>
      <verification>Run pytest tests/unit/ with coverage report, verify all critical paths tested</verification>
    </criterion>
    <criterion id="AC3" priority="high">
      <title>Integration tests implemented</title>
      <description>5 end-to-end tests covering critical workflows</description>
      <verification>Run pytest tests/integration/test_budget_workflow.py, verify all 5 scenarios pass</verification>
    </criterion>
    <criterion id="AC4" priority="critical">
      <title>Regression tests passing</title>
      <description>Full test suite runs successfully (all existing tests + new tests)</description>
      <verification>Run pytest tests/ -v, verify no test failures or regressions</verification>
    </criterion>
    <criterion id="AC5" priority="high">
      <title>Migration reversibility verified</title>
      <description>alembic downgrade works correctly</description>
      <verification>Test downgrade -1, verify columns removed, re-apply upgrade</verification>
    </criterion>
    <criterion id="AC6" priority="medium">
      <title>Test documentation updated</title>
      <description>All tests have clear docstrings and coverage reports generated</description>
      <verification>Review test files for docstrings, verify coverage HTML report exists</verification>
    </criterion>
    <criterion id="AC7" priority="high">
      <title>Edge cases tested</title>
      <description>Concurrent updates, API failures, zero budget, grace period boundaries</description>
      <verification>Run edge case tests, verify fail-safe patterns work correctly</verification>
    </criterion>
    <criterion id="AC8" priority="medium">
      <title>Performance validated</title>
      <description>Budget check latency &lt; 50ms p95, webhook processing &lt; 100ms p95</description>
      <verification>Run performance tests with benchmarking, verify latency targets met</verification>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/stories/8-10-budget-enforcement-with-grace-period.context.xml" title="Parent Story Context" section="Complete Context">
        <snippet>Comprehensive context for Story 8.10 including testing standards, code artifacts, interfaces, and test ideas. Follow same testing patterns: pytest-asyncio for async tests, pytest-mock for mocking AsyncSession/httpx/Redis, edge case coverage.</snippet>
      </doc>
      <doc path="docs/stories/8-10-budget-enforcement-with-grace-period.md" title="Parent Story 8.10" section="Complete Story">
        <snippet>Budget enforcement implementation story. Provides context for what was implemented in 8.10 and what needs comprehensive testing in 8.10A.</snippet>
      </doc>
      <doc path="docs/database-schema.md" title="Database Schema Documentation" section="tenant_configs Table">
        <snippet>Documents database schema including tenant_configs table. Migration 001_add_budget_enforcement.py extends this table with budget columns (max_budget, alert_threshold, grace_threshold, budget_duration, budget_reset_at, litellm_key_last_reset).</snippet>
      </doc>
      <doc path="tests/README.md" title="Testing Guide" section="Unit Tests, Integration Tests, Coverage">
        <snippet>Comprehensive testing guide: pytest with pytest-asyncio, unit tests in tests/unit/ with mocked dependencies, integration tests in tests/integration/ with real Docker dependencies. Coverage target >80%. Test naming convention: test_&lt;component&gt;_&lt;scenario&gt;_&lt;expected_result&gt;.</snippet>
      </doc>
      <doc path="Context7: pytest-dev/pytest" title="Pytest Best Practices (2025)" section="Async Testing">
        <snippet>Pytest 8.4+ deprecates direct use of async fixtures by synchronous tests. Use pytest-asyncio for async test functions with @pytest.mark.asyncio decorator. Profile test durations with --durations=N option. Use pytester fixture for plugin testing.</snippet>
      </doc>
      <doc path="Context7: sqlalchemy/alembic" title="Alembic Migration Testing (2025)" section="Upgrade/Downgrade Testing">
        <snippet>Test migration upgrade/downgrade paths using alembic.command API: command.upgrade(config, "head") for upgrades, command.downgrade(config, "-1") for single revision downgrade, command.downgrade(config, "base") for complete rollback. Generate SQL with sql=True parameter for review.</snippet>
      </doc>
    </docs>
    <code>
      <artifact path="src/services/budget_service.py" kind="service" symbol="BudgetService" lines="1-339" reason="Core budget enforcement service to test. Contains get_budget_status(), check_budget_exceeded(), handle_budget_block() methods. Already has 12 unit tests in test_budget_service.py covering basic functionality. Story 8.10A adds comprehensive edge case and integration testing." />
      <artifact path="src/services/notification_service.py" kind="service" symbol="NotificationService" lines="1-365" reason="Notification service for budget alerts. Contains send_budget_alert(), send_email(), send_slack() methods, Redis deduplication (1-hour TTL), Jinja2 email templates (EMAIL_80_TEMPLATE, EMAIL_100_TEMPLATE), Slack templates. NO TESTS YET - Story 8.10A Task 2 creates 10 unit tests." />
      <artifact path="src/api/budget.py" kind="api" symbol="receive_budget_alert" lines="1-290" reason="Budget webhook endpoint receiving LiteLLM alerts. Contains verify_webhook_signature() (HMAC validation), receive_budget_alert() endpoint handler, BudgetWebhookPayload Pydantic schema. NO TESTS YET - Story 8.10A Task 3 creates 10 unit tests." />
      <artifact path="alembic/versions/001_add_budget_enforcement.py" kind="migration" symbol="upgrade,downgrade" lines="1-120" reason="Database migration for budget enforcement schema. Creates budget columns in tenant_configs (max_budget, alert_threshold, grace_threshold, budget_duration, budget_reset_at, litellm_key_last_reset), budget_overrides table, budget_alert_history table. Story 8.10A Task 1 applies and tests migration reversibility." />
      <artifact path="tests/unit/test_budget_service.py" kind="test" symbol="TestBudgetServiceInit,TestGetBudgetStatus,TestCheckBudgetExceeded,TestHandleBudgetBlock,TestBudgetStatus" lines="1-500" reason="Existing 12 tests for BudgetService. Demonstrates testing patterns: pytest-mock for AsyncSession/httpx mocking, @pytest.mark.asyncio for async tests, comprehensive edge cases (API failures, timeouts, empty values). Follow same patterns for Tasks 2-5." />
      <artifact path="tests/unit/test_llm_service.py" kind="test" symbol="TestLLMService" lines="1-447" reason="Comprehensive testing pattern from Story 8.9 (25 tests, 100% passing). Follow same mocking strategy (pytest-mock for AsyncSession, httpx, encryption), edge case coverage (empty values, API failures, timeouts, encryption errors) for budget enforcement tests." />
      <artifact path="tests/conftest.py" kind="test" symbol="pytest fixtures" lines="1-200" reason="Global pytest fixtures for all tests. Contains mock_db, mock_redis, mock_httpx_client fixtures. Reuse for Task 2 (notification tests), Task 3 (webhook tests), Task 4 (integration tests)." />
      <artifact path="src/database/models.py" kind="model" symbol="TenantConfig" lines="45-95" reason="TenantConfig model extended with budget columns by migration 001_add_budget_enforcement.py. Verify schema changes in Task 1 migration testing." />
    </code>
    <dependencies>
      <python version="3.12">
        <package name="pytest" version=">=7.4.3" usage="Testing framework for all unit, integration, and performance tests" />
        <package name="pytest-asyncio" version=">=0.21.1" usage="Async test support with @pytest.mark.asyncio decorator (2025 best practices)" />
        <package name="pytest-mock" version=">=3.12.0" usage="Mocking AsyncSession, httpx.AsyncClient, Redis, SMTP for unit tests" />
        <package name="pytest-httpx" version=">=0.22.0" usage="Mock httpx requests for LiteLLM API calls in tests" />
        <package name="pytest-cov" version="included" usage="Coverage reports with --cov=src --cov-report=html" />
        <package name="alembic" version=">=1.12.1" usage="Database migration framework, test upgrade/downgrade with alembic.command API" />
        <package name="sqlalchemy" version=">=2.0.23" usage="ORM for database models, AsyncSession mocking in tests" />
        <package name="httpx" version=">=0.25.2" usage="Async HTTP client for LiteLLM API, mock in tests with pytest-httpx" />
        <package name="redis" version=">=5.0.1" usage="Notification deduplication cache, mock redis.asyncio.Redis in tests" />
        <package name="cryptography" version=">=43.0.0" usage="Fernet encryption for webhook secrets, test signature validation" />
        <package name="pydantic" version=">=2.5.0" usage="BudgetWebhookPayload validation, test schema validation errors" />
        <package name="freezegun" version="optional" usage="Time-based testing for deduplication TTL, grace period boundaries" />
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="C1" priority="HIGH">Test Coverage: Minimum 40 tests required (20+ unit, 5+ integration, 8+ edge cases, 2+ performance). Follow Story 8.9 testing pattern: comprehensive mocking (pytest-mock), 100% code paths, edge cases (API failures, timeouts, empty values, concurrent updates). Target: >90% coverage for budget_service.py, notification_service.py, budget.py.</constraint>
    <constraint id="C2" priority="HIGH">Async Testing: All tests for async functions must use @pytest.mark.asyncio decorator. Pytest 8.4+ deprecates direct use of async fixtures by synchronous tests - wrap async fixtures in synchronous ones if needed.</constraint>
    <constraint id="C3" priority="HIGH">Migration Testing: Test both upgrade and downgrade paths. Use alembic.command API for programmatic testing. Verify schema changes via database inspection after migration. Test reversibility: upgrade → downgrade → re-upgrade.</constraint>
    <constraint id="C4" priority="HIGH">Mocking Strategy: Mock all external dependencies (AsyncSession, httpx.AsyncClient, Redis, SMTP). Use pytest-mock for fixture-based mocking. Use pytest-httpx for httpx request mocking. No actual database/Redis/email in unit tests.</constraint>
    <constraint id="C5" priority="MEDIUM">Performance Benchmarks: Budget check latency &lt;50ms p95, webhook processing &lt;100ms p95. Use time.perf_counter() for measurements. Load tests: 100 concurrent budget checks, 50 webhooks/second.</constraint>
    <constraint id="C6" priority="MEDIUM">Edge Case Coverage: Test zero budget, negative spend, exact threshold boundaries (80.00%, 110.00%), concurrent updates, API timeouts, Redis failures, encryption errors, malformed payloads.</constraint>
    <constraint id="C7" priority="MEDIUM">Test Naming: Use descriptive names following pattern: test_&lt;component&gt;_&lt;scenario&gt;_&lt;expected_result&gt;. Examples: test_notification_service_deduplication_skips_duplicate_within_1_hour, test_webhook_invalid_signature_returns_401.</constraint>
    <constraint id="C8" priority="LOW">Test Documentation: All test functions must have docstrings explaining what is tested and why. Include coverage report in docs/testing/budget-enforcement-testing.md.</constraint>
    <constraint id="C9" priority="LOW">Regression Prevention: Run full test suite (pytest tests/) to verify no regressions in existing tests. Fix any failing tests before marking story complete.</constraint>
  </constraints>

  <interfaces>
    <interface name="Alembic Migration API (Testing)" kind="Python API" path="alembic.command">
      <signature>command.upgrade(config: Config, revision: str) -&gt; None</signature>
      <description>Programmatically run migration upgrades in tests. Use revision="head" for latest, specific revision ID for targeted upgrade.</description>
    </interface>
    <interface name="Alembic Migration API (Testing)" kind="Python API" path="alembic.command">
      <signature>command.downgrade(config: Config, revision: str) -&gt; None</signature>
      <description>Programmatically run migration downgrades in tests. Use revision="-1" for single step back, "base" for complete rollback.</description>
    </interface>
    <interface name="Budget Service (Testing Target)" kind="Python class" path="src/services/budget_service.py">
      <signature>async def get_budget_status(tenant_id: str) -&gt; BudgetStatus</signature>
      <description>Returns current budget status. Test with: valid tenant, missing tenant, LiteLLM API timeout, Redis cache hit/miss, concurrent calls.</description>
    </interface>
    <interface name="Budget Service (Testing Target)" kind="Python class" path="src/services/budget_service.py">
      <signature>async def check_budget_exceeded(tenant_id: str) -&gt; tuple[bool, str]</signature>
      <description>Returns (exceeded, error_message). Test: at 110% blocked, at 105% allowed (grace), at 80% allowed, zero budget blocked, API failures (fail-safe allows).</description>
    </interface>
    <interface name="Notification Service (Testing Target)" kind="Python class" path="src/services/notification_service.py">
      <signature>async def send_budget_alert(tenant_id: str, alert_type: str, spend: float, max_budget: float) -&gt; None</signature>
      <description>Sends email/Slack alert with deduplication. Test: first alert sent, duplicate within 1 hour skipped, alert after 1 hour sent, Redis failure (fail-safe sends), SMTP/Slack not configured (logs only), template rendering correct.</description>
    </interface>
    <interface name="Budget Webhook (Testing Target)" kind="REST endpoint" path="src/api/budget.py">
      <signature>POST /api/v1/budget-alerts (BudgetWebhookPayload) -&gt; 200 OK</signature>
      <description>Receives LiteLLM budget webhooks. Test: valid payload at 80%/100%, invalid signature (401), malformed payload (400), missing fields (422), successful async processing, audit log created.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>Testing framework: Pytest with pytest-asyncio (>=0.21.1) for async tests. Mocking: pytest-mock for AsyncSession, httpx, Redis, encryption. pytest-httpx for LiteLLM API mocking. Coverage target: 40+ tests (20 unit + 5 integration + 8 edge cases + 2 performance). Code quality: Mypy strict mode 0 errors, Black formatting, Bandit security scan clean. Test file locations: tests/unit/ (fast, mocked), tests/integration/ (real Docker), tests/performance/ (benchmarks). Follow Story 8.9 testing excellence pattern: comprehensive mocking, 100% code path coverage, edge cases (API failures, timeouts, encryption errors, empty values, concurrent updates). Pytest 8.4+ best practices: @pytest.mark.asyncio for async tests, avoid unawaited async fixtures, profile with --durations=N.</standards>

    <locations>
      <location>tests/unit/test_notification_service.py (NEW - Task 2, ~400 lines, 10 tests)</location>
      <location>tests/unit/test_budget_webhook.py (NEW - Task 3, ~400 lines, 10 tests)</location>
      <location>tests/unit/test_budget_edge_cases.py (NEW - Task 5, ~300 lines, 8 tests)</location>
      <location>tests/integration/test_budget_workflow.py (NEW - Task 4, ~300 lines, 5 tests)</location>
      <location>tests/performance/test_budget_performance.py (NEW - Task 6, ~200 lines, 2 tests)</location>
      <location>tests/unit/test_budget_service.py (EXISTING - 12 tests, reference for patterns)</location>
      <location>tests/unit/test_llm_service.py (EXISTING - 25 tests, comprehensive mocking reference)</location>
    </locations>

    <ideas>
      <idea ac="AC1,AC5">Migration Testing: Test upgrade creates all columns/tables (tenant_configs budget columns, budget_overrides, budget_alert_history). Test downgrade removes all budget schema. Test reversibility: upgrade → downgrade → re-upgrade. Verify foreign keys, indexes, default values. Use alembic.command API for programmatic testing.</idea>
      <idea ac="AC2">Notification Service Tests: Redis deduplication (first alert sent, duplicate within 1 hour skipped, after 1 hour sent), email template rendering (80% warning, 100% critical, variables substituted), Slack message formatting (metrics, emojis), SMTP not configured (logs preview), Slack not configured (logs preview), Redis failure (fail-safe sends), SMTP error (logged, doesn't block), concurrent notifications (no race conditions).</idea>
      <idea ac="AC2,AC3">Budget Webhook Tests: Valid payload at 80% returns 200 (alert triggered), valid at 100% returns 200 (critical alert), invalid HMAC signature returns 401, missing signature header returns 401, malformed JSON returns 400, missing required fields returns 422, budget_alert_history insert verified, audit log entry created, notification dispatch called (async), processing latency &lt;100ms p95.</idea>
      <idea ac="AC3,AC4">Integration Tests: End-to-end workflow (tenant creation → virtual key → budget set → spend tracked → 80% webhook → notification sent → alert stored), blocking workflow (110% spend → LLMService raises BudgetExceededError → 402 Payment Required), grace period (105% allowed, 110% blocked), webhook signature validation (invalid rejected), notification deduplication (duplicate within 1 hour skipped).</idea>
      <idea ac="AC7">Edge Case Tests: Zero budget blocks all requests, negative spend validation error, exact threshold boundaries (80.00% triggers, 79.99% doesn't), grace boundary (109.99% allowed, 110.00% blocked), concurrent budget updates (no race conditions), LiteLLM API timeout (fail-safe allows execution), Redis unavailable (deduplication skipped), LiteLLM 5xx error (retries with backoff).</idea>
      <idea ac="AC8">Performance Tests: Benchmark get_budget_status() latency (measure with cached/uncached), verify &lt;50ms p95 with Redis caching, benchmark webhook processing end-to-end, verify &lt;100ms p95, load test 100 concurrent budget checks (no degradation), load test 50 webhooks/second (queue doesn't grow), Redis deduplication performance (1000+ keys/second).</idea>
      <idea ac="AC4">Regression Testing: Run full test suite (pytest tests/ -v), verify all 1400+ existing tests still pass, check for test failures introduced by budget code changes, generate coverage report, verify no coverage regressions, update CI/CD pipeline to include budget tests.</idea>
    </ideas>
  </tests>
</story-context>
