<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.1</storyId>
    <title>Implement FastAPI Webhook Receiver Endpoint</title>
    <status>drafted</status>
    <generatedAt>2025-11-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-1-implement-fastapi-webhook-receiver-endpoint.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>ServiceDesk Plus instance</asA>
    <iWant>to send webhook notifications when tickets are created</iWant>
    <soThat>the enhancement agent can be triggered automatically</soThat>
    <tasks>
      <task id="1" ac="3">
        <title>Define Pydantic webhook schema</title>
        <subtasks>
          <subtask>Create src/schemas/webhook.py with WebhookPayload model</subtask>
          <subtask>Define fields: event, ticket_id, tenant_id, description, priority, created_at</subtask>
          <subtask>Add field validators for non-empty strings and valid priority enum</subtask>
          <subtask>Add model docstrings</subtask>
          <subtask>Unit tests: valid payload, invalid payload, missing fields</subtask>
        </subtasks>
      </task>
      <task id="2" ac="1,2,4">
        <title>Create webhook endpoint route</title>
        <subtasks>
          <subtask>Create src/api/webhooks.py with POST /webhook/servicedesk endpoint</subtask>
          <subtask>Accept WebhookPayload via Pydantic model with auto-validation</subtask>
          <subtask>Extract and normalize payload fields</subtask>
          <subtask>Return 202 Accepted response with job_id placeholder</subtask>
          <subtask>Unit tests: valid payload (202), invalid payload (422), missing Content-Type</subtask>
        </subtasks>
      </task>
      <task id="3" ac="5">
        <title>Implement request logging</title>
        <subtasks>
          <subtask>Add structured logging using Loguru from src/utils/logger.py</subtask>
          <subtask>Log timestamp, tenant_id, ticket_id, description_length, priority</subtask>
          <subtask>JSON format with correlation_id for tracing</subtask>
          <subtask>INFO level for success, WARNING for validation failures</subtask>
          <subtask>Unit tests: verify logging at correct levels with correct fields</subtask>
        </subtasks>
      </task>
      <task id="4" ac="1">
        <title>Add request/response documentation</title>
        <subtasks>
          <subtask>Add FastAPI OpenAPI docstrings with summary and description</subtask>
          <subtask>Document request body example in endpoint docstring</subtask>
          <subtask>Document response examples (202, 422, 400)</subtask>
          <subtask>Verify OpenAPI schema accessible at /docs</subtask>
          <subtask>Manual test: Try "Try it out" in Swagger UI</subtask>
        </subtasks>
      </task>
      <task id="5" ac="6,7">
        <title>Create unit tests</title>
        <subtasks>
          <subtask>Create tests/unit/test_webhook_endpoint.py</subtask>
          <subtask>Fixtures: valid webhook payload JSON, TestClient for FastAPI</subtask>
          <subtask>Test: valid payload → 202 with job_id</subtask>
          <subtask>Test: invalid priority → 422</subtask>
          <subtask>Test: missing ticket_id → 422</subtask>
          <subtask>Test: empty description → 422</subtask>
          <subtask>Test: valid minimal payload → 202</subtask>
          <subtask>Test: exact endpoint path /webhook/servicedesk</subtask>
          <subtask>Run pytest locally, verify 7+ tests pass</subtask>
        </subtasks>
      </task>
      <task id="6" ac="7">
        <title>Test endpoint with curl/Postman</title>
        <subtasks>
          <subtask>Start app: python -m uvicorn src.main:app --reload</subtask>
          <subtask>Test via curl with valid payload (202 expected)</subtask>
          <subtask>Test via curl with invalid payload (422 expected)</subtask>
          <subtask>Optional: Create Postman collection for regression testing</subtask>
          <subtask>Document sample payloads in completion notes</subtask>
        </subtasks>
      </task>
      <task id="7" ac="1">
        <title>Integration with main app</title>
        <subtasks>
          <subtask>Verify src/main.py imports and includes webhook router</subtask>
          <subtask>Check: app.include_router with prefix and tags</subtask>
          <subtask>Ensure router included before other routers</subtask>
          <subtask>Verify endpoint in GET /openapi.json schema</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">POST endpoint created at /webhook/servicedesk accepting JSON payload</criterion>
    <criterion id="2">Endpoint extracts ticket ID, description, priority, client identifier from payload</criterion>
    <criterion id="3">Basic input validation using Pydantic models</criterion>
    <criterion id="4">Endpoint returns 202 Accepted immediately (async processing)</criterion>
    <criterion id="5">Request logged with timestamp and payload summary</criterion>
    <criterion id="6">Unit tests cover valid payload, invalid payload, missing fields</criterion>
    <criterion id="7">Endpoint callable via curl/Postman with sample payload</criterion>
    <sources>docs/epics.md#Story-2.1, docs/PRD.md#Functional-Requirements, docs/architecture.md#API-Contracts</sources>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements - Ticket Integration &amp; Triggering (lines 32-36)</section>
        <snippet>FR001: Receive webhook notifications from ServiceDesk Plus when tickets created. FR002: Validate webhook signatures. FR003: Extract ticket metadata (ID, description, priority, client/tenant ID). FR004: Push validated requests to Redis queue.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Non-Functional Requirements (lines 70-73)</section>
        <snippet>NFR001: Complete enhancement within 120s from webhook receipt, p95 latency under 60s. NFR003: 99% success rate with automatic retry for transient failures.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>API Contracts - Webhook Endpoint (lines 389-424)</section>
        <snippet>POST /webhook/servicedesk accepts JSON with event, ticket_id, tenant_id, description, priority, created_at. Returns 202 Accepted with job_id. Includes X-ServiceDesk-Signature header for HMAC-SHA256 validation.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Core Technologies - Backend API (lines 62-65)</section>
        <snippet>FastAPI 0.104+ for async web framework with automatic OpenAPI docs. Pydantic 2.x for data validation and settings management. Uvicorn as ASGI server.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Security Architecture - Input Validation (lines 482-484)</section>
        <snippet>Webhook payloads validated with Pydantic models using strict typing and length limits (max 10,000 chars for description). SQLAlchemy ORM prevents SQL injection.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Integration Points - ServiceDesk Plus (lines 224-228)</section>
        <snippet>Inbound webhook POST to /webhook/servicedesk. Outbound REST API for ticket updates. API key per tenant in K8s Secrets. Retry policy: 3 attempts with exponential backoff (2s, 4s, 8s).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Definitions</title>
        <section>Epic 2: Core Enhancement Agent - Story 2.1 (lines 208-214)</section>
        <snippet>Story 2.1 acceptance criteria: POST /webhook/servicedesk endpoint, extract ticket metadata, Pydantic validation, return 202 Accepted, request logging, unit tests for valid/invalid/missing fields.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Definitions</title>
        <section>Epic 2 Overview (lines 193-198)</section>
        <snippet>Epic delivers end-to-end enhancement workflow from ServiceDesk Plus webhooks to ticket updates with AI-generated context, providing automated ticket enhancement with historical, documentation, and system context.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/main.py</path>
        <kind>application-entry</kind>
        <symbol>app</symbol>
        <lines>16-25</lines>
        <reason>FastAPI app instance where webhook router must be registered. Shows pattern: app.include_router() with prefix and tags.</reason>
      </artifact>
      <artifact>
        <path>src/api/health.py</path>
        <kind>api-router</kind>
        <symbol>router</symbol>
        <lines>12</lines>
        <reason>Example of APIRouter pattern with prefix and tags. Template for webhook router structure.</reason>
      </artifact>
      <artifact>
        <path>src/api/health.py</path>
        <kind>api-endpoint</kind>
        <symbol>health_check</symbol>
        <lines>16-63</lines>
        <reason>Example async endpoint with error handling, HTTPException usage, and OpenAPI docstrings. Pattern for webhook endpoint.</reason>
      </artifact>
      <artifact>
        <path>src/utils/logger.py</path>
        <kind>utility</kind>
        <symbol>logger, configure_logging</symbol>
        <lines>1-86</lines>
        <reason>Loguru logger configured for structured JSON logging. Use logger.info() with extra dict for webhook request logging.</reason>
      </artifact>
      <artifact>
        <path>src/config.py</path>
        <kind>configuration</kind>
        <symbol>Settings, settings</symbol>
        <lines>15-119</lines>
        <reason>Pydantic BaseSettings pattern for environment config. Shows validation, Field usage, and settings instantiation pattern.</reason>
      </artifact>
      <artifact>
        <path>src/services/queue_service.py</path>
        <kind>service</kind>
        <symbol>push_to_queue, ENHANCEMENT_QUEUE</symbol>
        <lines>25-57</lines>
        <reason>Redis queue service for job enqueueing (Story 2.3). Shows async pattern, error handling, and logging. Will be called by webhook endpoint in future stories.</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_config.py</path>
        <kind>test</kind>
        <symbol>clean_env</symbol>
        <lines>18-50</lines>
        <reason>Pytest fixture pattern for environment setup. Shows generator fixture pattern for test isolation.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="fastapi" version=">=0.104.0">Async web framework with automatic OpenAPI docs and Pydantic validation</package>
        <package name="pydantic" version=">=2.5.0">Data validation and settings management (included with FastAPI)</package>
        <package name="pydantic-settings" version=">=2.1.0">Environment-based settings with validation</package>
        <package name="uvicorn" version=">=0.24.0">ASGI server for running FastAPI application</package>
        <package name="loguru" version=">=0.7.2">Structured logging with JSON serialization support</package>
        <package name="httpx" version=">=0.25.2">Async HTTP client for testing and external API calls</package>
        <package name="pytest" version=">=7.4.3">Testing framework</package>
        <package name="pytest-asyncio" version=">=0.21.1">Async test support for pytest</package>
      </python>
      <runtime>
        <item>Python 3.12+ (project requirement)</item>
        <item>FastAPI automatic dependency injection for request validation</item>
        <item>Pydantic v2 for automatic JSON schema generation in OpenAPI</item>
      </runtime>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use FastAPI 0.104+ async patterns - all endpoints must be async def</constraint>
    <constraint>Pydantic 2.x models in src/schemas/ directory - separate from API routes for reusability</constraint>
    <constraint>Return 202 Accepted immediately - no blocking operations in webhook endpoint</constraint>
    <constraint>Structured JSON logging via Loguru with correlation_id - log at INFO for success, WARNING for validation failures</constraint>
    <constraint>Router registration in src/main.py must use include_router with prefix and tags</constraint>
    <constraint>All new code must follow existing patterns: type hints, docstrings (Google style), async/await</constraint>
    <constraint>Description field max length: 10,000 characters (per architecture security requirements)</constraint>
    <constraint>Unit tests required in tests/unit/ mirroring src/ structure - minimum 7 tests per story AC</constraint>
    <constraint>OpenAPI documentation required - use FastAPI docstrings with request/response examples</constraint>
    <constraint>No database writes in this story - webhook only validates and returns 202 (job queuing in Story 2.3)</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>POST /webhook/servicedesk</name>
      <kind>REST endpoint</kind>
      <signature>POST /webhook/servicedesk
Headers: Content-Type: application/json, X-ServiceDesk-Signature: &lt;hmac&gt;
Body: {"event": str, "ticket_id": str, "tenant_id": str, "description": str, "priority": str, "created_at": datetime}
Response 202: {"status": "accepted", "job_id": str, "message": str}
Response 422: Pydantic validation errors</signature>
      <path>docs/architecture.md lines 389-424</path>
    </interface>
    <interface>
      <name>WebhookPayload</name>
      <kind>Pydantic model</kind>
      <signature>class WebhookPayload(BaseModel):
    event: str
    ticket_id: str (non-empty)
    tenant_id: str (non-empty)
    description: str (max 10000 chars)
    priority: Literal["low", "medium", "high", "critical"]
    created_at: datetime</signature>
      <path>src/schemas/webhook.py (to be created)</path>
    </interface>
    <interface>
      <name>logger.info / logger.warning</name>
      <kind>logging interface</kind>
      <signature>logger.info(message, extra={"tenant_id": str, "ticket_id": str, "priority": str, "description_length": int, "correlation_id": str})</signature>
      <path>src/utils/logger.py</path>
    </interface>
    <interface>
      <name>APIRouter</name>
      <kind>FastAPI router</kind>
      <signature>router = APIRouter(prefix="/webhook", tags=["webhooks"])
@router.post("/servicedesk")
async def receive_webhook(payload: WebhookPayload) -&gt; dict</signature>
      <path>src/api/webhooks.py (to be created)</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Testing framework: Pytest with pytest-asyncio for async endpoint testing. Test files mirror src/ structure in tests/ directory. Naming convention: test_&lt;module_name&gt;.py (e.g., src/api/webhooks.py → tests/unit/test_webhook_endpoint.py). Use FastAPI TestClient for HTTP endpoint testing with automatic async handling. Fixtures in conftest.py for shared setup. Type hints required in all test functions. Docstrings required for test functions explaining what is being tested and expected outcome.</standards>
    <locations>
      <location>tests/unit/test_webhook_endpoint.py (new file for Story 2.1)</location>
      <location>tests/unit/conftest.py (shared fixtures - may already exist)</location>
      <location>tests/integration/ (future integration tests in Story 2.11+)</location>
    </locations>
    <ideas>
      <test id="AC1,AC2,AC4" priority="high">
        <name>test_valid_webhook_payload_returns_202</name>
        <description>POST valid webhook payload to /webhook/servicedesk, expect 202 Accepted response with job_id in response body. Validates AC#1 (endpoint exists), AC#2 (extracts fields), AC#4 (returns 202).</description>
      </test>
      <test id="AC3,AC6" priority="high">
        <name>test_invalid_priority_returns_422</name>
        <description>POST payload with invalid priority value (not in enum), expect 422 Unprocessable Entity with Pydantic validation error. Validates AC#3 (Pydantic validation), AC#6 (invalid payload test).</description>
      </test>
      <test id="AC3,AC6" priority="high">
        <name>test_missing_ticket_id_returns_422</name>
        <description>POST payload missing required ticket_id field, expect 422 with validation error indicating missing field. Validates AC#3 and AC#6.</description>
      </test>
      <test id="AC3,AC6" priority="high">
        <name>test_missing_description_returns_422</name>
        <description>POST payload missing required description field, expect 422 validation error. Validates AC#3 and AC#6.</description>
      </test>
      <test id="AC3,AC6" priority="medium">
        <name>test_empty_tenant_id_returns_422</name>
        <description>POST payload with empty string for tenant_id (non-empty validator), expect 422. Validates field validators work correctly.</description>
      </test>
      <test id="AC4,AC6" priority="medium">
        <name>test_minimal_valid_payload_returns_202</name>
        <description>POST payload with only required fields (no optional fields if any), expect 202 Accepted. Validates minimal payload handling.</description>
      </test>
      <test id="AC5,AC6" priority="high">
        <name>test_webhook_logs_request_at_info_level</name>
        <description>POST valid payload and capture logs (using caplog fixture), verify INFO level log exists with tenant_id, ticket_id, priority, description_length fields. Validates AC#5 (request logging).</description>
      </test>
      <test id="AC1" priority="medium">
        <name>test_endpoint_path_exact_match</name>
        <description>Verify endpoint is accessible at exact path /webhook/servicedesk (case-sensitive). Test with wrong path returns 404.</description>
      </test>
      <test id="AC7" priority="low">
        <name>test_response_schema_structure</name>
        <description>Validate 202 response body contains expected keys: status, job_id, message. Validates response contract for AC#7.</description>
      </test>
    </ideas>
  </tests>
</story-context>
