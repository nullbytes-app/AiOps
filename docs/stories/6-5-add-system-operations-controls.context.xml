<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>5</storyId>
    <title>Add System Operations Controls</title>
    <status>drafted</status>
    <generatedAt>2025-11-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/6-5-add-system-operations-controls.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>operations engineer</asA>
    <iWant>manual controls for system operations</iWant>
    <soThat>I can pause processing, clear queues, and perform maintenance tasks safely</soThat>
    <tasks>
      <task id="1" title="Create Operations Helper Module with Redis Control Functions">
        - Create src/admin/utils/operations_helper.py with system operation functions
        - Implement pause_processing(), resume_processing(), is_processing_paused()
        - Implement clear_celery_queue(), get_queue_length()
        - Implement sync_tenant_configs()
        - Implement get_worker_stats(), get_active_workers()
        - Add type hints and Google-style docstrings
        - Use @st.cache_data(ttl=10) for read-only functions
        - Implement proper error handling
      </task>
      <task id="2" title="Create Audit Logging System for Operations">
        - Design audit log storage using audit_log table
        - Create Alembic migration if table doesn't exist
        - Implement log_operation() function
        - Implement get_recent_operations(limit=20)
        - Apply @st.cache_data(ttl=5) for caching
        - Handle database errors gracefully
      </task>
      <task id="3" title="Implement Streamlit Confirmation Dialog Pattern">
        - Research Streamlit @st.dialog decorator (1.44.0+)
        - Create confirm_operation() function
        - Use @st.dialog for modal confirmations
        - Text input for "YES" confirmation (case-sensitive)
        - Use unique session state keys per operation
        - Test with multiple operations
      </task>
      <task id="4" title="Implement Operations Page UI with Warning Banner">
        - Update src/admin/pages/4_Operations.py
        - Add warning banner and system status display
        - Create Pause/Resume Processing section
        - Create Queue Management section with Clear Queue
        - Create Configuration Management section with Sync Tenant Configs
        - Implement confirmation dialog pattern for ALL operations
      </task>
      <task id="5" title="Implement Worker Health Display Section">
        - Create Worker Health section
        - Display worker stats in DataFrame (hostname, uptime, tasks)
        - Format uptime to human-readable
        - Add refresh button
        - Use @st.fragment(run_every="30s") for auto-refresh
      </task>
      <task id="6" title="Implement Operation Logs Display">
        - Create Operation Logs section
        - Display last 20 operations in DataFrame
        - Format timestamps and color-code status
        - Add CSV export for logs
      </task>
      <task id="7" title="Implement Celery Worker Pause/Resume Mechanism">
        - Use Redis flag pattern (system:pause_processing)
        - Modify Celery task decorator with before_start signal handler
        - If pause flag exists, requeue task
        - Update src/workers/celery_app.py or task file
        - Add unit and integration tests
        - Document pause mechanism
      </task>
      <task id="8" title="Implement Session State Management for Operations">
        - Initialize session state variables on page load
        - Use unique session state keys per operation
        - Implement state reset after operation completion
        - Test multiple rapid operations
        - Implement operation result feedback
      </task>
      <task id="9" title="Unit and Integration Testing">
        - Create tests/admin/test_operations_helper.py
        - Test all operations helper functions
        - Create tests/admin/test_operations_page.py
        - Mock Streamlit components
        - Integration tests for pause/resume cycle and queue clearing
        - Manual testing with Streamlit app
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Operations page with warning banner ("Caution: Manual operations can affect system behavior")</criterion>
    <criterion id="AC2">"Pause Processing" button stops Celery workers from picking up new jobs (sets Redis flag)</criterion>
    <criterion id="AC3">"Resume Processing" button clears pause flag</criterion>
    <criterion id="AC4">"Clear Queue" button with confirmation dialog removes all pending jobs from Redis</criterion>
    <criterion id="AC5">"Sync Tenant Configs" button reloads tenant configurations from database to Redis cache</criterion>
    <criterion id="AC6">"View Worker Health" section displays active workers with uptime and task counts</criterion>
    <criterion id="AC7">Operation logs displayed (last 20 operations with timestamp, user, action)</criterion>
    <criterion id="AC8">All operations require confirmation dialog with typed confirmation ("YES")</criterion>
    <criterion id="AC9">Audit log entry created for each operation</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR030 - System Operations Controls</section>
        <snippet>Admin UI shall expose controls for system operations (pause/resume processing, clear queues, sync tenant configs)</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>ADR-009: Streamlit for Admin UI</section>
        <snippet>Use Streamlit 1.30+ for the admin/operations UI (Epic 6). Rapid development 5-10x faster than React, perfect for ops tools and internal dashboards.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Epic 6 Admin UI Component</section>
        <snippet>Streamlit 1.30+ web-based admin dashboard framework. K8s service for Streamlit on port 8501. Structure: src/admin/ with app.py, pages, utils.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Definitions</title>
        <section>Epic 6 - Story 6.5</section>
        <snippet>Add System Operations Controls - Full story definition with 9 acceptance criteria and detailed implementation tasks.</snippet>
      </doc>
      <doc>
        <path>docs/operations/README.md</path>
        <title>Operations Documentation Index</title>
        <section>Operational Guides Overview</section>
        <snippet>Comprehensive operational documentation including deployment, monitoring, alerting, troubleshooting guides.</snippet>
      </doc>
      <doc>
        <path>docs/runbooks/worker-failures.md</path>
        <title>Worker Failures Runbook</title>
        <section>Celery Worker Troubleshooting</section>
        <snippet>Operational procedures for diagnosing and resolving Celery worker failures, queue health checks.</snippet>
      </doc>
      <doc>
        <path>docs/runbooks/high-queue-depth.md</path>
        <title>High Queue Depth Runbook</title>
        <section>Queue Management Procedures</section>
        <snippet>Procedures for handling high queue depth situations, queue monitoring, and clearing strategies.</snippet>
      </doc>
      <doc>
        <path>External: Streamlit Official Docs</path>
        <title>Streamlit st.dialog Documentation (2025)</title>
        <section>Modal Dialog Pattern</section>
        <snippet>@st.dialog decorator creates modal dialogs. Must close programmatically with st.rerun(). Use session state for confirmation results. Only one dialog at a time.</snippet>
      </doc>
      <doc>
        <path>External: Streamlit Official Docs</path>
        <title>Streamlit st.fragment Documentation (2025)</title>
        <section>Auto-Refresh Pattern</section>
        <snippet>@st.fragment(run_every="30s") enables automatic rerun at intervals. Replaces deprecated @st.experimental_fragment. Perfect for streaming data and worker health monitoring.</snippet>
      </doc>
      <doc>
        <path>External: Web Research</path>
        <title>Celery Worker Pause/Resume Patterns (2025)</title>
        <section>Redis Flag Pattern for Task Control</section>
        <snippet>No built-in pause API. Community consensus: Use Redis flag checked by tasks before execution. If flag exists, requeue with Retry(countdown=30). Safe approach with no task loss.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/workers/celery_app.py</path>
        <kind>celery_configuration</kind>
        <symbol>celery_app</symbol>
        <lines>1-115</lines>
        <reason>Celery application instance needed for control operations (purge, inspect). Must import for pause/resume mechanism and worker stats.</reason>
      </artifact>
      <artifact>
        <path>src/config.py</path>
        <kind>configuration</kind>
        <symbol>Settings</symbol>
        <lines>28-189</lines>
        <reason>Contains redis_url (line 63), celery_broker_url (line 75), celery_result_backend (line 79) needed for Redis and Celery client connections.</reason>
      </artifact>
      <artifact>
        <path>src/admin/utils/db_helper.py</path>
        <kind>database_utility</kind>
        <symbol>get_sync_engine, get_db_session</symbol>
        <lines>all</lines>
        <reason>Database connection functions to reuse for audit_log table operations. Pattern: @st.cache_resource for connection pooling.</reason>
      </artifact>
      <artifact>
        <path>src/admin/utils/redis_helper.py</path>
        <kind>redis_utility</kind>
        <symbol>get_sync_redis_client, get_redis_queue_depth</symbol>
        <lines>all</lines>
        <reason>Redis client functions to reuse for pause flag and queue operations. get_redis_queue_depth already implements queue length check.</reason>
      </artifact>
      <artifact>
        <path>src/admin/utils/history_helper.py</path>
        <kind>streamlit_utility</kind>
        <symbol>convert_to_csv, format_status_badge</symbol>
        <lines>pattern</lines>
        <reason>Reusable CSV export pattern for operation logs export. Status badge formatting for color-coded operation status display.</reason>
      </artifact>
      <artifact>
        <path>src/database/models.py</path>
        <kind>database_models</kind>
        <symbol>TenantConfig, EnhancementHistory, TicketHistory, SystemInventory</symbol>
        <lines>27-386</lines>
        <reason>Existing models show pattern for creating AuditLog model. No AuditLog model exists yet - must create via Alembic migration.</reason>
      </artifact>
      <artifact>
        <path>src/admin/pages/1_Dashboard.py</path>
        <kind>streamlit_page</kind>
        <symbol>page_structure</symbol>
        <lines>pattern</lines>
        <reason>Reference pattern for Streamlit page structure, authentication, session state management for Operations page implementation.</reason>
      </artifact>
      <artifact>
        <path>src/admin/pages/2_Tenants.py</path>
        <kind>streamlit_page</kind>
        <symbol>CRUD_operations</symbol>
        <lines>pattern</lines>
        <reason>Reference pattern for confirmation dialogs and session state management for destructive operations.</reason>
      </artifact>
      <artifact>
        <path>src/admin/pages/3_History.py</path>
        <kind>streamlit_page</kind>
        <symbol>dataframe_display</symbol>
        <lines>pattern</lines>
        <reason>Reference pattern for DataFrame display, filtering, pagination, CSV export for operation logs display.</reason>
      </artifact>
      <artifact>
        <path>tests/admin/test_db_helper.py</path>
        <kind>test_pattern</kind>
        <symbol>pytest_streamlit_mocking</symbol>
        <lines>pattern</lines>
        <reason>Shows pytest-mock patterns for Streamlit components (@st.cache_resource, st.session_state mocking).</reason>
      </artifact>
      <artifact>
        <path>tests/admin/test_redis_helper.py</path>
        <kind>test_pattern</kind>
        <symbol>redis_mocking</symbol>
        <lines>pattern</lines>
        <reason>Reference for mocking Redis client operations in tests.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="streamlit" version=">=1.44.0">Admin UI framework with @st.dialog and @st.fragment support</package>
        <package name="pandas" version=">=2.1.0">DataFrame operations for data display</package>
        <package name="redis" version=">=5.0.1">Redis client for pause flag and queue operations</package>
        <package name="celery" version=">=5.3.4">Celery client for worker control and inspection</package>
        <package name="sqlalchemy" version=">=2.0.23">ORM for audit_log table operations</package>
        <package name="alembic" version=">=1.12.1">Database migrations for audit_log table</package>
        <package name="psycopg2-binary" version=">=2.9.9">PostgreSQL adapter for sync operations</package>
        <package name="pydantic" version=">=2.5.0">Data validation for operation parameters</package>
        <package name="pytest" version=">=7.4.3">Unit testing framework</package>
        <package name="pytest-mock" version=">=3.12.0">Mocking for Streamlit and Redis</package>
      </python>
      <framework>Python 3.12+ with type hints and Google-style docstrings</framework>
      <testing>pytest with pytest-mock for Streamlit component mocking</testing>
      <database>PostgreSQL with SQLAlchemy ORM (sync mode for Streamlit compatibility)</database>
      <caching>Redis for pause flags, queue management, tenant config caching</caching>
      <workers>Celery 5.3.4+ with Redis broker for distributed task processing</workers>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="C1">All files must be under 500 lines (CLAUDE.md requirement) - refactor if approaching limit</constraint>
    <constraint id="C2">Synchronous operations only (Streamlit compatibility) - NO async/await patterns</constraint>
    <constraint id="C3">Use @st.cache_resource for connection pooling (database, Redis clients)</constraint>
    <constraint id="C4">Use @st.cache_data(ttl=N) for read-only query functions with appropriate TTL</constraint>
    <constraint id="C5">PEP8 compliance with Black formatter, line length 100, Python 3.12+ type hints</constraint>
    <constraint id="C6">Google-style docstrings required for all functions (Args, Returns, Raises)</constraint>
    <constraint id="C7">Redis pause flag must have TTL (24 hours) for safety - auto-resume if admin forgets</constraint>
    <constraint id="C8">All operations require confirmation dialog with typed "YES" (case-sensitive) per AC8</constraint>
    <constraint id="C9">Audit log entry required for EVERY operation per AC9 (compliance requirement)</constraint>
    <constraint id="C10">Use project-relative paths only (strip {project-root} prefix) in all references</constraint>
    <constraint id="C11">Celery pause mechanism must be non-destructive - tasks requeued, not lost</constraint>
    <constraint id="C12">Unique session state keys per operation (prevent dialog conflicts)</constraint>
    <constraint id="C13">Test coverage: 1 expected case, 1 edge case, 1 failure case minimum per function</constraint>
    <constraint id="C14">No hardcoded secrets - use environment variables or Streamlit secrets</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Redis Pause Control</name>
      <kind>Redis Key-Value</kind>
      <signature>Key: "system:pause_processing", Value: "true", TTL: 86400 seconds</signature>
      <path>Redis database (settings.redis_url)</path>
    </interface>
    <interface>
      <name>Celery Control API - Purge Queue</name>
      <kind>Python API</kind>
      <signature>celery_app.control.purge() -> int (returns count of deleted tasks)</signature>
      <path>src/workers/celery_app.py</path>
    </interface>
    <interface>
      <name>Celery Control API - Worker Stats</name>
      <kind>Python API</kind>
      <signature>celery_app.control.inspect().stats() -> dict[str, dict] (worker hostname -> stats)</signature>
      <path>src/workers/celery_app.py</path>
    </interface>
    <interface>
      <name>Redis Queue Length</name>
      <kind>Redis Command</kind>
      <signature>redis_client.llen("celery") -> int (returns queue depth)</signature>
      <path>src/admin/utils/redis_helper.py - get_redis_queue_depth()</path>
    </interface>
    <interface>
      <name>Database Session Context Manager</name>
      <kind>Python Context Manager</kind>
      <signature>with get_db_session() as session: ... (yields SQLAlchemy session)</signature>
      <path>src/admin/utils/db_helper.py - get_db_session()</path>
    </interface>
    <interface>
      <name>Audit Log Table Schema</name>
      <kind>Database Table</kind>
      <signature>audit_log (id UUID PK, timestamp DateTime, user String, operation String, details JSON, status String)</signature>
      <path>New table - requires Alembic migration</path>
    </interface>
    <interface>
      <name>Streamlit Dialog Pattern</name>
      <kind>Python Decorator</kind>
      <signature>@st.dialog("Title") def dialog_func(): ... (st.rerun() to close)</signature>
      <path>Streamlit 1.44.0+ API</path>
    </interface>
    <interface>
      <name>Streamlit Fragment Auto-Refresh</name>
      <kind>Python Decorator</kind>
      <signature>@st.fragment(run_every="30s") def fragment_func(): ... (auto-reruns every 30s)</signature>
      <path>Streamlit 1.44.0+ API</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Framework: pytest 7.4.3+ with pytest-mock 3.12.0+ for mocking Streamlit components.
      Coverage: Minimum 1 expected case, 1 edge case, 1 failure case per function (CLAUDE.md requirement).
      Patterns: Mock st.session_state, st.dialog, st.button, st.dataframe, st.cache_resource, st.cache_data for unit tests.
      Integration: Use real Redis and database instances with test data or cleanup after tests.
      Fixtures: Use pytest fixtures with autouse=True for cache clearing between tests.
      Assertions: Verify function return values, side effects (Redis keys set/deleted, database records created), and error handling.
    </standards>
    <locations>
      tests/admin/test_operations_helper.py - Unit tests for operations helper functions
      tests/admin/test_operations_page.py - UI component tests with Streamlit mocking
      tests/integration/ - Integration tests for pause/resume cycle and queue operations
    </locations>
    <ideas>
      <test ac="AC1" idea="Verify Operations page renders warning banner with correct text"/>
      <test ac="AC2" idea="Test pause_processing() sets Redis key 'system:pause_processing' with 24h TTL"/>
      <test ac="AC2" idea="Test is_processing_paused() returns True when key exists, False when absent"/>
      <test ac="AC3" idea="Test resume_processing() deletes Redis key successfully"/>
      <test ac="AC4" idea="Test clear_celery_queue() calls celery_app.control.purge() and returns task count"/>
      <test ac="AC4" idea="Mock confirmation dialog returns True, verify queue clearing executes"/>
      <test ac="AC5" idea="Test sync_tenant_configs() loads tenant_config records and updates Redis cache keys"/>
      <test ac="AC5" idea="Verify Redis keys 'tenant_config:{tenant_id}' created for all active tenants"/>
      <test ac="AC6" idea="Test get_worker_stats() calls celery_app.control.inspect().stats() and transforms data"/>
      <test ac="AC6" idea="Test Worker Health section displays 'No active workers' when inspect returns empty dict"/>
      <test ac="AC7" idea="Test log_operation() creates audit_log record with correct fields (timestamp, user, operation, details, status)"/>
      <test ac="AC7" idea="Test get_recent_operations() returns last 20 records ordered by timestamp DESC"/>
      <test ac="AC8" idea="Test confirmation dialog requires exactly 'YES' (case-sensitive) before enabling Confirm button"/>
      <test ac="AC8" idea="Verify session state set correctly on confirm (True) and cancel (False)"/>
      <test ac="AC9" idea="Integration test: Execute each operation, verify audit_log entry created"/>
      <test task="Task7" idea="Integration test: Set pause flag, enqueue task, verify task NOT executed, clear flag, verify task executes"/>
      <test task="Task7" idea="Test Celery task checks Redis flag before execution and requeues if flag exists"/>
      <test edge="Redis unavailable" idea="Test operations handle Redis connection errors gracefully, return error indicators"/>
      <test edge="Database unavailable" idea="Test audit logging handles database errors, logs error but doesn't block operation"/>
      <test edge="No Celery workers" idea="Test get_worker_stats() returns empty list when no workers active"/>
      <test failure="Invalid operation" idea="Test log_operation() with missing required fields raises appropriate error"/>
    </ideas>
  </tests>
</story-context>
