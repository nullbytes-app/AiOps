<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.1</storyId>
    <title>Implement Row-Level Security in PostgreSQL</title>
    <status>drafted</status>
    <generatedAt>2025-11-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-1-implement-row-level-security-in-postgresql.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>platform architect</asA>
    <iWant>to implement PostgreSQL Row-Level Security (RLS) on all tenant-scoped tables</iWant>
    <soThat>data isolation is enforced at the database level, preventing any cross-tenant data leakage even if application-level filtering fails</soThat>
    <tasks>
      <task id="1" title="Design RLS Policy Strategy" acs="1, 6">
        <subtask id="1.1">Review architecture.md RLS section (lines 352-406)</subtask>
        <subtask id="1.2">Research PostgreSQL 17 RLS best practices</subtask>
        <subtask id="1.3">Design RLS policy structure</subtask>
        <subtask id="1.4">Plan session variable management</subtask>
        <subtask id="1.5">Identify edge cases and security risks</subtask>
      </task>
      <task id="2" title="Create Database Migration for RLS" acs="1, 4">
        <subtask id="2.1">Create Alembic migration file</subtask>
        <subtask id="2.2">Implement upgrade() function - Part 1: Helper function</subtask>
        <subtask id="2.3">Implement upgrade() function - Part 2: Enable RLS on tables</subtask>
        <subtask id="2.4">Implement upgrade() function - Part 3: Create RLS policies</subtask>
        <subtask id="2.5">Implement downgrade() function</subtask>
        <subtask id="2.6">Create database admin role with BYPASSRLS</subtask>
        <subtask id="2.7">Test migration on local database</subtask>
      </task>
      <task id="3" title="Implement SQLAlchemy Integration" acs="2, 3">
        <subtask id="3.1">Create tenant context manager utility</subtask>
        <subtask id="3.2">Create FastAPI dependency for tenant injection</subtask>
        <subtask id="3.3">Create database session dependency with RLS</subtask>
        <subtask id="3.4">Update webhook endpoint to use RLS-aware session</subtask>
        <subtask id="3.5">Update Celery tasks to set tenant context</subtask>
        <subtask id="3.6">Update all database repository methods</subtask>
      </task>
      <task id="4" title="Create Comprehensive Tests" acs="5">
        <subtask id="4.1">Create RLS unit test file</subtask>
        <subtask id="4.2">Test: RLS policies block cross-tenant SELECT</subtask>
        <subtask id="4.3">Test: RLS policies block cross-tenant INSERT</subtask>
        <subtask id="4.4">Test: RLS policies block cross-tenant UPDATE</subtask>
        <subtask id="4.5">Test: RLS policies block cross-tenant DELETE</subtask>
        <subtask id="4.6">Test: Missing tenant context returns empty results</subtask>
        <subtask id="4.7">Test: set_tenant_context validates tenant existence</subtask>
        <subtask id="4.8">Test: BYPASSRLS role can see all data</subtask>
        <subtask id="4.9">Create RLS integration test</subtask>
        <subtask id="4.10">Performance benchmark test</subtask>
      </task>
      <task id="5" title="Security Validation & Penetration Testing" acs="6">
        <subtask id="5.1">Manual SQL injection test</subtask>
        <subtask id="5.2">Test RLS bypass attempts</subtask>
        <subtask id="5.3">Code audit for RLS compliance</subtask>
        <subtask id="5.4">Review Alembic migration security</subtask>
        <subtask id="5.5">Create security documentation</subtask>
      </task>
      <task id="6" title="Update Documentation" acs="7">
        <subtask id="6.1">Update architecture.md</subtask>
        <subtask id="6.2">Create RLS troubleshooting guide</subtask>
        <subtask id="6.3">Update Alembic migration README</subtask>
        <subtask id="6.4">Create developer onboarding guide for RLS</subtask>
        <subtask id="6.5">Update tests/README.md</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1" title="RLS Policies Created for All Tenant Tables">
      <requirement>Row-level security enabled on tables: tenant_configs, enhancement_history, ticket_history, system_inventory</requirement>
      <requirement>RLS policies enforce tenant_id filtering using current_setting('app.current_tenant_id')</requirement>
      <requirement>Policies apply to all DML operations (SELECT, INSERT, UPDATE, DELETE)</requirement>
      <requirement>Migration script created and tested</requirement>
      <requirement>RLS enabled via: ALTER TABLE &lt;table&gt; ENABLE ROW LEVEL SECURITY;</requirement>
    </criterion>
    <criterion id="2" title="Session Variable Helper Function Implemented">
      <requirement>PostgreSQL function set_tenant_context(tenant_id VARCHAR) created</requirement>
      <requirement>Function sets app.current_tenant_id session variable securely</requirement>
      <requirement>Function is SECURITY DEFINER to prevent privilege escalation</requirement>
      <requirement>Application layer calls this function before each request (middleware integration)</requirement>
      <requirement>Function validates tenant_id exists in tenant_configs before setting</requirement>
    </criterion>
    <criterion id="3" title="SQLAlchemy Integration Complete">
      <requirement>Middleware/decorator automatically calls set_tenant_context() on each request</requirement>
      <requirement>Tenant ID extracted from webhook payload or authentication context</requirement>
      <requirement>Database session properly scoped per request with tenant context</requirement>
      <requirement>Context cleared after request completion (cleanup in finally block)</requirement>
      <requirement>Unit tests verify context is set correctly for all database operations</requirement>
    </criterion>
    <criterion id="4" title="RLS Bypass for Admin Operations">
      <requirement>Database admin role created with BYPASSRLS attribute for maintenance tasks</requirement>
      <requirement>Application uses standard app_user role (subject to RLS)</requirement>
      <requirement>Alembic migrations use admin role to bypass RLS during schema changes</requirement>
      <requirement>Clear documentation of when to use admin vs app_user roles</requirement>
    </criterion>
    <criterion id="5" title="Comprehensive Testing">
      <requirement>Unit tests: Verify RLS policies block cross-tenant access</requirement>
      <requirement>Integration tests: Multi-tenant scenarios with concurrent requests</requirement>
      <requirement>Test case: User A cannot see/modify User B's data (different tenants)</requirement>
      <requirement>Test case: RLS policy correctly filters SELECT, INSERT, UPDATE, DELETE</requirement>
      <requirement>Test case: Missing tenant context results in zero rows returned</requirement>
      <requirement>Performance test: RLS overhead &lt;5% on typical queries</requirement>
    </criterion>
    <criterion id="6" title="Security Validation">
      <requirement>Manual penetration test: Attempt SQL injection bypassing tenant_id filter</requirement>
      <requirement>Code review: Verify no application code bypasses set_tenant_context()</requirement>
      <requirement>Audit: All database queries go through SQLAlchemy (no raw SQL without tenant context)</requirement>
      <requirement>Documentation: Security implications of RLS documented in docs/security.md</requirement>
    </criterion>
    <criterion id="7" title="Documentation Complete">
      <requirement>RLS architecture documented in docs/architecture.md (updated ADR-020)</requirement>
      <requirement>Alembic migration guide updated with RLS considerations</requirement>
      <requirement>Troubleshooting guide: Common RLS issues (empty results, permission denied)</requirement>
      <requirement>Developer onboarding: How to write tenant-aware queries</requirement>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements - FR018</section>
        <snippet>System shall isolate client data using row-level security in PostgreSQL</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Non-Functional Requirements - NFR004</section>
        <snippet>System shall enforce data isolation between tenants using row-level security, validate all webhook signatures, encrypt credentials at rest</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Database Schema - Enhancement History (lines 332-357)</section>
        <snippet>RLS policy: ALTER TABLE enhancement_history ENABLE ROW LEVEL SECURITY; CREATE POLICY tenant_isolation_policy FOR ALL USING (tenant_id = current_setting('app.current_tenant_id')::VARCHAR)</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Database Schema - Ticket History (lines 359-382)</section>
        <snippet>RLS enabled with tenant_isolation_policy using session variable app.current_tenant_id for filtering</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Database Schema - System Inventory (lines 384-407)</section>
        <snippet>RLS policy applies FOR ALL operations with tenant_id isolation pattern</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>ADR-020 - Ticket History Synchronization (line 1211)</section>
        <snippet>References RLS implementation for ticket_history table with tenant isolation requirements</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Definitions</title>
        <section>Epic 3: Multi-Tenancy &amp; Security</section>
        <snippet>Deliverables include row-level security, tenant configuration system, webhook signature validation, secrets management, input validation</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>alembic/versions/2075b4285d2b_add_rls_policies_for_multi_tenant_.py</path>
        <kind>migration</kind>
        <symbol>upgrade, downgrade</symbol>
        <lines>1-80</lines>
        <reason>Existing RLS migration partially implements policies for enhancement_history and tenant_configs, needs extension for ticket_history and system_inventory tables</reason>
      </artifact>
      <artifact>
        <path>src/database/models.py</path>
        <kind>models</kind>
        <symbol>TenantConfig, EnhancementHistory, TicketHistory, SystemInventory</symbol>
        <lines></lines>
        <reason>SQLAlchemy ORM models for tenant-scoped tables requiring RLS protection</reason>
      </artifact>
      <artifact>
        <path>src/database/session.py</path>
        <kind>service</kind>
        <symbol>get_async_session, get_async_engine</symbol>
        <lines></lines>
        <reason>Database session management - needs enhancement for tenant context injection</reason>
      </artifact>
      <artifact>
        <path>src/api/webhooks.py</path>
        <kind>controller</kind>
        <symbol>receive_webhook, store_resolved_ticket</symbol>
        <lines></lines>
        <reason>Webhook endpoints that must use RLS-aware database sessions with tenant_id extraction</reason>
      </artifact>
      <artifact>
        <path>src/workers/tasks.py</path>
        <kind>worker</kind>
        <symbol>enhance_ticket</symbol>
        <lines></lines>
        <reason>Celery task processing requiring tenant context setup before database operations</reason>
      </artifact>
      <artifact>
        <path>tests/conftest.py</path>
        <kind>test</kind>
        <symbol>pytest fixtures</symbol>
        <lines></lines>
        <reason>Test configuration and fixtures for multi-tenant test setup</reason>
      </artifact>
    </code>
    <dependencies>
      <python version=">=3.12">
        <package name="fastapi" version=">=0.104.0">API framework for webhook endpoints with dependency injection</package>
        <package name="sqlalchemy" version=">=2.0.23" extras="asyncio">Async ORM for database operations and RLS context management</package>
        <package name="alembic" version=">=1.12.1">Database migration framework for RLS policy deployment</package>
        <package name="asyncpg" version=">=0.29.0">PostgreSQL async driver supporting session variables</package>
        <package name="pydantic" version=">=2.5.0">Data validation for tenant_id and request models</package>
        <package name="celery" version=">=5.3.4" extras="redis">Asynchronous task queue requiring tenant context injection</package>
        <package name="pytest" version=">=7.4.3">Testing framework for RLS unit and integration tests</package>
        <package name="pytest-asyncio" version=">=0.21.1">Async test support for database operations</package>
      </python>
      <database>
        <package name="PostgreSQL" version=">=17">Database with row-level security support</package>
      </database>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Follow existing Alembic migration patterns from alembic/versions/</constraint>
    <constraint>Use async SQLAlchemy session management (AsyncSession, get_async_session)</constraint>
    <constraint>FastAPI dependency injection pattern for request-scoped database sessions</constraint>
    <constraint>Celery tasks must explicitly set tenant context before any database queries</constraint>
    <constraint>All database operations go through SQLAlchemy ORM (no raw SQL without tenant context)</constraint>
    <constraint>Follow PEP8 and project code style (Black formatting, line-length 100)</constraint>
    <constraint>Type hints required for all functions (enforced by mypy strict mode)</constraint>
    <constraint>Test coverage >80% for security-critical RLS implementation</constraint>
    <constraint>Session variable app.current_tenant_id must be set before any tenant-scoped queries</constraint>
    <constraint>RLS policies must use PERMISSIVE type with FOR ALL operations</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>set_tenant_context(tenant_id: str)</name>
      <kind>PostgreSQL Function</kind>
      <signature>CREATE FUNCTION set_tenant_context(tenant_id VARCHAR) RETURNS VOID</signature>
      <path>alembic/versions/xxx_add_rls_policies.py (to be created)</path>
    </interface>
    <interface>
      <name>get_tenant_id(request: Request)</name>
      <kind>FastAPI Dependency</kind>
      <signature>async def get_tenant_id(request: Request) -> str</signature>
      <path>src/api/dependencies.py (to be created)</path>
    </interface>
    <interface>
      <name>get_tenant_db(tenant_id: str)</name>
      <kind>FastAPI Dependency</kind>
      <signature>async def get_tenant_db(tenant_id: str = Depends(get_tenant_id)) -> AsyncGenerator[AsyncSession, None]</signature>
      <path>src/api/dependencies.py (to be created)</path>
    </interface>
    <interface>
      <name>set_db_tenant_context(session: AsyncSession, tenant_id: str)</name>
      <kind>Utility Function</kind>
      <signature>async def set_db_tenant_context(session: AsyncSession, tenant_id: str) -> None</signature>
      <path>src/database/tenant_context.py (to be created)</path>
    </interface>
    <interface>
      <name>POST /webhook/servicedesk</name>
      <kind>REST endpoint</kind>
      <signature>async def receive_webhook(request: Request, db: AsyncSession = Depends(get_tenant_db))</signature>
      <path>src/api/webhooks.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Project uses pytest with pytest-asyncio for async database testing. Test structure: Unit tests (tests/unit/) for isolated components with mocked dependencies, Integration tests (tests/integration/) for end-to-end scenarios with real Docker services. Naming convention: test_&lt;component&gt;_&lt;scenario&gt;_&lt;expected_result&gt;. Coverage target >80% for security-critical RLS code. Test fixtures in tests/fixtures/ for reusable multi-tenant test data. Async test support via asyncio_mode=auto in pytest config.</standards>
    <locations>
      <location>tests/unit/test_row_level_security.py (to be created)</location>
      <location>tests/integration/test_rls_integration.py (to be created)</location>
      <location>tests/fixtures/ (add multi-tenant fixtures)</location>
      <location>tests/conftest.py (add RLS-specific fixtures)</location>
    </locations>
    <ideas>
      <test ac="1">Unit test: Verify RLS policies exist on all tenant tables (tenant_configs, enhancement_history, ticket_history, system_inventory)</test>
      <test ac="1">Unit test: Verify RLS policy expressions match architecture.md specification</test>
      <test ac="2">Unit test: Test set_tenant_context() validates tenant_id exists before setting</test>
      <test ac="2">Unit test: Test set_tenant_context() raises exception for invalid tenant_id</test>
      <test ac="3">Unit test: Test FastAPI dependency get_tenant_id() extracts tenant_id from webhook payload</test>
      <test ac="3">Unit test: Test get_tenant_db() calls set_db_tenant_context() before yielding session</test>
      <test ac="5">Unit test: RLS blocks cross-tenant SELECT - tenant_a cannot see tenant_b rows</test>
      <test ac="5">Unit test: RLS blocks cross-tenant INSERT - cannot insert with wrong tenant_id</test>
      <test ac="5">Unit test: RLS blocks cross-tenant UPDATE - cannot update other tenant rows</test>
      <test ac="5">Unit test: RLS blocks cross-tenant DELETE - cannot delete other tenant rows</test>
      <test ac="5">Unit test: Missing tenant context returns empty results (0 rows)</test>
      <test ac="5">Unit test: BYPASSRLS admin role can see all tenant data</test>
      <test ac="5">Performance test: RLS overhead &lt;5% on 10K records, 10 tenants</test>
      <test ac="6">Security test: SQL injection attempt via tenant_id parameter fails</test>
      <test ac="6">Security test: Raw SQL without tenant context blocked by RLS</test>
      <test ac="5">Integration test: Concurrent webhook requests from tenant_a and tenant_b see only own data</test>
      <test ac="5">Integration test: Celery task processes job with correct tenant isolation</test>
    </ideas>
  </tests>
</story-context>
