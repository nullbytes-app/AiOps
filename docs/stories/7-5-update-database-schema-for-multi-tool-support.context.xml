<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>5</storyId>
    <title>Update Database Schema for Multi-Tool Support</title>
    <status>drafted</status>
    <generatedAt>2025-11-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/7-5-update-database-schema-for-multi-tool-support.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a platform engineer</asA>
    <iWant>the database schema to support multiple ticketing tools per tenant</iWant>
    <soThat>tool-specific configurations are properly stored and retrieved</soThat>
    <tasks>
      ### Task 1: Validate Existing Schema Migrations (AC: #1)
      - 1.1 Review migration 3ad133f66494 (tool_type + index)
      - 1.2 Review migration 002217a1f0a8 (Jira fields)
      - 1.3 Query tenant_configs table schema
      - 1.4 Verify backward compatibility

      ### Task 2: Define Enhancement Preferences JSONB Schema (AC: #2)
      - 2.1 Design tool-specific preference structure
      - 2.2 Create JSON schema validation examples
      - 2.3 Update TenantService to handle tool-specific preferences

      ### Task 3: Update Pydantic Schemas for Multi-Tool Support (AC: #3)
      - 3.1 Review current TenantConfigInternal schema
      - 3.2 Add validation logic for tool-specific fields
      - 3.3 Create ToolSpecificConfig union type
      - 3.4 Update TenantConfigCreate and TenantConfigUpdate schemas

      ### Task 4: Implement Data Validation Logic (AC: #4)
      - 4.1 Create validation function: validate_tool_type_registered()
      - 4.2 Add database constraint helper (optional)
      - 4.3 Update TenantService.create_tenant()
      - 4.4 Update TenantService.update_tenant()

      ### Task 5: Test Migration Upgrade and Downgrade (AC: #5)
      - 5.1 Set up test database
      - 5.2 Test upgrade path
      - 5.3 Test downgrade path
      - 5.4 Test re-upgrade
      - 5.5 Document test results

      ### Task 6: Create Unit Tests for Schema Validation (AC: #6)
      - 6.1-6.12 Create 10+ unit tests covering tool_type validation, JSONB structure, multi-tool tenants

      ### Task 7: Create Integration Tests for Multi-Tool Workflow (AC: #7)
      - 7.1-7.5 Create integration tests for end-to-end multi-tool tenant workflows

      ### Task 8: Update Database Schema Documentation (AC: #8)
      - 8.1-8.8 Create comprehensive docs/database-schema.md with ER diagrams and examples

      ### Task 9: Code Quality and Standards (Meta)
      - 9.1-9.6 Black formatting, Ruff linting, mypy type checking

      ### Task 10: Final Validation and Cleanup
      - 10.1-10.7 Run full test suite and verify documentation completeness
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Schema validation documented: Existing migrations (3ad133f66494, 002217a1f0a8) validated with tool_type column, index, and tool-specific fields confirmed operational</criterion>
    <criterion id="AC2">Enhancement preferences schema defined: JSONB structure documented for tool-specific configs (jira_issue_type, zendesk_ticket_form, servicedesk_category) with examples</criterion>
    <criterion id="AC3">Pydantic schemas updated: TenantConfigInternal and related schemas handle all tool-specific fields (ServiceDesk Plus, Jira, future tools) with proper Optional[] typing</criterion>
    <criterion id="AC4">Data validation implemented: Application-level validation ensures tenant_configs.tool_type matches registered plugin (raises PluginNotFoundError for invalid tool types)</criterion>
    <criterion id="AC5">Migration testing completed: Upgrade and downgrade tested for both migrations (3ad133f66494, 002217a1f0a8), rollback verified clean</criterion>
    <criterion id="AC6">Unit tests created: Minimum 10 tests covering tool_type validation, enhancement_preferences JSONB structure, multi-tool tenant creation, invalid tool_type rejection</criterion>
    <criterion id="AC7">Integration tests added: Multi-tool tenant workflow test (create ServiceDesk Plus tenant, create Jira tenant, verify isolated configs)</criterion>
    <criterion id="AC8">Documentation updated: docs/database-schema.md reflects complete multi-tool schema with ER diagram, field descriptions, tool-specific examples</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 7: Plugin Architecture & Multi-Tool Support</title>
        <section>Story 7.5: Update Database Schema for Multi-Tool Support</section>
        <snippet>Acceptance Criteria: (1) Alembic migration created: add tool_type column to tenant_configs (VARCHAR(50), default 'servicedesk_plus'); (2) Index created on tool_type column for fast plugin lookup; (3) Tool-specific config fields added to enhancement_preferences JSONB: jira_project_key, jira_issue_type, zendesk_subdomain; (4) Migration tested: upgrade applies cleanly, downgrade rolls back correctly; (5) Existing tenant records updated with tool_type='servicedesk_plus'; (6) Data validation: tenant_configs.tool_type must match registered plugin; (7) Unit tests for new schema fields and constraints; (8) Documentation updated: docs/database-schema.md reflects multi-tool support</snippet>
      </doc>
      <doc>
        <path>docs/plugin-architecture.md</path>
        <title>Plugin Architecture Guide</title>
        <section>Architecture Pattern & Interface Specification</section>
        <snippet>The AI Agents Platform uses a plugin architecture to support multiple ticketing tools (ITSM systems) without modifying core enhancement logic. Plugin Manager routes requests based on tenant configuration (tool_type field). All plugins implement TicketingToolPlugin ABC with four abstract methods: validate_webhook(), get_ticket(), update_ticket(), extract_metadata(). Dynamic routing enables switching ticketing tools or supporting multiple tools per tenant without code changes.</snippet>
      </doc>
      <doc>
        <path>docs/stories/7-3-migrate-servicedesk-plus-to-plugin-architecture.md</path>
        <title>Story 7.3: Migrate ServiceDesk Plus to Plugin Architecture</title>
        <section>Migration Pattern & Backward Compatibility</section>
        <snippet>Established pattern for tool-specific columns: nullable columns enable backward compatibility. Existing ServiceDesk Plus tenants unaffected (tool-specific fields remain NULL). Migration 3ad133f66494 added tool_type column cleanly. Pattern: Add tool-specific columns as nullable, use tool_type for routing.</snippet>
      </doc>
      <doc>
        <path>docs/stories/7-4-implement-jira-service-management-plugin.md</path>
        <title>Story 7.4: Implement Jira Service Management Plugin</title>
        <section>Database Schema Evolution & JSONB Patterns</section>
        <snippet>Migration 002217a1f0a8 added 3 Jira columns (jira_url, jira_api_token_encrypted, jira_project_key) as nullable fields. Encryption requirements: All API tokens/keys must use BYTEA encrypted columns. Fernet encryption applied at application layer (TenantService). Never store plaintext credentials in database. Decryption happens on-demand when plugin needs credentials.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>alembic/versions/3ad133f66494_add_tool_type_to_tenant_configs.py</path>
        <kind>migration</kind>
        <symbol>upgrade, downgrade</symbol>
        <lines>21-56</lines>
        <reason>Migration that adds tool_type column (VARCHAR(50), default 'servicedesk_plus') and creates idx_tenant_configs_tool_type index. Required for AC1 validation.</reason>
      </artifact>
      <artifact>
        <path>alembic/versions/002217a1f0a8_add_jira_fields_to_tenant_configs.py</path>
        <kind>migration</kind>
        <symbol>upgrade, downgrade</symbol>
        <lines>21-56</lines>
        <reason>Migration that adds Jira-specific fields (jira_url, jira_api_token_encrypted, jira_project_key) as nullable columns. Required for AC1 validation.</reason>
      </artifact>
      <artifact>
        <path>src/schemas/tenant.py</path>
        <kind>schema</kind>
        <symbol>TenantConfigInternal</symbol>
        <lines>98-130</lines>
        <reason>Pydantic schema defining tenant configuration with Optional[] types for tool-specific fields (ServiceDesk Plus, Jira). Needs validation logic update for AC3.</reason>
      </artifact>
      <artifact>
        <path>src/plugins/registry.py</path>
        <kind>service</kind>
        <symbol>PluginManager.get_plugin</symbol>
        <lines>179-211</lines>
        <reason>Plugin Manager retrieval method that raises PluginNotFoundError if tool_type not registered. Required for AC4 validation integration.</reason>
      </artifact>
      <artifact>
        <path>src/plugins/base.py</path>
        <kind>interface</kind>
        <symbol>TicketingToolPlugin</symbol>
        <lines>1-50</lines>
        <reason>Abstract base class defining plugin interface. All plugins must implement this interface, establishing the contract for tool_type routing.</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_tenant_service.py</path>
        <kind>test</kind>
        <symbol>test_create_tenant, test_update_tenant</symbol>
        <lines>various</lines>
        <reason>Existing tenant service tests. Pattern to follow for AC6 unit tests covering tool_type validation and multi-tool scenarios.</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_plugin_registry.py</path>
        <kind>test</kind>
        <symbol>test_register_plugin, test_get_plugin</symbol>
        <lines>various</lines>
        <reason>Plugin Manager tests demonstrating PluginNotFoundError handling. Pattern for AC4 validation tests.</reason>
      </artifact>
      <artifact>
        <path>tests/integration/test_plugin_manager_integration.py</path>
        <kind>test</kind>
        <symbol>test_multi_plugin_workflow</symbol>
        <lines>various</lines>
        <reason>Integration test pattern for multi-plugin scenarios. Template for AC7 multi-tool tenant workflow tests.</reason>
      </artifact>
    </code>
    <dependencies>
      <python version="3.12">
        <package name="sqlalchemy" version=">=2.0.23">Core ORM and database migrations framework</package>
        <package name="alembic" version=">=1.12.1">Database migration tool for SQLAlchemy</package>
        <package name="asyncpg" version=">=0.29.0">Async PostgreSQL driver for SQLAlchemy async operations</package>
        <package name="psycopg2-binary" version=">=2.9.9">PostgreSQL adapter for Python (sync operations)</package>
        <package name="pydantic" version=">=2.5.0">Data validation using Python type annotations</package>
        <package name="cryptography" version=">=43.0.0">Fernet encryption for sensitive fields (API tokens/keys)</package>
        <package name="pytest" version=">=7.4.3">Testing framework</package>
        <package name="pytest-asyncio" version=">=0.21.1">Async test support</package>
        <package name="mypy" version=">=1.7.1">Static type checker for Python</package>
        <package name="black" version=">=23.11.0">Code formatter</package>
        <package name="ruff" version=">=0.1.6">Fast Python linter</package>
      </python>
      <postgresql version=">=14.0">
        <feature>JSONB native type for enhancement_preferences column</feature>
        <feature>BYTEA type for encrypted credentials (jira_api_token_encrypted, servicedesk_api_key_encrypted)</feature>
        <feature>B-tree indexes for tool_type column (fast plugin routing)</feature>
        <feature>GIN indexes (optional) for JSONB queries on enhancement_preferences</feature>
      </postgresql>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="C1">File size limit: No file over 500 lines (per CLAUDE.md)</constraint>
    <constraint id="C2">Type safety: All functions must have type hints, mypy strict mode must pass</constraint>
    <constraint id="C3">Docstrings: All functions require Google-style docstrings</constraint>
    <constraint id="C4">Code style: Black formatter (line-length=100), Ruff linter compliance required</constraint>
    <constraint id="C5">Backward compatibility: Existing ServiceDesk Plus tenants must not be affected by schema changes</constraint>
    <constraint id="C6">Encryption: All API tokens/keys stored in BYTEA encrypted columns, never plaintext</constraint>
    <constraint id="C7">Migration safety: All migrations must have clean upgrade/downgrade paths, tested before deployment</constraint>
    <constraint id="C8">Application-level validation: tool_type must match registered plugin (no DB-level CHECK constraints for dynamic plugins)</constraint>
    <constraint id="C9">Nullable tool-specific fields: Jira fields NULL for ServiceDesk Plus tenants, ServiceDesk fields NULL for Jira tenants</constraint>
    <constraint id="C10">Testing coverage: Minimum 10 unit tests (AC6), at least 3 integration tests (AC7), 80% coverage target for schemas</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PluginManager.get_plugin</name>
      <kind>function</kind>
      <signature>def get_plugin(self, tool_type: str) -> TicketingToolPlugin</signature>
      <path>src/plugins/registry.py:179-211</path>
      <purpose>Retrieve registered plugin by tool_type. Raises PluginNotFoundError if tool_type not registered. Required for AC4 validation integration.</purpose>
    </interface>
    <interface>
      <name>TenantConfigInternal (Pydantic Model)</name>
      <kind>schema</kind>
      <signature>class TenantConfigInternal(BaseModel)</signature>
      <path>src/schemas/tenant.py:98-130</path>
      <purpose>Internal tenant configuration schema with Optional[] types for tool-specific fields. Needs @model_validator for AC3 cross-field validation (e.g., if tool_type='jira', jira_url must be present).</purpose>
    </interface>
    <interface>
      <name>tenant_configs.tool_type (Database Column)</name>
      <kind>database_column</kind>
      <signature>tool_type VARCHAR(50) NOT NULL DEFAULT 'servicedesk_plus'</signature>
      <path>alembic/versions/3ad133f66494_add_tool_type_to_tenant_configs.py:30-38</path>
      <purpose>Plugin routing column. Index idx_tenant_configs_tool_type enables fast lookup. Default 'servicedesk_plus' ensures backward compatibility.</purpose>
    </interface>
    <interface>
      <name>tenant_configs.enhancement_preferences (Database Column)</name>
      <kind>database_column</kind>
      <signature>enhancement_preferences JSONB NOT NULL DEFAULT '{}'::jsonb</signature>
      <path>src/database/models.py (existing)</path>
      <purpose>PostgreSQL JSONB column storing tool-specific configs (jira_issue_type, zendesk_ticket_form, servicedesk_category). Flexible schema per tool_type. Required for AC2 JSONB structure definition.</purpose>
    </interface>
    <interface>
      <name>SQLAlchemy JSONB Type (from Context7 MCP)</name>
      <kind>library_reference</kind>
      <signature>from sqlalchemy.dialects.postgresql import JSONB</signature>
      <path>External: /sqlalchemy/sqlalchemy</path>
      <purpose>PostgreSQL JSONB type for multi-level indexed access. Example: json_col["key1"]["attr1"][5]. Supports GIN indexes for complex queries. Used for enhancement_preferences column.</purpose>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing follows pytest framework with async support (pytest-asyncio). All tests use Google-style docstrings. Type hints required (mypy validation). Test files mirror src/ structure in tests/unit/ and tests/integration/. Minimum coverage: 80% for schemas, 100% for validation functions. Migration testing requires separate test database to verify upgrade/downgrade idempotency. Use pytest fixtures from tests/unit/conftest.py for database session, mock plugin instances, and encrypted credential helpers.
    </standards>
    <locations>
      <location>tests/unit/test_tenant_schema_multi_tool.py (AC6 - new file for Story 7.5)</location>
      <location>tests/integration/test_multi_tool_tenant_workflow.py (AC7 - new file for Story 7.5)</location>
      <location>tests/unit/test_tenant_service.py (existing - may need updates for tool_type validation)</location>
      <location>tests/unit/test_plugin_registry.py (existing - pattern for PluginNotFoundError handling)</location>
      <location>tests/integration/test_plugin_manager_integration.py (existing - pattern for multi-plugin scenarios)</location>
      <location>docs/operations/migration-testing-report-7-5.md (AC5 - new documentation file)</location>
    </locations>
    <ideas>
      <idea criterion="AC1">Test: Verify migration 3ad133f66494 creates tool_type column and index (psql \d+ tenant_configs)</idea>
      <idea criterion="AC1">Test: Verify migration 002217a1f0a8 creates Jira columns (jira_url, jira_api_token_encrypted, jira_project_key)</idea>
      <idea criterion="AC2">Test: Insert tenant with enhancement_preferences containing Jira config, query and verify JSONB structure preserved</idea>
      <idea criterion="AC2">Test: Nested JSONB access: preferences->'tool_config'->>'default_issue_type' returns correct value</idea>
      <idea criterion="AC3">Test: TenantConfigInternal with tool_type='jira' but missing jira_url raises Pydantic ValidationError</idea>
      <idea criterion="AC3">Test: TenantConfigInternal with tool_type='servicedesk_plus' but missing servicedesk_url raises ValidationError</idea>
      <idea criterion="AC4">Test: Create tenant with tool_type='zendesk' (not registered) raises PluginNotFoundError</idea>
      <idea criterion="AC4">Test: TenantService.create_tenant() validates tool_type against PluginManager.get_plugin() before insertion</idea>
      <idea criterion="AC5">Test: Run 'alembic upgrade head', verify success, run 'alembic downgrade -2', verify rollback, run 'alembic upgrade head' again (idempotency)</idea>
      <idea criterion="AC6">Test: Create 1000 test tenants (500 ServiceDesk, 500 Jira), query WHERE tool_type='jira', verify EXPLAIN ANALYZE uses idx_tenant_configs_tool_type</idea>
      <idea criterion="AC6">Test: Default tool_type='servicedesk_plus' applied when creating tenant without specifying tool_type</idea>
      <idea criterion="AC7">Test: POST /api/tenants with ServiceDesk Plus config, verify tenant created, send mock webhook, verify routing to ServiceDesk Plus plugin</idea>
      <idea criterion="AC7">Test: POST /api/tenants with Jira config, verify Jira fields encrypted and stored, send mock Jira webhook, verify routing to Jira plugin</idea>
      <idea criterion="AC7">Test: Create both ServiceDesk Plus and Jira tenants, send concurrent webhooks, verify correct plugin routing and enhancement history isolation</idea>
      <idea criterion="AC8">Test: Verify docs/database-schema.md exists and contains ER diagram, tool_type column description, enhancement_preferences JSONB examples</idea>
    </ideas>
  </tests>
</story-context>
