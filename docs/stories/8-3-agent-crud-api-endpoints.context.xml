<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>3</storyId>
    <title>Agent CRUD API Endpoints</title>
    <status>drafted</status>
    <generatedAt>2025-11-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/8-3-agent-crud-api-endpoints.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>API endpoints to create, read, update, and delete agents</iWant>
    <soThat>the admin UI can manage agents programmatically</soThat>
    <tasks>### Task 1: Design API Architecture and Service Layer (AC: #1-#8)
- [ ] 1.1 Review existing FastAPI patterns in src/api/
  - [ ] 1.1a Study webhooks.py structure (router, dependencies, error handling)
  - [ ] 1.1b Study feedback.py structure (CRUD operations, response models)
  - [ ] 1.1c Study plugins_routes.py patterns (tenant filtering, pagination)
  - [ ] 1.1d Identify reusable patterns: tenant_id dependency injection, pagination helpers
- [ ] 1.2 Design agent service layer interface:
  - [ ] 1.2a create_agent(tenant_id, agent_data) → AgentResponse
  - [ ] 1.2b get_agents(tenant_id, filters, pagination) → list[AgentResponse]
  - [ ] 1.2c get_agent_by_id(tenant_id, agent_id) → AgentResponse | None
  - [ ] 1.2d update_agent(tenant_id, agent_id, updates) → AgentResponse
  - [ ] 1.2e delete_agent(tenant_id, agent_id) → bool (soft delete)
  - [ ] 1.2f activate_agent(tenant_id, agent_id) → AgentResponse
- [ ] 1.3 Design webhook URL generation:
  - [ ] 1.3a URL pattern: /agents/{agent_id}/webhook or /api/agents/{agent_id}/trigger
  - [ ] 1.3b HMAC secret: generate 32-byte random, base64-encode
  - [ ] 1.3c Store in agent_triggers table with trigger_type='webhook'
  - [ ] 1.3d Return webhook URL in POST /api/agents response
- [ ] 1.4 Design pagination and filtering:
  - [ ] 1.4a Pagination params: skip (offset), limit (page size, default 20, max 100)
  - [ ] 1.4b Filter params: status (AgentStatus enum), q (name search via ILIKE)
  - [ ] 1.4c Response format: {items: [...], total: N, skip: M, limit: L}
  - [ ] 1.4d Database query optimization: use indexes (idx_agents_tenant_id_status)

### Task 2: Create Agent Service Layer (AC: #1-#7)
- [ ] 2.1 Create src/services/agent_service.py (new file for agent business logic)
- [ ] 2.2 Import dependencies
- [ ] 2.3 Implement create_agent() method
- [ ] 2.4 Implement get_agents() method
- [ ] 2.5 Implement get_agent_by_id() method
- [ ] 2.6 Implement update_agent() method
- [ ] 2.7 Implement delete_agent() method (soft delete)
- [ ] 2.8 Implement activate_agent() method
- [ ] 2.9 Add Google-style docstrings to all service methods

### Task 3: Create FastAPI Router for Agent Endpoints (AC: #1-#8)
- [ ] 3.1 Create src/api/agents.py (new file for agent API routes)
- [ ] 3.2 Import FastAPI dependencies
- [ ] 3.3 Create APIRouter instance
- [ ] 3.4 Implement POST /api/agents endpoint (AC #1)
- [ ] 3.5 Implement GET /api/agents endpoint with pagination (AC #2)
- [ ] 3.6 Implement GET /api/agents/{agent_id} endpoint (AC #3)
- [ ] 3.7 Implement PUT /api/agents/{agent_id} endpoint (AC #4)
- [ ] 3.8 Implement DELETE /api/agents/{agent_id} endpoint (AC #5)
- [ ] 3.9 Implement POST /api/agents/{agent_id}/activate endpoint (AC #6)

### Task 4: Implement Tenant ID Dependency Injection (AC #7)
### Task 5: Register Agent Router in Main FastAPI App (AC #8)
### Task 6: Create Unit Tests for Service Layer (Testing)
### Task 7: Create Integration Tests for API Endpoints (Testing)
### Task 8: Implement OpenAPI Documentation Enhancements (AC #8)
### Task 9: Update Project Documentation
### Task 10: Quality Assurance and Validation</tasks>
  </story>

  <acceptanceCriteria>1. POST /api/agents endpoint created: creates agent with validation, returns agent_id and generated webhook URL
2. GET /api/agents endpoint created: returns paginated agent list with filters (tenant_id, status, search by name)
3. GET /api/agents/{agent_id} endpoint created: returns full agent details with assigned tools and triggers
4. PUT /api/agents/{agent_id} endpoint created: updates agent properties, validates changes
5. DELETE /api/agents/{agent_id} endpoint created: soft delete (sets status=inactive), preserves audit trail
6. POST /api/agents/{agent_id}/activate endpoint created: changes status draft→active, validates required fields
7. All endpoints enforce tenant_id filtering for multi-tenancy isolation
8. OpenAPI documentation generated for all endpoints</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="AI Agents - Decision Architecture" section="Technology Stack Details">
        - FastAPI 0.104+ with async web framework and automatic OpenAPI documentation
        - Pydantic 2.x for data validation and settings management
        - SQLAlchemy 2.0+ async ORM with psycopg3 driver
        - Redis 7.x + Celery 5.x for message queue and distributed task processing
        - PostgreSQL 17 with row-level security for multi-tenancy
        - Project structure defines src/api/ for FastAPI routes, src/services/ for business logic
      </doc>
      <doc path="docs/database-schema.md" title="Database Schema Documentation" section="Multi-tool Support">
        - tenant_configs table with tool_type column (servicedesk_plus, jira, zendesk)
        - Row-level security policy: tenant_config_isolation_policy enforcing tenant_id filtering
        - Indexes: idx_tenant_configs_tool_type for fast plugin routing
        - enhancement_preferences JSONB column for flexible per-tenant configuration
      </doc>
      <doc path="docs/epics.md" title="Epic 8: AI Agent Orchestration Platform" section="Story 8.3 Definition">
        - Goal: Create RESTful API endpoints for agent CRUD operations
        - Prerequisites: Story 8.2 (Agent Database Schema and Models) must be complete
        - 6 endpoints required: POST /api/agents, GET /api/agents, GET /api/agents/{id}, PUT /api/agents/{id}, DELETE /api/agents/{id}, POST /api/agents/{id}/activate
        - Tenant isolation enforced at API and service layers
        - OpenAPI documentation auto-generated from Pydantic schemas
        - Webhook URL generation: /agents/{agent_id}/webhook with HMAC secret
      </doc>
      <doc path="Context7: FastAPI /fastapi/fastapi" title="FastAPI Latest Best Practices (Trust Score 9.9)" section="Async Routes, Dependency Injection, Query Parameters">
        - Use async def for all route handlers with AsyncSession
        - Annotated[T, Depends(dependency)] for dependency injection (tenant_id, db session)
        - Query parameter validation with Query(ge=0, le=100, description="...")
        - response_model parameter for automatic OpenAPI schema generation
        - openapi_examples in Body() for request examples in Swagger UI
        - Path operation decorators: @router.get, @router.post, @router.put, @router.delete
      </doc>
      <doc path="Context7: Pydantic /pydantic/pydantic" title="Pydantic V2 Best Practices (Trust Score 9.6)" section="Model Configuration, Validation">
        - ConfigDict(from_attributes=True) replaces orm_mode for SQLAlchemy models
        - @field_validator for field-level validation with ValidationInfo
        - @model_validator(mode='after') for cross-field validation
        - model_dump(exclude_unset=True) for partial updates
        - validate_default=True to validate default values at model definition
        - Enum handling: class AgentStatus(str, Enum) for status field
      </doc>
    </docs>
    <code>
      <artifact path="src/api/webhooks.py" kind="route" symbol="router" reason="Reference for FastAPI router structure with async route handlers">
        - APIRouter with prefix and tags
        - Async route handlers with dependency injection
        - Error handling with HTTPException
      </artifact>
      <artifact path="src/api/feedback.py" kind="route" symbol="submit_feedback, get_feedback" reason="Reference for CRUD operation patterns in FastAPI routes">
        - POST endpoint for creating feedback records
        - GET endpoint with filtering and pagination
        - Response models for consistent API responses
      </artifact>
      <artifact path="src/api/plugins_routes.py" kind="route" symbol="list_plugins" reason="Reference for pagination and tenant filtering patterns">
        - Query parameter validation with skip/limit
        - Tenant_id filtering in database queries
        - Response format: {items: [...], total: N, skip: M, limit: L}
      </artifact>
      <artifact path="src/database/models.py" kind="model" symbol="/Agent" lines="543-641" reason="SQLAlchemy Agent model with relationships to AgentTrigger and AgentTool">
        - Agent model: id (UUID PK), tenant_id (FK), name, status (AgentStatus enum), system_prompt, llm_config (JSONB)
        - Relationships: triggers (one-to-many), tools (many-to-many via agent_tools)
        - Composite index: (tenant_id, status) for fast filtering
      </artifact>
      <artifact path="src/schemas/agent.py" kind="schema" symbol="/AgentCreate" lines="194-266" reason="Pydantic schema for creating agents with validation">
        - AgentCreate: name, description, system_prompt, llm_config, tool_ids
        - Field validators: status enum, llm_config structure
        - Used for POST /api/agents request body validation
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="fastapi" version="0.104+" ecosystem="python">Core async web framework</package>
        <package name="pydantic" version="2.x" ecosystem="python">Data validation and settings</package>
        <package name="sqlalchemy" version="2.0+" ecosystem="python">Async ORM with psycopg3 driver</package>
        <package name="uvicorn" version="latest" ecosystem="python">ASGI server for development</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="C1" source="CLAUDE.md">File size ≤500 lines - If files approach limit, refactor into modules</constraint>
    <constraint id="C2" source="Story Dev Notes">Service layer separation - Business logic in src/services/, NOT in routes</constraint>
    <constraint id="C3" source="Story Dev Notes">Tenant isolation enforced at BOTH API and service layers via tenant_id filtering</constraint>
    <constraint id="C4" source="Story Dev Notes">Soft delete pattern - DELETE sets status=INACTIVE, preserves audit trail (no CASCADE delete)</constraint>
    <constraint id="C5" source="Story Dev Notes">Activation validation - Only DRAFT→ACTIVE allowed, requires system_prompt, llm_config.model, and at least one trigger</constraint>
    <constraint id="C6" source="Story Dev Notes">Pagination - Default limit=20, max limit=100 to prevent large result sets</constraint>
    <constraint id="C7" source="CLAUDE.md">Google-style docstrings required for all functions with Args, Returns, Raises sections</constraint>
    <constraint id="C8" source="CLAUDE.md">Use PEP8 formatting with Black, type hints on all functions, pytest for testing</constraint>
    <constraint id="C9" source="Story Prerequisites">Story 8.2 (Agent Database Schema and Models) MUST be implemented first - migration applied, models/schemas exist</constraint>
    <constraint id="C10" source="Architecture">Async patterns required - Use async def for all route handlers with AsyncSession</constraint>
  </constraints>
  <interfaces>
    <interface name="AgentService" kind="service_class" path="src/services/agent_service.py">
      <method signature="async def create_agent(tenant_id: str, agent_data: AgentCreate, db: AsyncSession) -&gt; AgentResponse">
        Creates agent with webhook URL generation (f"{base_url}/agents/{agent_id}/webhook") and HMAC secret (secrets.token_urlsafe(32))
      </method>
      <method signature="async def get_agents(tenant_id: str, skip: int, limit: int, status: AgentStatus | None, q: str | None, db: AsyncSession) -&gt; dict">
        Returns paginated list with filters: {items: [AgentResponse], total: int, skip: int, limit: int}
      </method>
      <method signature="async def get_agent_by_id(tenant_id: str, agent_id: UUID, db: AsyncSession) -&gt; AgentResponse">
        Returns full agent details with triggers and tools, raises HTTPException(404) if not found
      </method>
      <method signature="async def update_agent(tenant_id: str, agent_id: UUID, agent_update: AgentUpdate, db: AsyncSession) -&gt; AgentResponse">
        Partial update using model_dump(exclude_unset=True), validates status transitions
      </method>
      <method signature="async def delete_agent(tenant_id: str, agent_id: UUID, db: AsyncSession) -&gt; bool">
        Soft delete sets status=INACTIVE, preserves audit trail
      </method>
      <method signature="async def activate_agent(tenant_id: str, agent_id: UUID, db: AsyncSession) -&gt; AgentResponse">
        Validates DRAFT status, required fields, and at least one trigger before activating
      </method>
    </interface>
    <interface name="FastAPI Router" kind="api_router" path="src/api/agents.py">
      <endpoint method="POST" path="/api/agents" response_model="AgentResponse" status="201">Create agent with validation</endpoint>
      <endpoint method="GET" path="/api/agents" response_model="dict" status="200">List agents with pagination (skip, limit, status, q)</endpoint>
      <endpoint method="GET" path="/api/agents/{agent_id}" response_model="AgentResponse" status="200">Get agent details by ID</endpoint>
      <endpoint method="PUT" path="/api/agents/{agent_id}" response_model="AgentResponse" status="200">Update agent properties</endpoint>
      <endpoint method="DELETE" path="/api/agents/{agent_id}" status="204">Soft delete agent</endpoint>
      <endpoint method="POST" path="/api/agents/{agent_id}/activate" response_model="AgentResponse" status="200">Activate agent (draft→active)</endpoint>
    </interface>
    <interface name="Dependencies" kind="dependency_functions" path="src/api/dependencies.py">
      <function signature="async def get_tenant_id(request: Request) -&gt; str">
        Extracts tenant_id from request body, X-Tenant-ID header, or auth token (raises HTTPException 400 if missing)
      </function>
      <function signature="async def get_async_session() -&gt; AsyncGenerator[AsyncSession, None]">
        Provides database session with auto-commit/rollback (from src.database.session)
      </function>
    </interface>
    <interface name="Database Models" kind="sqlalchemy_models" path="src/database/models.py">
      <model name="Agent" lines="543-641">
        Columns: id (UUID PK), tenant_id (FK), name, description, status (AgentStatus enum), system_prompt, llm_config (JSONB), created_at, updated_at, created_by
        Relationships: triggers (one-to-many), tools (many-to-many via agent_tools)
        Indexes: (tenant_id, status) composite B-tree
      </model>
      <model name="AgentTrigger" lines="644-728">
        Columns: id, agent_id (FK), trigger_type, webhook_url, hmac_secret, schedule_cron, payload_schema (JSONB), created_at, updated_at
      </model>
      <model name="AgentTool" lines="731-779">
        Junction table: agent_id (FK), tool_id (FK), created_at
      </model>
    </interface>
    <interface name="Pydantic Schemas" kind="pydantic_schemas" path="src/schemas/agent.py">
      <schema name="AgentCreate" lines="194-266">Request body for POST /api/agents</schema>
      <schema name="AgentUpdate" lines="269-326">Request body for PUT /api/agents/{id}</schema>
      <schema name="AgentResponse" lines="329-394">Response model for all endpoints with ConfigDict(from_attributes=True)</schema>
    </interface>
  </interfaces>
  <tests>
    <standards>
      - **Framework**: Pytest with pytest-asyncio for async test support
      - **Test Structure**: tests/unit/ for service layer, tests/integration/ for API endpoints
      - **Fixtures**: Mock AsyncSession for unit tests, real database with transactions for integration tests
      - **Coverage Target**: 100% coverage for service layer, all 6 endpoints tested
      - **Naming Convention**: test_{function_name}_{scenario} (e.g., test_create_agent_success, test_get_agent_not_found)
      - **Assertions**: Verify status codes (201, 200, 204, 404, 422), response models, tenant isolation, pagination logic
      - **Minimum**: 30+ tests total (15+ unit tests for service layer, 15+ integration tests for API endpoints)
    </standards>
    <locations>
      - tests/unit/test_agent_service.py (15+ tests for AgentService methods)
      - tests/integration/test_agent_api.py (15+ tests for FastAPI endpoints)
      - tests/conftest.py (shared fixtures for test database and mock objects)
    </locations>
    <ideas>
      <test id="AC1" criteria="POST /api/agents endpoint created">
        - test_create_agent_success() - Valid request returns 201, agent_id, webhook_url
        - test_create_agent_with_tools() - Verify tools assigned via junction table
        - test_create_agent_validation_error() - Invalid data returns 422
        - test_create_agent_tenant_id_required() - Missing tenant_id returns 401
      </test>
      <test id="AC2" criteria="GET /api/agents endpoint with pagination">
        - test_list_agents_pagination() - Verify skip/limit applied, total count correct
        - test_list_agents_filter_status() - Filter by status=ACTIVE returns only active
        - test_list_agents_search_name() - ILIKE search on name field works
        - test_list_agents_tenant_isolation() - Only tenant's agents returned
      </test>
      <test id="AC3" criteria="GET /api/agents/{agent_id} endpoint">
        - test_get_agent_by_id_success() - Returns full agent with triggers/tools
        - test_get_agent_by_id_not_found() - Invalid agent_id returns 404
        - test_get_agent_tenant_isolation() - Tenant A cannot access tenant B's agent
      </test>
      <test id="AC4" criteria="PUT /api/agents/{agent_id} endpoint">
        - test_update_agent_partial() - Update only name field, others unchanged
        - test_update_agent_status_transition() - Valid transitions allowed (draft→active)
        - test_update_agent_invalid_transition() - Invalid transitions blocked (active→draft)
      </test>
      <test id="AC5" criteria="DELETE /api/agents/{agent_id} endpoint">
        - test_delete_agent_soft_delete() - Status set to INACTIVE, record preserved
        - test_delete_agent_preserves_data() - Verify agent still in DB with INACTIVE status
      </test>
      <test id="AC6" criteria="POST /api/agents/{agent_id}/activate endpoint">
        - test_activate_agent_success() - DRAFT→ACTIVE transition with validation
        - test_activate_agent_missing_trigger() - Raises ValidationError if no triggers
        - test_activate_agent_already_active() - Raises HTTPException(400)
      </test>
      <test id="AC7" criteria="Tenant isolation enforced">
        - test_tenant_filtering_at_service_layer() - Service methods filter by tenant_id
        - test_cross_tenant_access_blocked() - Tenant A queries return empty for tenant B data
      </test>
      <test id="AC8" criteria="OpenAPI docs generated">
        - test_openapi_schema_generated() - GET /openapi.json returns valid OpenAPI 3.1 schema
        - test_swagger_ui_accessible() - GET /docs returns 200
      </test>
    </ideas>
  </tests>
</story-context>
