<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>Implement Webhook Signature Validation</title>
    <status>drafted</status>
    <generatedAt>2025-11-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-2-implement-webhook-signature-validation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a security engineer</asA>
    <iWant>webhook requests validated using HMAC signatures</iWant>
    <soThat>only authentic ServiceDesk Plus requests are processed</soThat>
    <tasks>
      <task id="1" ac="2,3">Create signature validation service with HMAC-SHA256 computation</task>
      <task id="2" ac="5">Add webhook secret to configuration (environment variable)</task>
      <task id="3" ac="1,4">Create FastAPI dependency for signature validation</task>
      <task id="4" ac="1">Apply validation dependency to webhook endpoint</task>
      <task id="5" ac="6">Create comprehensive unit tests for validation logic</task>
      <task id="6" ac="6">Update existing webhook endpoint tests with signature headers</task>
      <task id="7" ac="7">Document signature generation for ServiceDesk Plus</task>
      <task id="8" ac="4">Perform manual testing with curl</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Signature validation middleware added to webhook endpoint</criterion>
    <criterion id="2">HMAC-SHA256 signature computed from payload + shared secret</criterion>
    <criterion id="3">Signature compared with header value (X-ServiceDesk-Signature)</criterion>
    <criterion id="4">Invalid signatures rejected with 401 Unauthorized</criterion>
    <criterion id="5">Shared secret loaded from environment variable/Kubernetes secret</criterion>
    <criterion id="6">Validation logic unit tested with valid and invalid signatures</criterion>
    <criterion id="7">Documentation explains signature generation for ServiceDesk Plus configuration</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements - FR002</section>
        <snippet>FR002: System shall validate webhook signatures to ensure requests are authentic. Enforces HMAC-SHA256 validation on all webhook requests to prevent unauthorized access.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Non-Functional Requirements - NFR004</section>
        <snippet>NFR004: Security - System shall enforce data isolation between tenants, validate all webhook signatures, encrypt credentials at rest, and apply input validation to prevent injection attacks.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Security Architecture - Webhook Signature Validation</section>
        <snippet>Algorithm: HMAC-SHA256. Secret: Per-tenant signing secret stored encrypted. Header: X-ServiceDesk-Signature. Validation: Compute HMAC of request body + secret, compare with header value. Reject with 401 Unauthorized if signature mismatch.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Project Structure - Services</section>
        <snippet>services/webhook_validator.py - Signature validation service implementing HMAC-SHA256 comparison with constant-time comparison to prevent timing attacks.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 2: Core Enhancement Agent - Story 2.2</section>
        <snippet>Story 2.2: Implement Webhook Signature Validation. Security engineer needs webhook requests validated using HMAC signatures so only authentic ServiceDesk Plus requests are processed.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/api/webhooks.py</path>
        <kind>API endpoint</kind>
        <symbol>receive_webhook</symbol>
        <lines>18-88</lines>
        <reason>Existing webhook endpoint that needs signature validation dependency added. Currently accepts webhooks without authentication.</reason>
      </artifact>
      <artifact>
        <path>src/config.py</path>
        <kind>configuration</kind>
        <symbol>Settings</symbol>
        <lines>14-90</lines>
        <reason>Settings class needs webhook_secret field added to load signing secret from environment variable.</reason>
      </artifact>
      <artifact>
        <path>src/schemas/webhook.py</path>
        <kind>schema</kind>
        <symbol>WebhookPayload</symbol>
        <lines>14-80</lines>
        <reason>Pydantic model for webhook payload validation. Will be used after signature validation succeeds.</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_webhook_endpoint.py</path>
        <kind>test</kind>
        <symbol>TestWebhookEndpoint</symbol>
        <lines>-</lines>
        <reason>Existing endpoint tests that need to be updated with signature headers. Contains test fixtures and patterns to reuse.</reason>
      </artifact>
      <artifact>
        <path>tests/conftest.py</path>
        <kind>test configuration</kind>
        <symbol>pytest_configure, env_vars</symbol>
        <lines>-</lines>
        <reason>Test environment setup and fixtures. May need to add webhook_secret to test environment variables.</reason>
      </artifact>
      <artifact>
        <path>src/utils/logger.py</path>
        <kind>utility</kind>
        <symbol>-</symbol>
        <lines>-</lines>
        <reason>Loguru logger configuration for security event logging (failed signature validation attempts).</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="fastapi" version=">=0.104.0">Web framework with dependency injection</package>
        <package name="pydantic" version=">=2.5.0">Data validation and settings management</package>
        <package name="pydantic-settings" version=">=2.1.0">Environment variable loading</package>
        <package name="loguru" version=">=0.7.2">Structured logging</package>
        <package name="pytest" version=">=7.4.3">Testing framework</package>
        <package name="pytest-asyncio" version=">=0.21.1">Async test support</package>
        <package name="httpx" version=">=0.25.2">HTTP client for testing</package>
      </python>
      <stdlib>
        <module>hmac</module>
        <module>hashlib</module>
        <module>typing</module>
      </stdlib>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use FastAPI dependency injection pattern (Depends) for signature validation - runs before endpoint function</constraint>
    <constraint>HMAC computation must use constant-time comparison (hmac.compare_digest) to prevent timing attacks</constraint>
    <constraint>Validate raw request body bytes before Pydantic parsing to ensure signature integrity</constraint>
    <constraint>Signature validation failures return 401 Unauthorized (not 403) per architecture specification</constraint>
    <constraint>Secret loaded from environment variable AI_AGENTS_WEBHOOK_SECRET, never hardcoded or logged</constraint>
    <constraint>Follow existing patterns from Story 2.1: Google-style docstrings, type hints, structured logging with Loguru</constraint>
    <constraint>All new code must have 100% test coverage with unit tests and integration tests</constraint>
    <constraint>Tests must mirror src structure in tests/unit directory</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>validate_signature</name>
      <kind>function signature</kind>
      <signature>def validate_signature(raw_payload: bytes, signature_header: str, secret: str) -> bool</signature>
      <path>src/services/webhook_validator.py</path>
    </interface>
    <interface>
      <name>validate_webhook_signature</name>
      <kind>FastAPI dependency</kind>
      <signature>async def validate_webhook_signature(request: Request, signature: str = Header(None, alias="X-ServiceDesk-Signature"), settings: Settings = Depends(get_settings)) -> None</signature>
      <path>src/api/webhooks.py or src/services/webhook_validator.py</path>
    </interface>
    <interface>
      <name>POST /webhook/servicedesk</name>
      <kind>REST endpoint</kind>
      <signature>@router.post("/servicedesk", status_code=202) with Depends(validate_webhook_signature)</signature>
      <path>src/api/webhooks.py</path>
    </interface>
    <interface>
      <name>X-ServiceDesk-Signature</name>
      <kind>HTTP header</kind>
      <signature>HMAC-SHA256 hex digest computed from request body + shared secret</signature>
      <path>Webhook request header</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Use pytest with pytest-asyncio for async test support. All tests must follow naming convention test_*.py in tests/unit/ mirroring src/ structure. Use FastAPI TestClient for endpoint testing. Fixtures defined in tests/conftest.py. Google-style docstrings on all test functions. Target 100% code coverage for new modules. Type hints on all test functions.</standards>
    <locations>
      <location>tests/unit/test_webhook_validator.py</location>
      <location>tests/unit/test_webhook_endpoint.py</location>
      <location>tests/conftest.py</location>
    </locations>
    <ideas>
      <idea ac="2,3">Test validate_signature() with valid HMAC-SHA256 signature returns True</idea>
      <idea ac="2,3">Test validate_signature() with invalid signature returns False</idea>
      <idea ac="2,3">Test validate_signature() with modified payload fails validation</idea>
      <idea ac="2,3">Test validate_signature() with empty secret raises ValueError</idea>
      <idea ac="2,3">Test constant-time comparison using hmac.compare_digest</idea>
      <idea ac="1,4">Test FastAPI dependency with valid signature passes (no exception)</idea>
      <idea ac="4">Test FastAPI dependency with invalid signature raises HTTPException(401)</idea>
      <idea ac="4">Test FastAPI dependency with missing X-ServiceDesk-Signature header raises HTTPException(401)</idea>
      <idea ac="1">Test endpoint integration: valid signature + valid payload → 202 Accepted</idea>
      <idea ac="4">Test endpoint integration: invalid signature + valid payload → 401 Unauthorized</idea>
      <idea ac="4">Test endpoint integration: missing signature header → 401 Unauthorized</idea>
      <idea ac="1,4">Test validation order: invalid signature checked before Pydantic validation (401 not 422)</idea>
      <idea ac="5">Test config loads webhook_secret from AI_AGENTS_WEBHOOK_SECRET environment variable</idea>
      <idea ac="6">Test helper function to sign payloads for test fixtures</idea>
      <idea ac="6">Update all existing webhook endpoint tests to include valid signature headers</idea>
    </ideas>
  </tests>
</story-context>
