<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>8</storyId>
    <title>Create Security Testing and Penetration Test Suite</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-8-create-security-testing-and-penetration-test-suite.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a security engineer</asA>
    <iWant>automated security tests validating isolation and input handling</iWant>
    <soThat>security regressions are caught before production deployment</soThat>
    <tasks>
      <task id="1" ac="AC1">Implement OWASP Top 10 Security Test Suite - Create tests/security/test_owasp_vulnerabilities.py with tests for SQL injection, XSS, authentication bypass, authorization, sensitive data exposure, XXE, known vulnerabilities, logging/monitoring, and cryptography (14 subtasks)</task>
      <task id="2" ac="AC2">Implement Tenant Isolation Bypass Tests - Create tests/security/test_tenant_isolation.py with multi-tenant setup and cross-tenant query rejection tests (11 subtasks)</task>
      <task id="3" ac="AC3">Implement Input Validation and Sanitization Tests - Create tests/security/test_input_validation.py with SQL injection, XSS, command injection, path traversal, oversized input, Unicode, and boundary case tests (14 subtasks)</task>
      <task id="4" ac="AC4">Implement Webhook Signature Validation Tests - Create tests/security/test_webhook_signature_validation.py with missing signature, invalid signature, replay attack, and secret rotation tests (12 subtasks)</task>
      <task id="5" ac="AC5">Integrate Dependency Scanning into CI Pipeline - Install safety and pip-audit, create security-scan.yml workflow, configure blocking thresholds (12 subtasks)</task>
      <task id="6" ac="AC6">Create Security Test Results Documentation - Create docs/security/ with security-testing-strategy.md, owasp-mapping.md, and test results templates (10 subtasks)</task>
      <task id="7" ac="AC7">Configure Security Tests to Block Deployment - Update .github/workflows/ci.yml with security test step, branch protection rules, and failure notifications (10 subtasks)</task>
      <task id="8" ac="AC8">Document Quarterly Penetration Testing Procedure - Create docs/security/penetration-testing-procedure.md with scope, threat model, test plan, tools, and remediation SLAs (12 subtasks)</task>
      <task id="9" ac="ALL">Integration Testing and CI/CD Validation - Run full security test suite, verify coverage &gt;85%, test CI workflow blocking behavior (10 subtasks)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>Security Test Suite with OWASP Top 10 Coverage</title>
      <description>Security test file tests/security/test_owasp_vulnerabilities.py created with test scenarios for SQL Injection, XSS, Broken Authentication, Broken Access Control, Sensitive Data Exposure, XXE, Broken Authorization, Using Components with Known Vulnerabilities, Insufficient Logging &amp; Monitoring, and Broken Cryptography. Each vulnerability type has minimum 2 test cases (prevention + attack). All tests pass (0 vulnerabilities) on main branch. Tests fully documented with OWASP Top 10 references.</description>
    </criterion>
    <criterion id="AC2">
      <title>Tenant Isolation Bypass Tests</title>
      <description>Test file tests/security/test_tenant_isolation.py created with scenarios for cross-tenant query attempts, session context bypass, RLS policy circumvention, webhook signature with wrong tenant secret, and RLS policy existence verification. All tests validate tenant_id enforcement at database layer. Zero cross-tenant data leakage in any scenario.</description>
    </criterion>
    <criterion id="AC3">
      <title>Input Validation and Sanitization Tests</title>
      <description>Test file tests/security/test_input_validation.py created with scenarios for SQL injection, XSS, command injection, path traversal, oversized input (50k chars), Unicode/special characters, null bytes, and invalid UTF-8. Validation rules tested: Pydantic strict typing, string length limits, special character escaping, no executable patterns. Edge cases covered: empty strings, null values, boundary values, mixed payloads, Unicode-based attacks.</description>
    </criterion>
    <criterion id="AC4">
      <title>Webhook Signature Spoofing Tests</title>
      <description>Test file tests/security/test_webhook_signature_validation.py created with scenarios for missing signature header, invalid signature, signature mismatch (modified payload), replay attack prevention (timestamp validation), HMAC algorithm strength verification (SHA256), and secret rotation. Signature validation tested: per-tenant secrets isolated, constant-time comparison, exact payload matching.</description>
    </criterion>
    <criterion id="AC5">
      <title>Dependency Scanning for Known CVEs</title>
      <description>Dependency scanner integrated into .github/workflows/ci.yml with safety and pip-audit tools. Runs on every PR (blocking merge if vulnerabilities found) and main branch deployments. Generates vulnerability report with CVSS scores. Thresholds: CRITICAL/HIGH severity blocks deployment, MEDIUM warns, LOW informational. Baseline established and tracked. Quarterly CVE review process documented.</description>
    </criterion>
    <criterion id="AC6">
      <title>Security Test Results Documentation and Tracking</title>
      <description>Security test report docs/security/test-results-{{date}}.md generated with Executive Summary, OWASP Top 10 Status, Tenant Isolation Results, Input Validation Summary, Webhook Signature Results, Dependency Scan Results, Coverage Metrics, and Recommendations. Test results stored with git history. Documentation in docs/security/: security-testing-strategy.md, owasp-mapping.md, test coverage tracking.</description>
    </criterion>
    <criterion id="AC7">
      <title>Failed Security Tests Block Deployment</title>
      <description>GitHub Actions workflow .github/workflows/ci.yml configured with security test step running pytest tests/security/ in strict failure mode. Branch protection rule requires "Security Tests" status check on main and release branches. Deployment pipeline skips Kubernetes manifest deployment if security tests fail. Test failure notifications to Slack #security channel and PR comments with remediation steps.</description>
    </criterion>
    <criterion id="AC8">
      <title>Quarterly Penetration Testing Procedure Documented</title>
      <description>Procedure document docs/security/penetration-testing-procedure.md created with Scope Definition (components tested/excluded), Threat Model (insider, network, supply chain), Test Plan (manual authentication bypass, network segmentation, data exfiltration, privilege escalation), Tools &amp; Access (Burp Suite, sqlmap, nmap), Execution Steps, Remediation (bug report template, severity classification, SLAs: critical 7d, high 30d, medium 90d), Sign-off requirements, and Lessons Learned process. Quarterly schedule established with assigned owner.</description>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Functional Requirements - Security</section>
        <snippet>FR018: System shall isolate client data using row-level security in PostgreSQL. FR024: System shall log all enhancement operations with tenant ID, ticket ID, timestamp, and outcome. NFR004: Security - System shall enforce data isolation between tenants using row-level security, validate all webhook signatures, encrypt credentials at rest, and apply input validation to prevent injection attacks.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Security Architecture - Row-Level Security Implementation</section>
        <snippet>PostgreSQL Row-Level Security provides database-level multi-tenant isolation using native security policies. RLS policies filter rows based on session variable app.current_tenant_id. All tenant_id columns are indexed on RLS-enabled tables. Security considerations: Superusers bypass RLS, application role does NOT have BYPASSRLS attribute, SECURITY DEFINER prevents privilege escalation.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Security Architecture - Webhook Signature Validation</section>
        <snippet>Webhook signature validation enforces HMAC-SHA256 signatures per tenant using tenant-specific webhook secrets. Validates signature header (X-ServiceDesk-Signature), compares using constant-time comparison to prevent timing attacks. Signature validation failures raise WebhookValidationError with 401 status code.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Security Architecture - Input Validation</section>
        <snippet>Input validation uses Pydantic models with strict typing for all API inputs. Validates field types, lengths, formats. Prevents SQL injection via SQLAlchemy ORM (no raw SQL), XSS via output escaping, command injection via no shell execution of user input.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Definitions</title>
        <section>Epic 3: Multi-Tenancy &amp; Security - Story 3.8</section>
        <snippet>Story 3.8: Create Security Testing and Penetration Test Suite. Security test suite created with scenarios: SQL injection, XSS, tenant isolation bypass, signature spoofing. Dependency scanning integrated into CI pipeline. Security test results documented and tracked. Tests block deployment on failure.</snippet>
      </doc>
      <doc>
        <path>External: https://docs.pytest.org/en/stable/explanation/goodpractices.html</path>
        <title>pytest Good Integration Practices</title>
        <section>Test Discovery and Layout Conventions</section>
        <snippet>pytest supports tests outside application code (tests/ directory separate from src/). Test discovery: search for test_*.py files, collect test prefixed functions/methods. Recommends importlib import mode for new projects. Use src layout to prevent common pitfalls.</snippet>
      </doc>
      <doc>
        <path>External: https://pypi.org/project/pip-audit/</path>
        <title>pip-audit - Python Dependency Vulnerability Scanner</title>
        <section>Package Overview</section>
        <snippet>pip-audit is a tool for scanning Python environments for packages with known vulnerabilities. Uses Python Packaging Advisory Database. Detects CVEs in dependencies with CVSS scores and provides remediation guidance.</snippet>
      </doc>
      <doc>
        <path>External: https://pypi.org/project/safety/</path>
        <title>safety - Python Dependency Security Scanner</title>
        <section>Package Overview</section>
        <snippet>Safety CLI is a Python dependency vulnerability scanner designed to enhance software supply chain security by detecting packages with known vulnerabilities. Scans requirements.txt and provides severity ratings (CRITICAL, HIGH, MEDIUM, LOW).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/services/webhook_validator.py</path>
        <kind>service</kind>
        <symbol>validate_webhook_signature, compute_hmac_signature, secure_compare, validate_webhook_timestamp</symbol>
        <lines>complete file</lines>
        <reason>Primary webhook signature validation implementation to test for spoofing attacks, HMAC strength, constant-time comparison, and replay prevention</reason>
      </artifact>
      <artifact>
        <path>src/utils/logger.py</path>
        <kind>utility</kind>
        <symbol>AuditLogger, SensitiveDataFilter</symbol>
        <lines>complete file</lines>
        <reason>Audit logging infrastructure to verify security events are logged. SensitiveDataFilter patterns validate API key/password redaction in logs</reason>
      </artifact>
      <artifact>
        <path>src/database/models.py</path>
        <kind>model</kind>
        <symbol>TenantConfig, EnhancementHistory, TicketHistory, SystemInventory</symbol>
        <lines>complete file</lines>
        <reason>Database models with RLS policies. Tests will verify tenant_id enforcement and cross-tenant isolation at database layer</reason>
      </artifact>
      <artifact>
        <path>src/database/tenant_context.py</path>
        <kind>service</kind>
        <symbol>tenant context management functions</symbol>
        <lines>complete file</lines>
        <reason>Tenant context setting mechanism (app.current_tenant_id) to test RLS session variable enforcement</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_webhook_validator.py</path>
        <kind>test</kind>
        <symbol>TestValidateSignature, TestValidateWebhookSignature</symbol>
        <lines>complete file</lines>
        <reason>Existing webhook validation test patterns to follow for new security tests</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_input_validation.py</path>
        <kind>test</kind>
        <symbol>TestWebhookPayloadValidInput, TestWebhookPayloadInvalidTypes, TestWebhookPayloadOversizedInput</symbol>
        <lines>complete file</lines>
        <reason>Existing input validation test patterns showing Pydantic validation testing approach</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_row_level_security.py</path>
        <kind>test</kind>
        <symbol>TestRLSCrossTenantIsolation, TestRLSMissingContext, TestRLSAllTables</symbol>
        <lines>complete file</lines>
        <reason>Existing RLS test patterns to extend for comprehensive tenant isolation bypass testing</reason>
      </artifact>
      <artifact>
        <path>tests/integration/test_webhook_security.py</path>
        <kind>test</kind>
        <symbol>TestWebhookSignatureValidation, TestTenantIsolation, TestTimestampValidation</symbol>
        <lines>complete file</lines>
        <reason>Integration test patterns for webhook security showing real database and endpoint testing</reason>
      </artifact>
      <artifact>
        <path>.github/workflows/ci.yml</path>
        <kind>ci-config</kind>
        <symbol>lint-and-test job</symbol>
        <lines>1-50</lines>
        <reason>CI/CD pipeline structure to extend with security test step and dependency scanning</reason>
      </artifact>
      <artifact>
        <path>src/schemas/webhook.py</path>
        <kind>schema</kind>
        <symbol>Pydantic webhook schemas</symbol>
        <lines>complete file</lines>
        <reason>Pydantic validation models to test for type confusion, field validation, and strict typing enforcement</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="fastapi" version=">=0.104.0" usage="Web framework - test webhook endpoints for security vulnerabilities"/>
        <package name="pydantic" version=">=2.5.0" usage="Data validation - test strict typing and input validation enforcement"/>
        <package name="sqlalchemy" version=">=2.0.23" usage="ORM - test SQL injection prevention, RLS policy enforcement"/>
        <package name="asyncpg" version=">=0.29.0" usage="PostgreSQL driver - RLS integration testing"/>
        <package name="pytest" version=">=7.4.3" usage="Testing framework - existing framework for all security tests"/>
        <package name="pytest-asyncio" version=">=0.21.1" usage="Async test support - required for async security tests"/>
        <package name="httpx" version=">=0.25.2" usage="HTTP client - test webhook endpoints with attack payloads"/>
        <package name="loguru" version=">=0.7.2" usage="Logging - verify audit logging captures security events"/>
        <package name="bandit" version="latest" usage="Security scanner - already configured in pyproject.toml, verify integration"/>
        <package name="safety" version="latest" usage="NEEDS TO BE ADDED - dependency vulnerability scanner for requirements.txt"/>
        <package name="pip-audit" version="latest" usage="NEEDS TO BE ADDED - supply chain security scanner"/>
        <package name="black" version=">=23.11.0" usage="Code formatter - ensure security test files follow project standards"/>
        <package name="ruff" version=">=0.1.6" usage="Linter - code quality for security test files"/>
      </python>
      <database>
        <system name="PostgreSQL" version="17" usage="RLS policy testing requires real PostgreSQL instance with tenant isolation"/>
      </database>
      <frameworks>
        <framework name="GitHub Actions" usage="CI/CD pipeline - integrate security tests and dependency scanning"/>
        <framework name="Docker" usage="Test environment isolation - security tests run in containerized environment"/>
        <framework name="Kubernetes" usage="Network policy testing - validate namespace isolation (AC8 penetration testing)"/>
      </frameworks>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>All security tests must use pytest framework with existing project conventions (test_*.py naming, Test* class names)</constraint>
    <constraint>Tests must not use production data - use mocked services and test databases only</constraint>
    <constraint>RLS policy testing requires real PostgreSQL with test tenant isolation (not mocked)</constraint>
    <constraint>Security tests must run in CI pipeline and block merge on failure (strict exit code enforcement)</constraint>
    <constraint>Dependency scanning thresholds: CRITICAL/HIGH severity blocks deployment, MEDIUM warns, LOW informational</constraint>
    <constraint>All test files must follow PEP8 and Black formatting standards</constraint>
    <constraint>Security test coverage target: &gt;85% for security-related code paths</constraint>
    <constraint>Tests must validate both positive cases (authorized access works) and negative cases (unauthorized blocked)</constraint>
    <constraint>Documentation must be generated in docs/security/ directory with project-relative paths only</constraint>
    <constraint>Penetration testing SLAs: critical vulnerabilities fixed within 7 days, high within 30 days, medium within 90 days</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>validate_webhook_signature</name>
      <kind>function</kind>
      <signature>async def validate_webhook_signature(request: Request, tenant_id: str, db: AsyncSession) -&gt; bool</signature>
      <path>src/services/webhook_validator.py</path>
    </interface>
    <interface>
      <name>compute_hmac_signature</name>
      <kind>function</kind>
      <signature>def compute_hmac_signature(payload: str, secret: str) -&gt; str</signature>
      <path>src/services/webhook_validator.py</path>
    </interface>
    <interface>
      <name>secure_compare</name>
      <kind>function</kind>
      <signature>def secure_compare(a: str, b: str) -&gt; bool</signature>
      <path>src/services/webhook_validator.py</path>
    </interface>
    <interface>
      <name>AuditLogger.log_security_event</name>
      <kind>method</kind>
      <signature>def log_security_event(event_type: str, details: dict, severity: str = "WARNING")</signature>
      <path>src/utils/logger.py</path>
    </interface>
    <interface>
      <name>SensitiveDataFilter.filter</name>
      <kind>method</kind>
      <signature>def filter(record: dict) -&gt; dict</signature>
      <path>src/utils/logger.py</path>
    </interface>
    <interface>
      <name>set_tenant_context</name>
      <kind>function</kind>
      <signature>async def set_tenant_context(db: AsyncSession, tenant_id: str)</signature>
      <path>src/database/tenant_context.py</path>
    </interface>
    <interface>
      <name>POST /webhooks/enhancement</name>
      <kind>REST endpoint</kind>
      <signature>POST /webhooks/enhancement with header X-ServiceDesk-Signature, body WebhookPayload</signature>
      <path>src/api/webhooks.py</path>
    </interface>
    <interface>
      <name>WebhookPayload</name>
      <kind>Pydantic schema</kind>
      <signature>class WebhookPayload(BaseModel) with strict validation</signature>
      <path>src/schemas/webhook.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Project uses pytest framework with asyncio support for all testing. Test files follow naming convention test_*.py with Test* class names for test grouping. Security tests will be organized in tests/security/ directory mirroring the tests/unit/ and tests/integration/ structure. All tests use mocked services and test databases (no production data). RLS policy tests require real PostgreSQL with test tenant isolation. Test fixtures defined in conftest.py files. Code coverage target is &gt;85% for security-related code. Tests follow PEP8 and Black formatting (line-length 100). Existing patterns from tests/unit/test_webhook_validator.py, tests/unit/test_input_validation.py, and tests/unit/test_row_level_security.py should be followed for consistency.</standards>
    <locations>
      <location>tests/security/ - New directory for all security test files</location>
      <location>tests/security/conftest.py - Security-specific pytest fixtures</location>
      <location>tests/security/test_owasp_vulnerabilities.py - OWASP Top 10 test suite</location>
      <location>tests/security/test_tenant_isolation.py - RLS bypass prevention tests</location>
      <location>tests/security/test_input_validation.py - Input sanitization security tests</location>
      <location>tests/security/test_webhook_signature_validation.py - Signature spoofing tests</location>
      <location>.github/workflows/ci.yml - CI pipeline with security test step</location>
      <location>.github/workflows/security-scan.yml - Optional dedicated security scanning workflow</location>
      <location>docs/security/ - Security test documentation and reports</location>
    </locations>
    <ideas>
      <idea ac="AC1">Test SQL injection prevention: Send malicious SQL payloads in ticket description field, verify SQLAlchemy ORM prevents execution and data is safely stored</idea>
      <idea ac="AC1">Test XSS prevention: Send HTML/JavaScript payloads in ticket notes, verify escaping before posting to ServiceDesk API</idea>
      <idea ac="AC1">Test broken authentication: Send webhook without signature header or with invalid signature, verify 401 rejection</idea>
      <idea ac="AC1">Test sensitive data exposure: Verify SensitiveDataFilter redacts API keys, passwords from logs even when included in error messages</idea>
      <idea ac="AC1">Test XXE prevention: Send XML payloads with external entity references, verify parser rejects them</idea>
      <idea ac="AC1">Test insufficient logging: Verify audit logs capture all failed authentication attempts with full context (correlation_id, tenant_id, timestamp)</idea>
      <idea ac="AC2">Test cross-tenant query: Tenant A attempts to query with Tenant B's tenant_id, verify RLS policy returns 0 rows</idea>
      <idea ac="AC2">Test missing tenant context: Execute query without setting app.current_tenant_id, verify safe default (0 results)</idea>
      <idea ac="AC2">Test RLS policy existence: Query PostgreSQL system catalog to verify all tenant tables have RLS policies enabled</idea>
      <idea ac="AC2">Test webhook signature cross-tenant: Webhook signed with Tenant B secret sent to Tenant A endpoint, verify 401</idea>
      <idea ac="AC3">Test oversized input: Send 50,000 character description, verify max length enforcement (10,000 chars from validation rules)</idea>
      <idea ac="AC3">Test Unicode attacks: Send Unicode normalization attacks, RTL override characters, verify safe handling</idea>
      <idea ac="AC3">Test null byte injection: Payload with embedded null bytes, verify rejection or safe sanitization</idea>
      <idea ac="AC3">Test mixed attack payloads: Combine SQL injection + XSS in single field, verify both prevented</idea>
      <idea ac="AC4">Test replay attack: Send same valid webhook twice, verify timestamp validation rejects second attempt</idea>
      <idea ac="AC4">Test HMAC algorithm: Verify compute_hmac_signature uses SHA256 (not weaker MD5/SHA1)</idea>
      <idea ac="AC4">Test constant-time comparison: Verify secure_compare prevents timing attacks (uses hmac.compare_digest)</idea>
      <idea ac="AC4">Test secret rotation: Update tenant webhook secret, verify old signature fails, new signature works</idea>
      <idea ac="AC5">Test dependency scanning: Add known vulnerable package to requirements, verify safety/pip-audit detects and blocks CI</idea>
      <idea ac="AC5">Test severity thresholds: Mock vulnerabilities at different severities, verify CRITICAL/HIGH block, MEDIUM warns, LOW passes</idea>
      <idea ac="AC6">Generate test results report: After test run, verify report includes pass/fail status, OWASP coverage, metrics</idea>
      <idea ac="AC7">Test CI blocking behavior: Introduce deliberate test failure, verify GitHub Actions blocks PR merge</idea>
      <idea ac="AC7">Test security notifications: Mock test failure, verify Slack notification sent to #security channel</idea>
      <idea ac="AC8">Validate penetration test procedure: Review docs/security/penetration-testing-procedure.md for completeness (scope, tools, SLAs)</idea>
    </ideas>
  </tests>
</story-context>
