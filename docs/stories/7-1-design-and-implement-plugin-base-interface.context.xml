<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>1</storyId>
    <title>Design and Implement Plugin Base Interface</title>
    <status>drafted</status>
    <generatedAt>2025-11-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/7-1-design-and-implement-plugin-base-interface.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>platform engineer</asA>
    <iWant>a standardized plugin interface for ticketing tools</iWant>
    <soThat>new tools can be integrated without modifying core enhancement logic</soThat>
    <tasks>### Task 1: Create Plugin Package Structure (AC: #1)
- [ ] 1.1 Create `src/plugins/` directory if not exists
- [ ] 1.2 Create `src/plugins/__init__.py` with package exports
- [ ] 1.3 Create `src/plugins/base.py` file with module docstring
- [ ] 1.4 Add copyright header and module-level documentation

### Task 2: Define TicketMetadata Dataclass (AC: #4)
- [ ] 2.1 Import required types from dataclasses and datetime modules
- [ ] 2.2 Define `TicketMetadata` dataclass with type hints: tenant_id, ticket_id, description, priority, created_at
- [ ] 2.3 Add Google-style docstring explaining each field
- [ ] 2.4 Add `__post_init__` validation if needed (optional)
- [ ] 2.5 Export dataclass from `src/plugins/__init__.py`

### Task 3: Define TicketingToolPlugin Abstract Base Class (AC: #1, #2)
- [ ] 3.1 Import ABC and abstractmethod from abc module
- [ ] 3.2 Import typing utilities (Optional, Dict, Any)
- [ ] 3.3 Define `TicketingToolPlugin(ABC)` class
- [ ] 3.4 Add comprehensive class-level docstring
- [ ] 3.5 Add abstract method signatures

### Task 4: Implement validate_webhook() Abstract Method (AC: #2, #3)
- [ ] 4.1 Define method signature: `async def validate_webhook(self, payload: Dict[str, Any], signature: str) -> bool`
- [ ] 4.2 Add comprehensive Google-style docstring
- [ ] 4.3 Mark as @abstractmethod
- [ ] 4.4 Add type hints for all parameters and return value
- [ ] 4.5 Add note about tool-specific signature algorithms

### Task 5: Implement get_ticket() Abstract Method (AC: #2, #3)
- [ ] 5.1 Define method signature: `async def get_ticket(self, tenant_id: str, ticket_id: str) -> Optional[Dict[str, Any]]`
- [ ] 5.2 Add comprehensive Google-style docstring
- [ ] 5.3 Mark as @abstractmethod
- [ ] 5.4 Add type hints including Optional return type
- [ ] 5.5 Document expected return dict structure in docstring

### Task 6: Implement update_ticket() Abstract Method (AC: #2, #3)
- [ ] 6.1 Define method signature: `async def update_ticket(self, tenant_id: str, ticket_id: str, content: str) -> bool`
- [ ] 6.2 Add comprehensive Google-style docstring
- [ ] 6.3 Mark as @abstractmethod
- [ ] 6.4 Add type hints for all parameters and return value
- [ ] 6.5 Document retry expectations in docstring

### Task 7: Implement extract_metadata() Abstract Method (AC: #2, #3)
- [ ] 7.1 Define method signature: `def extract_metadata(self, payload: Dict[str, Any]) -> TicketMetadata`
- [ ] 7.2 Add comprehensive Google-style docstring
- [ ] 7.3 Mark as @abstractmethod
- [ ] 7.4 Add type hints using TicketMetadata return type
- [ ] 7.5 Document tool-specific payload field mapping expectations

### Task 8: Create Plugin Architecture Documentation (AC: #5)
- [ ] 8.1-8.7 Create comprehensive plugin-architecture.md with sections: Overview, Interface Spec, Implementation Guide, Examples, Type Hints, Testing

### Task 9: Create Unit Tests for Base Class (AC: #6)
- [ ] 9.1-9.10 Create test_plugin_base.py with 8 tests covering ABC instantiation, method signatures, TicketMetadata, mock plugin fixture

### Task 10: Validate Mypy Type Checking (AC: #7)
- [ ] 10.1-10.6 Run mypy validation with strict settings, fix issues, document in plugin-architecture.md

### Task 11: Update Package Exports (AC: #1)
- [ ] 11.1-11.4 Update src/plugins/__init__.py to export TicketingToolPlugin and TicketMetadata

### Task 12: Code Quality and Standards (Meta)
- [ ] 12.1-12.6 Run Black, Ruff, verify docstrings, check file sizes, security scan

### Task 13: Integration with Future Stories (Planning)
- [ ] 13.1-13.5 Review Story 7.2 and 7.3 requirements, ensure interface supports future needs</tasks>
  </story>

  <acceptanceCriteria>1. Abstract base class `TicketingToolPlugin` created at `src/plugins/base.py` with clear contract
2. Four abstract methods defined with complete type hints: `validate_webhook()`, `get_ticket()`, `update_ticket()`, `extract_metadata()`
3. Type hints and Google-style docstrings for all methods explaining purpose, parameters, returns, and raises
4. `TicketMetadata` dataclass defined with fields: tenant_id, ticket_id, description, priority, created_at
5. Plugin interface documented with usage examples in `docs/plugin-architecture.md`
6. Unit tests for base class structure and method signatures in `tests/unit/test_plugin_base.py`
7. Mypy validation passes with no errors (all types correctly defined)</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document - Plugin Architecture Requirements</title>
        <section>FR034-FR039: Plugin Architecture &amp; Multi-Tool Support</section>
        <snippet>System shall implement plugin architecture to support multiple ticketing tools beyond ServiceDesk Plus. Each ticketing tool plugin shall implement standardized interface (webhook validation, ticket retrieval, ticket update, metadata extraction). Plugin manager shall dynamically load and route requests to appropriate tool plugin based on tenant configuration.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Decision Record - Plugin Architecture Pattern</title>
        <section>ADR-010: Plugin Architecture for Multi-Tool Support</section>
        <snippet>Decision: Implement Abstract Base Class (ABC) plugin architecture for ticketing tool integrations. TicketingToolPlugin ABC defines 4 abstract methods: validate_webhook, get_ticket, update_ticket, extract_metadata. Registry pattern enables dynamic routing based on tenant_configs.tool_type. Rationale: Extensibility, separation of concerns, testability, vendor flexibility.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 7: Plugin Architecture &amp; Multi-Tool Support</title>
        <section>Epic 7 Overview and Story 7.1 Specification</section>
        <snippet>Epic Goal: Refactor to plugin-based architecture supporting multiple ticketing tools. Story 7.1: Design base interface with abstract base class TicketingToolPlugin at src/plugins/base.py. Four abstract methods with type hints and docstrings. TicketMetadata dataclass for standardized metadata. Plugin interface documented with usage examples. Prerequisites: Epic 6 complete (MVP v1.5 validated).</snippet>
      </doc>
      <doc>
        <path>.claude/CLAUDE.md</path>
        <title>Project Coding Standards and Conventions</title>
        <section>Code Structure, Testing, and Style Guidelines</section>
        <snippet>Max 500 lines per file. Always create Pytest unit tests (expected use, edge case, failure case). Follow PEP8, use type hints, format with black. Use pydantic for data validation. Write Google-style docstrings for every function. Tests mirror app structure in /tests folder.</snippet>
      </doc>
      <doc>
        <path>Web Research 2025</path>
        <title>Python ABC Plugin Architecture Best Practices 2025</title>
        <section>Modern Plugin Patterns and Type Safety</section>
        <snippet>ABCs remain primary pattern for plugin systems in production environments. Full mypy support for compile-time type checking of abstract methods. Integration with Pydantic for data validation. Type hints are standard practice in 2025. Plugin systems used extensively in model training platforms, data loaders, and extensible frameworks.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/services/webhook_validator.py</path>
        <kind>service</kind>
        <symbol>validate_webhook_signature</symbol>
        <lines>144-end</lines>
        <reason>Existing webhook signature validation pattern that will inform the plugin's validate_webhook() abstract method. Shows HMAC-SHA256 validation, secure comparison, tenant_id extraction - all patterns to be abstracted into plugin interface.</reason>
      </artifact>
      <artifact>
        <path>src/services/servicedesk_client.py</path>
        <kind>service</kind>
        <symbol>update_ticket_with_enhancement</symbol>
        <lines>198-end</lines>
        <reason>Existing ticket update implementation with retry logic, error handling, markdown-to-HTML conversion. This logic will move into ServiceDesk Plus plugin (Story 7.3) implementing the update_ticket() abstract method.</reason>
      </artifact>
      <artifact>
        <path>src/database/models.py</path>
        <kind>model</kind>
        <symbol>TenantConfig</symbol>
        <lines>30-119</lines>
        <reason>Database model defining tenant configuration structure. Plugin methods will receive tenant_id and look up tool-specific config (servicedesk_url, api_key, webhook_secret). Story 7.5 adds tool_type column for plugin routing.</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_webhook_validator.py</path>
        <kind>test</kind>
        <symbol>TestValidateWebhookSignature</symbol>
        <lines>all</lines>
        <reason>Existing test patterns for webhook validation showing fixture usage (sample_payload, valid_signature, mock_request), pytest class organization, and assertion patterns. Use as template for test_plugin_base.py structure.</reason>
      </artifact>
      <artifact>
        <path>tests/conftest.py</path>
        <kind>test-fixture</kind>
        <symbol>env_vars, setup_test_env</symbol>
        <lines>all</lines>
        <reason>Shared test fixtures and environment setup patterns. MockTicketingToolPlugin fixture should follow same patterns established here.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <version>3.12</version>
        <standard-library>
          <module>abc</module>
          <module>typing</module>
          <module>dataclasses</module>
          <module>datetime</module>
        </standard-library>
      </python>
      <production>
        <package name="pydantic" version=">=2.5.0" usage="Data validation (mentioned in CLAUDE.md, may be used for TicketMetadata validation)"/>
        <package name="fastapi" version=">=0.104.0" usage="Web framework (context: webhook endpoints use plugins for validation)"/>
      </production>
      <development>
        <package name="pytest" version=">=7.4.3" usage="Unit testing framework - required for test_plugin_base.py"/>
        <package name="pytest-asyncio" version=">=0.21.1" usage="Testing async methods (validate_webhook, get_ticket, update_ticket are async)"/>
        <package name="pytest-mock" version=">=3.12.0" usage="Mocking support for MockTicketingToolPlugin fixture"/>
        <package name="mypy" version=">=1.7.1" usage="Static type checking - AC7 requires mypy validation passes with no errors"/>
        <package name="black" version=">=23.11.0" usage="Code formatting - Task 12.1 requires Black formatting"/>
        <package name="ruff" version=">=0.1.6" usage="Linting - Task 12.2 requires Ruff linting"/>
      </development>
      <notes>
        All dependencies already installed in pyproject.toml. No new dependencies required for Story 7.1. Plugin base interface uses only Python standard library (abc, typing, dataclasses, datetime). Testing and type checking tools already configured in [tool.mypy] and [tool.pytest.ini_options] sections.
      </notes>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="C1">MUST use Abstract Base Class (ABC) pattern per ADR-010. All 4 methods must be marked @abstractmethod.</constraint>
    <constraint id="C2">File size limit: src/plugins/base.py MUST be under 500 lines (per CLAUDE.md). Estimated ~180 lines well within limit.</constraint>
    <constraint id="C3">MUST use Google-style docstrings for all methods per CLAUDE.md coding standards.</constraint>
    <constraint id="C4">MUST include complete type hints on all method signatures. Enable mypy strict mode for plugins module.</constraint>
    <constraint id="C5">Pure interface definition only - NO concrete implementations in base.py. ServiceDesk Plus implementation deferred to Story 7.3.</constraint>
    <constraint id="C6">TicketMetadata dataclass MUST match fields expected by enhancement workflow: tenant_id, ticket_id, description, priority, created_at (datetime).</constraint>
    <constraint id="C7">Plugin methods MUST be async where appropriate: validate_webhook, get_ticket, update_ticket are async; extract_metadata is sync.</constraint>
    <constraint id="C8">Interface design MUST support existing ServiceDesk Plus functionality without breaking changes. API compatibility maintained in migration (Story 7.3).</constraint>
    <constraint id="C9">Testing requirement: Minimum 3 tests per acceptance criterion (expected use, edge case, failure case) per CLAUDE.md.</constraint>
    <constraint id="C10">Documentation requirement: plugin-architecture.md MUST include usage examples, implementation guide, and type safety guidance (estimated 700+ lines following Epic 6 quality standards).</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>TicketingToolPlugin.validate_webhook()</name>
      <kind>abstract method</kind>
      <signature>async def validate_webhook(self, payload: Dict[str, Any], signature: str) -> bool</signature>
      <path>src/plugins/base.py (to be created)</path>
      <description>Validates webhook request authenticity using tool-specific signature algorithm. Returns True if valid, False otherwise. Raises ValidationError if payload malformed.</description>
    </interface>
    <interface>
      <name>TicketingToolPlugin.get_ticket()</name>
      <kind>abstract method</kind>
      <signature>async def get_ticket(self, tenant_id: str, ticket_id: str) -> Optional[Dict[str, Any]]</signature>
      <path>src/plugins/base.py (to be created)</path>
      <description>Retrieves ticket details from ticketing tool API. Returns Dict with ticket data or None if not found. Raises APIError if API call fails.</description>
    </interface>
    <interface>
      <name>TicketingToolPlugin.update_ticket()</name>
      <kind>abstract method</kind>
      <signature>async def update_ticket(self, tenant_id: str, ticket_id: str, content: str) -> bool</signature>
      <path>src/plugins/base.py (to be created)</path>
      <description>Updates ticket with enhancement content. Returns True if successful, False otherwise. Implements retry logic (3 attempts, exponential backoff). Raises APIError or AuthenticationError on failure.</description>
    </interface>
    <interface>
      <name>TicketingToolPlugin.extract_metadata()</name>
      <kind>abstract method</kind>
      <signature>def extract_metadata(self, payload: Dict[str, Any]) -> TicketMetadata</signature>
      <path>src/plugins/base.py (to be created)</path>
      <description>Extracts standardized metadata from webhook payload. Returns TicketMetadata dataclass. Raises ValidationError if required fields missing. Sync method (no I/O).</description>
    </interface>
    <interface>
      <name>TicketMetadata</name>
      <kind>dataclass</kind>
      <signature>@dataclass class TicketMetadata: tenant_id, ticket_id, description, priority, created_at</signature>
      <path>src/plugins/base.py (to be created)</path>
      <description>Standardized ticket metadata structure used by enhancement workflow. All fields required (no Optional). created_at is datetime (UTC).</description>
    </interface>
    <interface>
      <name>TenantConfig database model</name>
      <kind>SQLAlchemy model</kind>
      <signature>class TenantConfig(Base): tenant_id, servicedesk_url, api_key_encrypted, webhook_secret_encrypted, enhancement_preferences (JSONB)</signature>
      <path>src/database/models.py</path>
      <description>Existing database model for tenant configuration. Plugins retrieve tenant-specific config using tenant_id. Story 7.5 adds tool_type column for plugin routing.</description>
    </interface>
  </interfaces>
  <tests>
    <standards>
Testing Standards for Story 7.1:

**Framework:** pytest>=7.4.3 with pytest-asyncio for async method testing

**Coverage Requirements (per CLAUDE.md):**
- Minimum 3 tests per feature: expected use, edge case, failure case
- Target >80% code coverage for base.py module
- All abstract methods must have signature validation tests

**Test Organization (per pyproject.toml):**
- Test files named: test_*.py
- Test classes named: Test*
- Test functions named: test_*
- Async tests automatically handled (asyncio_mode = "auto")

**Fixture Patterns (from tests/conftest.py):**
- Use @pytest.fixture decorator for reusable test data
- MockTicketingToolPlugin fixture for future integration tests
- Follow existing patterns: sample_payload, valid_signature patterns

**Assertion Patterns (from test_webhook_validator.py):**
- Use pytest.raises() for exception testing
- Test class organization: TestClassName grouping related tests
- Clear test names describing behavior: test_what_when_condition

**Type Checking Tests:**
- Use inspect module to validate method signatures
- Use typing.get_type_hints() to verify type annotations
- Verify @abstractmethod decorator presence

**Documentation Quality:**
- Every test should have a docstring explaining what it validates
- Reference AC numbers in test docstrings (e.g., "Validates AC1: Abstract base class creation")
    </standards>
    <locations>
tests/unit/test_plugin_base.py - New file for Story 7.1 unit tests (Task 9)
tests/conftest.py - Add MockTicketingToolPlugin fixture (Task 9.8)
src/plugins/__init__.py - Package exports to test (Task 11)
src/plugins/base.py - Module under test (estimated ~180 lines)
    </locations>
    <ideas>
**AC1 Tests (Abstract base class TicketingToolPlugin created):**
- test_ticketing_tool_plugin_is_abstract: Verify cannot instantiate TicketingToolPlugin directly, expect TypeError "Can't instantiate abstract class"
- test_ticketing_tool_plugin_has_four_methods: Verify class defines exactly 4 abstract methods using inspect.getmembers()
- test_abstract_methods_properly_decorated: Verify all 4 methods have @abstractmethod decorator using inspect signature

**AC2 Tests (Four abstract methods defined with type hints):**
- test_validate_webhook_signature: Verify method signature matches: async def validate_webhook(self, payload: Dict[str, Any], signature: str) -> bool
- test_get_ticket_signature: Verify method signature matches: async def get_ticket(self, tenant_id: str, ticket_id: str) -> Optional[Dict[str, Any]]
- test_update_ticket_signature: Verify method signature matches: async def update_ticket(self, tenant_id: str, ticket_id: str, content: str) -> bool
- test_extract_metadata_signature: Verify method signature matches: def extract_metadata(self, payload: Dict[str, Any]) -> TicketMetadata (note: sync method)

**AC3 Tests (Type hints and Google-style docstrings):**
- test_all_methods_have_type_hints: Use get_type_hints() to verify complete type annotations on all 4 methods
- test_all_methods_have_docstrings: Verify __doc__ attribute present and non-empty for all methods
- test_docstrings_contain_required_sections: Verify docstrings contain "Args:", "Returns:", "Raises:" sections (Google style)

**AC4 Tests (TicketMetadata dataclass defined):**
- test_ticket_metadata_dataclass_creation: Create TicketMetadata instance with all required fields (tenant_id, ticket_id, description, priority, created_at datetime)
- test_ticket_metadata_field_types: Verify type hints correct using get_type_hints(): tenant_id:str, ticket_id:str, description:str, priority:str, created_at:datetime
- test_ticket_metadata_equality: Test dataclass equality behavior (two instances with same data should be equal)
- test_ticket_metadata_repr: Test dataclass repr output for debugging support

**AC5 Tests (Plugin interface documented - covered in documentation validation):**
- Note: Documentation validation done in validation step, not unit tests

**AC6 Tests (Unit tests for base class structure):**
- test_incomplete_plugin_raises_typeerror: Create subclass missing one method (e.g., no update_ticket), verify TypeError when instantiating
- test_async_methods_properly_marked: Verify validate_webhook, get_ticket, update_ticket are coroutine functions using inspect.iscoroutinefunction()
- test_extract_metadata_is_sync: Verify extract_metadata is NOT async (regular function)

**AC7 Tests (Mypy validation passes):**
- Note: Mypy validation is command-line test in Task 10, not pytest test
- Command: mypy src/plugins/base.py --strict
- Expected: Exit code 0, no type errors

**MockTicketingToolPlugin Fixture (Task 9.8 for future use):**
- Create concrete implementation of all 4 methods with simple return values
- validate_webhook: returns True (configurable)
- get_ticket: returns {"id": "TEST-123", "description": "Mock ticket"}
- update_ticket: returns True (configurable)
- extract_metadata: returns TicketMetadata with mock data
- Usage: Integration tests in Story 7.6 will use this fixture

**Edge Cases:**
- test_ticketing_tool_plugin_with_extra_methods: Verify subclass can add additional methods beyond the 4 required
- test_ticket_metadata_with_timezone_aware_datetime: Verify created_at handles timezone-aware datetime objects (UTC)

**Failure Cases:**
- test_cannot_register_incomplete_plugin: Attempt to instantiate plugin missing required methods
- test_ticket_metadata_missing_required_field: Omit required field, verify dataclass error
    </ideas>
  </tests>
</story-context>
