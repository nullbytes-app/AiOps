<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.3</storyId>
    <title>Implement Secrets Management with Kubernetes Secrets</title>
    <status>drafted</status>
    <generatedAt>2025-11-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3-3-implement-secrets-management-with-kubernetes-secrets.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a security engineer</asA>
    <iWant>sensitive credentials encrypted at rest and injected at runtime</iWant>
    <soThat>API keys and passwords are never stored in plain text</soThat>
    <tasks>
      <task id="1" title="Create Kubernetes Secret Manifest Template">
        <subtasks>
          <subtask id="1.1">Create k8s/secrets.yaml.example template with all secret fields</subtask>
          <subtask id="1.2">Create K8s Secret resource from template</subtask>
          <subtask id="1.3">Create documentation for secret generation</subtask>
        </subtasks>
      </task>
      <task id="2" title="Update Pod Specifications to Mount Secrets">
        <subtasks>
          <subtask id="2.1">Update FastAPI deployment (k8s/deployment-api.yaml)</subtask>
          <subtask id="2.2">Update Celery worker deployment (k8s/deployment-worker.yaml)</subtask>
          <subtask id="2.3">Verify secrets mounted correctly</subtask>
        </subtasks>
      </task>
      <task id="3" title="Update Application Configuration to Read Secrets">
        <subtasks>
          <subtask id="3.1">Update src/config.py to load secrets from environment</subtask>
          <subtask id="3.2">Update src/main.py startup to validate secrets</subtask>
          <subtask id="3.3">Update src/workers/celery_app.py to load secrets</subtask>
          <subtask id="3.4">Write unit test for secret loading</subtask>
        </subtasks>
      </task>
      <task id="4" title="Create Secret Rotation Procedure">
        <subtasks>
          <subtask id="4.1">Create docs/runbooks/secret-rotation.md</subtask>
          <subtask id="4.2">Document specific procedures for each secret type</subtask>
          <subtask id="4.3">Add secret rotation schedule documentation</subtask>
        </subtasks>
      </task>
      <task id="5" title="Verify Git Configuration">
        <subtasks>
          <subtask id="5.1">Check .gitignore for secret files</subtask>
          <subtask id="5.2">Verify no secrets in git history</subtask>
          <subtask id="5.3">Create pre-commit hook to prevent accidental secret commits (optional)</subtask>
        </subtasks>
      </task>
      <task id="6" title="Implement Environment Detection Logic">
        <subtasks>
          <subtask id="6.1">Create .env.example for local development</subtask>
          <subtask id="6.2">Implement environment detection in src/config.py</subtask>
          <subtask id="6.3">Update startup logging to show detection</subtask>
        </subtasks>
      </task>
      <task id="7" title="Create Secrets Validator">
        <subtasks>
          <subtask id="7.1">Implement validator function in src/utils/secrets.py</subtask>
          <subtask id="7.2">Call validator from FastAPI startup</subtask>
          <subtask id="7.3">Write unit tests for validator</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" title="Kubernetes Secret Manifests Created">
      <description>Kubernetes Secret YAML templates created for database credentials, Redis password, OpenAI API key, and encryption key. Secret manifest template at k8s/secrets.yaml.example with documented fields.</description>
      <validation>Secret resource deployed with kubectl apply, example documented with placeholders</validation>
    </criterion>
    <criterion id="AC2" title="Secrets Mounted as Environment Variables or Volume Files">
      <description>Pod specifications updated to mount secrets as environment variables in FastAPI deployment (k8s/deployment-api.yaml) and Celery worker deployment (k8s/deployment-worker.yaml)</description>
      <validation>Secrets mounted as read-only volumes, verified with kubectl exec</validation>
    </criterion>
    <criterion id="AC3" title="Application Reads Secrets at Startup">
      <description>Application startup reads secrets from environment variables (POSTGRES_PASSWORD, REDIS_PASSWORD, OPENAI_API_KEY, ENCRYPTION_KEY)</description>
      <validation>Application logs "Secrets loaded successfully" without exposing values. Graceful error if missing with clear message and non-zero exit. Configuration in src/config.py loads from environment only.</validation>
    </criterion>
    <criterion id="AC4" title="Secret Rotation Procedure Documented">
      <description>Runbook at docs/runbooks/secret-rotation.md with step-by-step procedure including generating new secrets, updating K8s Secret, rolling pod restarts, verification, and rollback</description>
      <validation>Estimated time and impact assessment included</validation>
    </criterion>
    <criterion id="AC5" title="No Secrets Committed to Git Repository">
      <description>.gitignore includes .env, .env.local, .env.*.local, k8s/secrets.yaml. git check-ignore confirms all secret files ignored.</description>
      <validation>Pre-commit hook verification that secrets not staged. Documentation states production secrets never checked in.</validation>
    </criterion>
    <criterion id="AC6" title="Local Development Uses .env File (Git-Ignored), Production Uses K8s Secrets">
      <description>.env.example template with placeholders and instructions. .env file loaded at development startup via python-dotenv or Pydantic Settings. Application detects deployment environment.</description>
      <validation>Configuration logic: if is_kubernetes_env() then load_from_env_vars() else load_from_dotenv()</validation>
    </criterion>
    <criterion id="AC7" title="Secrets Validator Ensures Required Values Present at Startup">
      <description>Validator function async def validate_secrets_at_startup() validates all required secrets present with format/length requirements</description>
      <validation>Passwords >= 12 chars, API keys non-empty, encryption key valid Fernet key. Graceful failure with clear error message. Unit tests verify validator catches missing/invalid secrets.</validation>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>AI Agents - Decision Architecture</title>
        <section>Secrets Management Decision</section>
        <snippet>Decision: Kubernetes Secrets (Native) for Epic 3. Rationale: Native K8s integration, simpler than Vault for initial deployment, encryption at rest. Source: Infisical K8s Guide 2025</snippet>
      </doc>
      <doc>
        <path>docs/deployment.md</path>
        <title>Kubernetes Deployment Guide</title>
        <section>Secret Management</section>
        <snippet>Prerequisites include kubectl v1.28+, Docker, and local K8s cluster (Minikube/Kind). Guide covers deployment steps, secret management, scaling, and monitoring.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 3: Multi-Tenancy & Security</section>
        <snippet>Epic 3 Goal: Implement tenant isolation, security controls, and configuration management for production readiness. Includes row-level security, tenant configuration system, webhook signature validation, secrets management, input validation. Status: Planned (MVP v1.0)</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Security Requirements</section>
        <snippet>PRD mandates FastAPI for web framework, PostgreSQL for database with row-level security for multi-tenancy, and comprehensive security controls.</snippet>
      </doc>
      <doc>
        <path>External: Kubernetes Official Docs</path>
        <title>Good practices for Kubernetes Secrets</title>
        <section>Security Best Practices</section>
        <snippet>Configure encryption at rest in etcd. Use least-privilege RBAC access. Restrict access to specific containers. Avoid sharing Secret manifests. Base64 encoding is NOT encryption. Short-lived secrets recommended.</snippet>
        <url>https://kubernetes.io/docs/concepts/security/secrets-good-practices/</url>
      </doc>
      <doc>
        <path>External: FastAPI Official Docs</path>
        <title>Settings and Environment Variables</title>
        <section>Pydantic Settings Management</section>
        <snippet>Use pydantic-settings BaseSettings for configuration. Read from environment variables with type validation. Use @lru_cache for singleton settings. Support .env files with env_file config. Dependency injection pattern for testing.</snippet>
        <url>https://fastapi.tiangolo.com/advanced/settings/</url>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/config.py</path>
        <kind>configuration</kind>
        <symbol>Settings</symbol>
        <lines>15-176</lines>
        <reason>Current Pydantic Settings implementation. Already loads from env with AI_AGENTS_ prefix. Has encryption_key, webhook_secret, admin_api_key, openrouter_api_key fields. Need to add POSTGRES_PASSWORD, REDIS_PASSWORD explicitly or via connection strings.</reason>
      </artifact>
      <artifact>
        <path>src/utils/encryption.py</path>
        <kind>utility</kind>
        <symbol>generate_encryption_key, encrypt, decrypt, EncryptionError</symbol>
        <lines>1-149</lines>
        <reason>Existing Fernet encryption utility for ENCRYPTION_KEY. Functions: generate_encryption_key() for key generation, encrypt/decrypt for credentials. Used by tenant config. Reuse for validator and secret generation docs.</reason>
      </artifact>
      <artifact>
        <path>.env.example</path>
        <kind>configuration-template</kind>
        <symbol>N/A</symbol>
        <lines>1-112</lines>
        <reason>Current environment variable template. Has POSTGRES_USER, POSTGRES_PASSWORD for Docker only. Missing: ENCRYPTION_KEY placeholder, Redis password example, separate K8s secret guidance. Needs update for Story 3.3.</reason>
      </artifact>
      <artifact>
        <path>k8s/deployment-api.yaml</path>
        <kind>kubernetes-manifest</kind>
        <symbol>N/A</symbol>
        <lines>37-57</lines>
        <reason>FastAPI deployment env section. Currently loads DATABASE_URL and REDIS_URL from secrets. Need to add individual secret mounts: POSTGRES_PASSWORD, REDIS_PASSWORD, OPENAI_API_KEY, ENCRYPTION_KEY as separate secretKeyRef entries.</reason>
      </artifact>
      <artifact>
        <path>k8s/deployment-worker.yaml</path>
        <kind>kubernetes-manifest</kind>
        <symbol>N/A</symbol>
        <lines>39-59</lines>
        <reason>Celery worker deployment env section. Same secrets needed as API deployment for database/Redis access and tenant config decryption. Parallel changes required.</reason>
      </artifact>
      <artifact>
        <path>src/main.py</path>
        <kind>fastapi-app</kind>
        <symbol>app</symbol>
        <lines>1-80</lines>
        <reason>FastAPI app initialization. No startup event handler for secret validation yet. Need to add @app.on_event("startup") async def validate_secrets_at_startup() that calls new validator.</reason>
      </artifact>
      <artifact>
        <path>src/workers/celery_app.py</path>
        <kind>celery-app</kind>
        <symbol>celery_app</symbol>
        <lines>1-66</lines>
        <reason>Celery app configuration using settings.celery_broker_url and settings.celery_result_backend. These already read from env. Verify secrets loaded before Celery init.</reason>
      </artifact>
      <artifact>
        <path>.gitignore</path>
        <kind>git-configuration</kind>
        <symbol>N/A</symbol>
        <lines>1-66</lines>
        <reason>Already ignores .env, .env.local, .env.*.local, and k8s/secrets.yaml. Properly configured for secret exclusion. Verify with git check-ignore as part of AC5.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="pydantic" version="2.x">Data validation and settings management</package>
        <package name="pydantic-settings" version="latest">Environment variable loading with BaseSettings</package>
        <package name="cryptography" version="latest">Fernet symmetric encryption (already installed)</package>
        <package name="python-dotenv" version="latest">Load .env files (optional, Pydantic can do this)</package>
      </python>
      <kubernetes>
        <resource name="Secret" apiVersion="v1">Native K8s secret storage</resource>
        <resource name="Deployment" apiVersion="apps/v1">Pod spec with env from secretKeyRef</resource>
      </kubernetes>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use Pydantic Settings BaseSettings pattern (established in src/config.py) - maintain AI_AGENTS_ prefix for all env vars</constraint>
    <constraint>Secrets must be minimum 12 characters for passwords, non-empty for API keys, valid Fernet format for encryption key</constraint>
    <constraint>Never commit secrets to git - verify with git check-ignore before deployment</constraint>
    <constraint>Kubernetes Secret manifest only provided as .example template (k8s/secrets.yaml.example) - actual k8s/secrets.yaml excluded via .gitignore</constraint>
    <constraint>Local dev uses .env file (ignored), production uses K8s secrets mounted as env vars - environment detection via KUBERNETES_SERVICE_HOST</constraint>
    <constraint>Application must gracefully fail at startup if required secrets missing - log clear error message and exit with code 1</constraint>
    <constraint>Use existing encryption.py utility for ENCRYPTION_KEY generation and validation - maintain consistency with Story 3.2 tenant encryption</constraint>
    <constraint>Follow established project structure: utilities in src/utils/, tests in tests/unit/, K8s manifests in k8s/, docs in docs/runbooks/</constraint>
    <constraint>Match architectural decision: Kubernetes Secrets (not Vault) for MVP per architecture.md line 48</constraint>
    <constraint>Secrets never logged or exposed in API responses - validation logs success/failure only, never secret values</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Settings.encryption_key</name>
      <kind>pydantic-field</kind>
      <signature>encryption_key: str = Field(..., description="Encryption key for sensitive fields (Fernet symmetric key)")</signature>
      <path>src/config.py:98-101</path>
      <reason>Existing field in Settings. Loaded from AI_AGENTS_ENCRYPTION_KEY env var. Used by encryption.py utility and tenant service.</reason>
    </interface>
    <interface>
      <name>generate_encryption_key()</name>
      <kind>function</kind>
      <signature>def generate_encryption_key() -> str</signature>
      <path>src/utils/encryption.py:110-125</path>
      <reason>Utility to generate Fernet keys. Document usage in secret generation docs and rotation runbook.</reason>
    </interface>
    <interface>
      <name>Kubernetes Secret secretKeyRef</name>
      <kind>kubernetes-resource-ref</kind>
      <signature>valueFrom:\n  secretKeyRef:\n    name: app-secrets\n    key: {secret-key}</signature>
      <path>k8s/deployment-api.yaml:48-52</path>
      <reason>K8s pattern for mounting secrets as env vars. Used in both deployment-api.yaml and deployment-worker.yaml for DATABASE_URL and REDIS_URL.</reason>
    </interface>
    <interface>
      <name>@app.on_event("startup")</name>
      <kind>fastapi-lifecycle</kind>
      <signature>@app.on_event("startup")\nasync def startup_handler():</signature>
      <path>src/main.py (new)</path>
      <reason>FastAPI startup event for initialization logic. Need to add validator here that runs before accepting requests.</reason>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Framework: pytest with pytest-asyncio for async tests. Pattern: test_*.py files in tests/unit/ with Test* classes and test_* methods. Fixtures: Use monkeypatch for environment variables, conftest.py for shared fixtures. Assertions: Use pytest assertions, parametrize for multiple test cases. Coverage: Aim for expected case, edge cases, and failure cases per story requirements. Testing pattern from test_encryption.py: monkeypatch.setenv() for mocking env vars, pytest.raises() for exception testing, fixtures for setup/teardown.
    </standards>
    <locations>
      <location>tests/unit/test_secrets.py</location>
      <location>tests/unit/test_config.py (update)</location>
      <location>tests/unit/test_encryption.py (reference pattern)</location>
    </locations>
    <ideas>
      <idea ac="AC7" task="7.3">Test validate_secrets() with all secrets present and valid → passes without exception</idea>
      <idea ac="AC7" task="7.3">Test validate_secrets() with missing POSTGRES_PASSWORD → raises EnvironmentError with clear message</idea>
      <idea ac="AC7" task="7.3">Test validate_secrets() with POSTGRES_PASSWORD too short (< 12 chars) → raises EnvironmentError</idea>
      <idea ac="AC7" task="7.3">Test validate_secrets() with invalid ENCRYPTION_KEY (not Fernet format) → raises EnvironmentError</idea>
      <idea ac="AC7" task="7.3">Test validate_secrets() with OPENAI_API_KEY empty string → raises EnvironmentError</idea>
      <idea ac="AC7" task="7.3">Test validate_secrets() error messages are actionable (include secret name and requirement)</idea>
      <idea ac="AC3" task="3.4">Test Settings loads secrets from environment variables successfully</idea>
      <idea ac="AC3" task="3.4">Test Settings raises validation error if required secret missing (using monkeypatch)</idea>
      <idea ac="AC3" task="3.4">Test application startup calls validate_secrets() and logs success message</idea>
      <idea ac="AC6" task="6.2">Test is_kubernetes_env() returns True when KUBERNETES_SERVICE_HOST set</idea>
      <idea ac="AC6" task="6.2">Test is_kubernetes_env() returns False in local environment</idea>
      <idea ac="AC5" task="5.1">Test .gitignore includes all secret file patterns (.env, k8s/secrets.yaml)</idea>
    </ideas>
  </tests>
</story-context>
