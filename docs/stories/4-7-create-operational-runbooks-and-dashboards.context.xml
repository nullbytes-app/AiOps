<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>7</storyId>
    <title>Create Operational Runbooks and Dashboards</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-7-create-operational-runbooks-and-dashboards.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>an on-call engineer</asA>
    <iWant>documented procedures for common operational tasks with an operational dashboard providing quick access to system actions</iWant>
    <soThat>I can respond to issues quickly and consistently without needing to remember complex diagnostic procedures or kubectl/docker commands</soThat>
    <tasks>
      <task id="1" title="Create Operational Runbook Structure and Index">
        <subtask id="1.1">Set up docs/runbooks/ directory structure</subtask>
        <subtask id="1.2">Create docs/runbooks/README.md as central runbook index</subtask>
        <subtask id="1.3">Create docs/operations/README.md as central operational docs index</subtask>
        <subtask id="1.4">Define standardized runbook template markdown structure</subtask>
      </task>
      <task id="2" title="Create High Queue Depth Operational Runbook">
        <subtask id="2.1">Write Overview section for queue depth 50-100 jobs</subtask>
        <subtask id="2.2">Write Symptoms section with observable indicators</subtask>
        <subtask id="2.3">Write Diagnosis section with Prometheus and Redis commands</subtask>
        <subtask id="2.4">Write Resolution section for scaling and investigation</subtask>
        <subtask id="2.5">Write Escalation section with thresholds</subtask>
        <subtask id="2.6">Add Related Documentation links</subtask>
      </task>
      <task id="3" title="Create Worker Failures Operational Runbook">
        <subtask id="3.1">Write Overview for worker crash investigation</subtask>
        <subtask id="3.2">Write Symptoms section for crash indicators</subtask>
        <subtask id="3.3">Write Diagnosis section with kubectl/docker commands</subtask>
        <subtask id="3.4">Write Resolution section including rolling restart</subtask>
        <subtask id="3.5">Write Escalation section</subtask>
        <subtask id="3.6">Add memory profiling guidance</subtask>
      </task>
      <task id="4" title="Create Database Connection Issues Operational Runbook">
        <subtask id="4.1">Write Overview for PostgreSQL connectivity problems</subtask>
        <subtask id="4.2">Write Symptoms section for database errors</subtask>
        <subtask id="4.3">Write Diagnosis section with PostgreSQL queries</subtask>
        <subtask id="4.4">Write Resolution section for connection pool and RLS issues</subtask>
        <subtask id="4.5">Write Escalation section</subtask>
        <subtask id="4.6">Add database failover procedures</subtask>
      </task>
      <task id="5" title="Create API Timeout Operational Runbook">
        <subtask id="5.1">Write Overview for external API timeout scenarios</subtask>
        <subtask id="5.2">Write Symptoms section for timeout errors</subtask>
        <subtask id="5.3">Write Diagnosis section with API testing commands</subtask>
        <subtask id="5.4">Write Resolution section for retry logic and circuit breakers</subtask>
        <subtask id="5.5">Write Escalation section</subtask>
        <subtask id="5.6">Add fallback/retry configuration examples</subtask>
      </task>
      <task id="6" title="Create Tenant Onboarding Operational Runbook">
        <subtask id="6.1">Write Overview and prerequisites</subtask>
        <subtask id="6.2">Write Prerequisites section with required information</subtask>
        <subtask id="6.3">Write step-by-step Procedure with validation commands</subtask>
        <subtask id="6.4">Write Rollback section</subtask>
        <subtask id="6.5">Write Post-onboarding checklist</subtask>
        <subtask id="6.6">Write Troubleshooting section</subtask>
      </task>
      <task id="7" title="Enhance Grafana Dashboard with Runbook Links">
        <subtask id="7.1">Export existing dashboard JSON from Grafana</subtask>
        <subtask id="7.2">Add runbook links to panel descriptions</subtask>
        <subtask id="7.3">Add Operations panel group with quick links</subtask>
        <subtask id="7.4">Re-import dashboard and verify links</subtask>
      </task>
      <task id="8" title="Update Prometheus Alert Annotations with Runbook URLs">
        <subtask id="8.1">Edit prometheus/alert-rules.yml and k8s/prometheus-alert-rules.yaml</subtask>
        <subtask id="8.2">Reload Prometheus configuration</subtask>
        <subtask id="8.3">Verify annotations visible in Prometheus UI</subtask>
      </task>
      <task id="9" title="Create Operations Center Dashboard">
        <subtask id="9.1">Create new dashboard in Grafana named Operations Center</subtask>
        <subtask id="9.2">Add System Status row with stat panels</subtask>
        <subtask id="9.3">Add Quick Actions row with text/link panels</subtask>
        <subtask id="9.4">Add Operational Runbooks row</subtask>
        <subtask id="9.5">Export dashboard as JSON to dashboards/operations-center.json</subtask>
        <subtask id="9.6">Create k8s/grafana-dashboard-operations.yaml ConfigMap</subtask>
      </task>
      <task id="10" title="Validate Runbooks with Team Member Testing">
        <subtask id="10.1">Identify team member with minimal system knowledge</subtask>
        <subtask id="10.2">Prepare test scenarios for each runbook</subtask>
        <subtask id="10.3">Observe tester following runbooks</subtask>
        <subtask id="10.4">Create docs/operations/runbook-validation-report.md</subtask>
        <subtask id="10.5">Apply improvements to runbooks based on findings</subtask>
        <subtask id="10.6">Re-test problematic runbooks</subtask>
      </task>
      <task id="11" title="Integrate Distributed Tracing References">
        <subtask id="11.1">Add Using Distributed Tracing subsection to each runbook</subtask>
        <subtask id="11.2">Add Jaeger query examples to each runbook</subtask>
        <subtask id="11.3">Cross-reference distributed-tracing-setup.md</subtask>
      </task>
      <task id="12" title="Document Quarterly Review Process">
        <subtask id="12.1">Add Maintenance and Review section to docs/runbooks/README.md</subtask>
        <subtask id="12.2">Add runbook review to project TASK.md</subtask>
        <subtask id="12.3">Create docs/runbooks/review-template.md</subtask>
        <subtask id="12.4">Document post-incident runbook update process</subtask>
      </task>
      <task id="13" title="Final Integration and Validation">
        <subtask id="13.1">Verify all runbooks accessible from Grafana</subtask>
        <subtask id="13.2">Verify alert runbook URLs in Prometheus</subtask>
        <subtask id="13.3">Verify Operations Center dashboard functionality</subtask>
        <subtask id="13.4">Create comprehensive operational documentation index</subtask>
        <subtask id="13.5">Test end-to-end incident response workflow</subtask>
        <subtask id="13.6">Document testing results</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Runbook: High Queue Depth (Non-Alert Scenario) - Operational runbook created for queue depth investigation when depth is elevated (50-100 jobs) but below alert threshold (100); includes diagnostic queries for queue age distribution, worker capacity analysis, and procedures for manual queue inspection</criterion>
    <criterion id="AC2">Runbook: Worker Failures - Operational runbook created covering worker crash investigation beyond automated WorkerDown alert; includes procedures for analyzing core dumps, memory profiling, identifying recurring crash patterns, and performing rolling restarts without service disruption</criterion>
    <criterion id="AC3">Runbook: Database Connection Issues - Operational runbook created for PostgreSQL connectivity problems; includes connection pool exhaustion diagnosis, row-level security troubleshooting, transaction lock identification, and database failover procedures</criterion>
    <criterion id="AC4">Runbook: API Timeout - Operational runbook created for external API timeout scenarios (ServiceDesk Plus, OpenAI); includes network trace analysis, API credential validation, rate limit diagnosis, and fallback/retry configuration guidance</criterion>
    <criterion id="AC5">Runbook: Tenant Onboarding - Procedural runbook created for adding new tenants to platform; includes ServiceDesk Plus webhook configuration, API credential setup, tenant database provisioning, validation testing, and rollback procedures</criterion>
    <criterion id="AC6">Grafana Dashboard Integration - Main AI Agents Platform dashboard (Story 4.3) enhanced with runbook links in panel descriptions; alert annotations in prometheus.yml updated with runbook_url field pointing to relevant docs/runbooks/*.md sections</criterion>
    <criterion id="AC7">Operations Center Dashboard - New Grafana dashboard created with quick-action panels including: view worker logs, restart workers, check queue status, view recent errors, access Jaeger traces; dashboard exported as JSON and deployed via Kubernetes ConfigMap</criterion>
    <criterion id="AC8">Runbook Structure Standardization - All 5 new runbooks follow consistent structure: Overview, Symptoms, Diagnosis, Resolution, Escalation sections; each runbook includes Quick Links section at top with jumps to key sections</criterion>
    <criterion id="AC9">Runbook Validation Testing - All 5 runbooks tested by team member with no prior system knowledge; team member successfully completes diagnostic and resolution procedures for each scenario using only runbook instructions; test results documented in runbook-validation-report.md</criterion>
    <criterion id="AC10">Runbook Repository Organization - Central runbook index created at docs/runbooks/README.md listing all available runbooks; docs/operations/README.md created as central index of all operational documentation; both indexes include search keywords for rapid navigation</criterion>
    <criterion id="AC11">Quarterly Review Process - Runbook maintenance process documented in docs/runbooks/README.md including: review schedule (quarterly + after major incidents), review checklist, version control procedure, and responsibility assignment</criterion>
    <criterion id="AC12">Integration with Distributed Tracing - All operational runbooks reference distributed tracing where applicable; runbooks include Jaeger query examples (search by tenant_id, ticket_id, slow_trace=true)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>AI Agents Product Requirements Document</title>
        <section>NFR005: Observability</section>
        <snippet>System shall provide real-time visibility into agent operations through Prometheus metrics and Grafana dashboards, with audit logs retained for 90 days and distributed tracing for debugging failed enhancements</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>AI Agents Product Requirements Document</title>
        <section>FR023-FR025: Monitoring Requirements</section>
        <snippet>System shall provide Grafana dashboards for real-time agent performance monitoring, log all enhancement operations with tenant ID, ticket ID, timestamp, and outcome, and alert on critical failures</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>AI Agents - Decision Architecture</title>
        <section>Observability Stack</section>
        <snippet>Prometheus for metrics instrumentation, Grafana for dashboards and visualizations, Loguru for application logging. Production-ready observability for multi-tenant platform</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics Definition</title>
        <section>Story 4.7 Requirements (Lines 917-933)</section>
        <snippet>Runbooks created for: High Queue Depth, Worker Failures, Database Connection Issues, API Timeout, Tenant Onboarding. Each runbook includes symptoms, diagnosis steps, resolution steps, escalation path. Runbooks linked from Grafana dashboard and alert annotations. Quarterly runbook review process established</snippet>
      </doc>
      <doc>
        <path>docs/operations/alert-runbooks.md</path>
        <title>Alert Runbooks - AI Agents Platform (Story 4.4)</title>
        <section>Existing Alert Runbooks</section>
        <snippet>4 alert runbooks created: EnhancementSuccessRateLow, QueueDepthHigh, WorkerDown, HighLatency. Structured format: Symptom, Common Root Causes, Troubleshooting Steps, Resolution, Escalation. Foundation for Story 4.7 operational runbooks</snippet>
      </doc>
      <doc>
        <path>docs/operations/distributed-tracing-setup.md</path>
        <title>Distributed Tracing Setup Guide (Story 4.6)</title>
        <section>Jaeger UI and Trace Visualization</section>
        <snippet>OpenTelemetry + Jaeger provides end-to-end trace visibility. Jaeger UI at http://localhost:16686 for trace search and visualization. Traces include webhook receipt, queue processing, context gathering, LLM synthesis, ticket update. Runbooks should reference tracing for diagnostics</snippet>
      </doc>
      <doc>
        <path>docs/operations/grafana-setup.md</path>
        <title>Grafana Setup Guide (Story 4.3)</title>
        <section>Dashboard Architecture</section>
        <snippet>Grafana visualizes Prometheus metrics. Main dashboard: AI Agents Platform Monitoring with panels for queue depth, success rate, latency, worker count. Dashboard panels support descriptions and links for contextual help</snippet>
      </doc>
      <doc>
        <path>docs/operations/prometheus-setup.md</path>
        <title>Prometheus Setup Guide (Story 4.2)</title>
        <section>Alert Rules and Annotations</section>
        <snippet>Prometheus alert rules support annotations including runbook_url field. Annotations visible in Prometheus UI and can be included in alert notifications</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>k8s/prometheus-alert-rules.yaml</path>
        <kind>configuration</kind>
        <symbol>Prometheus Alert Rules ConfigMap</symbol>
        <lines>1-68</lines>
        <reason>Contains existing alert rules with runbook_url annotations. Story 4.7 needs to verify and potentially enhance these annotations to point to correct runbook sections</reason>
      </artifact>
      <artifact>
        <path>k8s/grafana-dashboard.yaml</path>
        <kind>configuration</kind>
        <symbol>Grafana Main Dashboard ConfigMap</symbol>
        <lines>1-50</lines>
        <reason>Contains existing Grafana dashboard JSON. Story 4.7 Task 7 will enhance this dashboard by adding runbook links to panel descriptions</reason>
      </artifact>
      <artifact>
        <path>k8s/grafana-datasource.yaml</path>
        <kind>configuration</kind>
        <symbol>Grafana Datasource ConfigMap</symbol>
        <lines>all</lines>
        <reason>Defines Prometheus datasource connection for Grafana. Needed for Operations Center dashboard creation</reason>
      </artifact>
      <artifact>
        <path>docker-compose.yml</path>
        <kind>configuration</kind>
        <symbol>Docker Compose Service Definitions</symbol>
        <lines>1-100</lines>
        <reason>Defines local development services including Prometheus and Grafana. Runbooks will reference docker-compose commands for local environment operations (restart workers, view logs)</reason>
      </artifact>
      <artifact>
        <path>docs/operations/alert-runbooks.md</path>
        <kind>documentation</kind>
        <symbol>Existing Alert Runbooks (Story 4.4)</symbol>
        <lines>1-890</lines>
        <reason>Foundation runbook structure established in Story 4.4. Story 4.7 operational runbooks should follow similar structure and cross-reference these alert runbooks</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <ecosystem>grafana</ecosystem>
        <packages>
          <package name="grafana">latest (via Docker image prom/grafana)</package>
        </packages>
      </node>
      <node>
        <ecosystem>prometheus</ecosystem>
        <packages>
          <package name="prometheus">latest (via Docker image prom/prometheus)</package>
        </packages>
      </node>
      <node>
        <ecosystem>jaeger</ecosystem>
        <packages>
          <package name="jaeger">latest (all-in-one via Docker image jaegertracing/all-in-one)</package>
        </packages>
      </node>
      <node>
        <ecosystem>kubernetes</ecosystem>
        <packages>
          <package name="kubectl">v1.28+ (for k8s deployment and operations commands in runbooks)</package>
        </packages>
      </node>
      <node>
        <ecosystem>docker</ecosystem>
        <packages>
          <package name="docker-compose">latest (for local development operations)</package>
        </packages>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Runbooks must follow standardized structure: Overview, Symptoms, Diagnosis, Resolution, Escalation sections with Quick Links navigation</constraint>
    <constraint>All runbook commands must be copy-paste ready with no placeholders requiring editing (actual values or clear variable references)</constraint>
    <constraint>Runbooks must be tested by team member with minimal system knowledge to ensure clarity and completeness (AC9)</constraint>
    <constraint>Grafana dashboard enhancements must not break existing functionality - preserve all current panels and metrics</constraint>
    <constraint>Operations Center dashboard must use Grafana native components only (text panels, stat panels, link panels) - no custom plugins</constraint>
    <constraint>All file paths in runbooks and dashboards must use project-relative paths (e.g., docs/runbooks/*.md not absolute paths)</constraint>
    <constraint>Runbook documentation must be stored in version control (git) with descriptive commit messages for tracking changes</constraint>
    <constraint>Quarterly review process must be documented and added to project tracking (TASK.md)</constraint>
    <constraint>Runbooks must integrate distributed tracing guidance (Story 4.6) with specific Jaeger query examples</constraint>
    <constraint>Documentation style must follow existing Epic 4 patterns: comprehensive setup guides with code blocks, tables, cross-references</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Prometheus Alert Annotations</name>
      <kind>configuration</kind>
      <signature>annotations: { summary, description, runbook_url }</signature>
      <path>k8s/prometheus-alert-rules.yaml</path>
    </interface>
    <interface>
      <name>Grafana Dashboard Panel Description</name>
      <kind>configuration</kind>
      <signature>panel.description: string (supports markdown with links)</signature>
      <path>k8s/grafana-dashboard.yaml</path>
    </interface>
    <interface>
      <name>Grafana Dashboard JSON Export/Import</name>
      <kind>API</kind>
      <signature>Dashboard → Settings → JSON Model (copy/paste JSON for version control)</signature>
      <path>Grafana UI at http://localhost:3000</path>
    </interface>
    <interface>
      <name>Jaeger UI Search</name>
      <kind>API</kind>
      <signature>http://localhost:16686/search?service=&tags={key:value}&lookback=1h</signature>
      <path>docs/operations/distributed-tracing-setup.md</path>
    </interface>
    <interface>
      <name>Docker Compose Operations</name>
      <kind>CLI</kind>
      <signature>docker-compose logs [service] | docker-compose restart [service]</signature>
      <path>docker-compose.yml</path>
    </interface>
    <interface>
      <name>Kubernetes Operations</name>
      <kind>CLI</kind>
      <signature>kubectl logs -l app=[label] | kubectl rollout restart deployment/[name]</signature>
      <path>k8s/*.yaml</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Story 4.7 is primarily documentation and configuration work. Testing strategy focuses on validation and integration testing rather than unit tests. Key testing approaches: (1) Runbook validation testing with team member walkthrough (AC9), (2) End-to-end incident response workflow simulation (Task 13), (3) Manual verification of Grafana dashboard links and Prometheus alert annotations, (4) Runbook command execution validation in both Docker and Kubernetes environments</standards>
    <locations>
      <location>docs/operations/runbook-validation-report.md - Test results from team member runbook walkthrough (Task 10)</location>
      <location>Manual testing - Grafana UI verification of dashboard links and Operations Center functionality</location>
      <location>Manual testing - Prometheus UI verification of alert runbook_url annotations</location>
      <location>Manual testing - Execute sample commands from each runbook in local Docker environment</location>
    </locations>
    <ideas>
      <idea criterion="AC9">Runbook Validation Testing - Identify team member with minimal system knowledge, prepare test scenarios (queue backup, worker crash, API timeout), observe tester following runbooks without assistance, document ambiguities and time to complete, apply improvements based on findings</idea>
      <idea criterion="AC7">Operations Center Dashboard Functionality Test - Create all quick-action panels, verify stat panels display correct metrics with proper thresholds, test all links (Jaeger UI, Prometheus, runbooks), validate refresh behavior</idea>
      <idea criterion="AC6">Grafana Dashboard Integration Test - Export main dashboard JSON, add runbook links to panel descriptions, re-import dashboard, verify links resolve to correct runbook sections, confirm no panels broken</idea>
      <idea criterion="AC8">Runbook Structure Consistency Test - Automated script to validate all 5 runbooks contain required sections (Overview, Symptoms, Diagnosis, Resolution, Escalation, Quick Links), check for copy-paste ready commands (no placeholders like <YOUR_VALUE>)</idea>
      <idea criterion="AC12">Distributed Tracing Integration Test - Verify all 5 runbooks include "Using Distributed Tracing" subsection, validate Jaeger query examples are syntactically correct, test sample queries against Jaeger UI</idea>
    </ideas>
  </tests>
</story-context>
