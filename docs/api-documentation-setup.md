# API Documentation Setup - Redocly CLI

**Version:** 1.0 | **Date:** January 2025 | **Goal:** Generate HTML API docs from FastAPI OpenAPI spec

---

## Overview

This guide explains how to generate interactive HTML API documentation using Redocly CLI 2.11.1 from the FastAPI auto-generated OpenAPI specification.

**Output:** `docs/api-docs.html` (single-file HTML with 30+ endpoints documented)

**OpenAPI Source:** `/api/v1/openapi.json` (auto-generated by FastAPI)

---

## Prerequisites

### Required Software
- **Node.js:** >= 22.12.0 (required by Redocly CLI 2.11.1)
- **NPM:** >= 10.9.2
- **Redocly CLI:** 2.11.1 (latest stable as of 8 days ago)

### Check Versions
```bash
node --version   # Should be >= v22.12.0
npm --version    # Should be >= 10.9.2
```

### Install Node.js 22 (if needed)

**macOS (Homebrew):**
```bash
brew install node@22
```

**Ubuntu/Debian:**
```bash
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
sudo apt-get install -y nodejs
```

**Windows (Chocolatey):**
```bash
choco install nodejs-lts --version=22.12.0
```

---

## Step 1: Install Redocly CLI

### Global Installation (Recommended)
```bash
npm install -g @redocly/cli@2.11.1
```

### Verify Installation
```bash
redocly --version
# Expected output: 2.11.1
```

### Project-Local Installation (Alternative)
```bash
cd /path/to/ai-agents-platform
npm install --save-dev @redocly/cli@2.11.1
```

If installed locally, use `npx redocly` instead of `redocly` in all commands below.

---

## Step 2: Download OpenAPI Spec from FastAPI

### Option A: API Running Locally

**Start FastAPI if not running:**
```bash
cd /path/to/ai-agents-platform
docker-compose up -d api  # Or: uvicorn src.main:app --reload
```

**Download OpenAPI spec:**
```bash
curl http://localhost:8000/api/v1/openapi.json -o docs/openapi.json
```

**Verify download:**
```bash
cat docs/openapi.json | jq '.info.title'
# Expected output: "AI Agents Platform API"
```

### Option B: API Running in Production

```bash
curl https://your-domain.com/api/v1/openapi.json -o docs/openapi.json
```

### Option C: Use FastAPI's Built-In Export (Alternative)

```python
# scripts/export_openapi.py
from src.main import app
import json

# Export OpenAPI spec to JSON file
with open("docs/openapi.json", "w") as f:
    json.dump(app.openapi(), f, indent=2)

print("âœ… OpenAPI spec exported to docs/openapi.json")
```

**Run script:**
```bash
python scripts/export_openapi.py
```

---

## Step 3: Validate OpenAPI Spec

Redocly CLI 2.11.1 supports OpenAPI 3.2, 3.1, 3.0, AsyncAPI 3.0/2.6, and Arazzo 1.0.

**Run validation:**
```bash
redocly lint docs/openapi.json
```

**Expected output:**
```
âœ… docs/openapi.json: validated in 45ms

Woohoo! Your OpenAPI 3.1 definition is valid. ðŸŽ‰
```

**If errors found:**
- Fix errors in FastAPI code (e.g., missing descriptions, invalid schemas)
- Re-export OpenAPI spec (Step 2)
- Re-run validation

**Common errors and fixes:**

| Error | Cause | Fix |
|-------|-------|-----|
| `Missing description for operation` | Endpoint lacks docstring | Add docstring to FastAPI route function |
| `Schema validation failed` | Pydantic model has invalid schema | Fix Pydantic model (e.g., add `description` to fields) |
| `Duplicate operationId` | Two endpoints have same function name | Rename one of the functions or set custom `operation_id` |

---

## Step 4: Generate HTML Documentation

### Basic Command
```bash
redocly build-docs docs/openapi.json --output docs/api-docs.html
```

**Expected output:**
```
ðŸŽ‰ Success! Created docs/api-docs.html (238 KB) in 1.2s
```

### Advanced Options

**Custom theme (optional):**
```bash
redocly build-docs docs/openapi.json \
  --output docs/api-docs.html \
  --theme.colors.primary.main="#6366f1" \
  --theme.typography.fontFamily="Inter, sans-serif"
```

**With configuration file (optional):**

Create `redocly.yaml` in project root:
```yaml
# redocly.yaml
theme:
  colors:
    primary:
      main: '#6366f1'  # Indigo (matches Next.js UI)
  typography:
    fontFamily: 'Inter, sans-serif'
    fontSize: '14px'
    headings:
      fontFamily: 'Inter, sans-serif'

hideSingleRequestSampleTab: true
expandResponses: '200,201'
jsonSampleExpandLevel: 2
hideDownloadButton: false
disableSearch: false
nativeScrollbars: false
```

**Build with config:**
```bash
redocly build-docs docs/openapi.json \
  --output docs/api-docs.html \
  --config redocly.yaml
```

---

## Step 5: Verify Documentation

### Open HTML File
```bash
# macOS
open docs/api-docs.html

# Linux
xdg-open docs/api-docs.html

# Windows
start docs/api-docs.html
```

### Verify Content Checklist
- [ ] API title: "AI Agents Platform API"
- [ ] API version: "1.0.0" (from FastAPI)
- [ ] 30+ endpoints visible (grouped by tags: Authentication, Monitoring, Configuration, Operations, Advanced)
- [ ] Each endpoint shows:
  - [ ] HTTP method (GET, POST, PUT, DELETE)
  - [ ] Path (e.g., `/api/v1/agents`)
  - [ ] Description (from docstring)
  - [ ] Request body schema (for POST/PUT)
  - [ ] Response schema (200, 400, 401, 403, 404, 500)
  - [ ] Authentication required (JWT token in header)
- [ ] Search works (top-right search box)
- [ ] Sidebar navigation works (click on endpoint â†’ jumps to section)
- [ ] Code samples work (cURL, Python, JavaScript)

### Expected Endpoint Groups

**1. Authentication (`/api/v1/auth/*`)**
- POST `/api/v1/auth/register` - Register new user
- POST `/api/v1/auth/login` - Login and get tokens
- POST `/api/v1/auth/refresh` - Refresh access token
- POST `/api/v1/auth/logout` - Logout and revoke token

**2. Monitoring (`/api/v1/metrics/*`, `/api/v1/workers/*`)**
- GET `/api/v1/metrics/summary` - Dashboard metrics
- GET `/api/v1/metrics/agents` - Agent performance
- GET `/api/v1/metrics/llm-costs` - LLM cost breakdown
- GET `/api/v1/workers` - Worker status

**3. Configuration (`/api/v1/agents/*`, `/api/v1/tenants/*`, etc.)**
- GET `/api/v1/agents` - List agents
- POST `/api/v1/agents` - Create agent
- GET `/api/v1/agents/{id}` - Get agent details
- PUT `/api/v1/agents/{id}` - Update agent
- DELETE `/api/v1/agents/{id}` - Delete agent
- POST `/api/v1/agents/{id}/test` - Test agent
- GET `/api/v1/tenants` - List tenants
- POST `/api/v1/tenants` - Create tenant
- GET `/api/v1/llm-providers` - List LLM providers
- POST `/api/v1/plugins` - Upload plugin

**4. Operations (`/api/v1/executions/*`, `/api/v1/queue/*`)**
- GET `/api/v1/executions` - List executions
- GET `/api/v1/executions/{id}` - Get execution details
- POST `/api/v1/queue/pause` - Pause queue
- POST `/api/v1/queue/resume` - Resume queue
- GET `/api/v1/queue/status` - Queue status

**5. Advanced (`/api/v1/mcp-servers/*`, `/api/v1/prompts/*`)**
- GET `/api/v1/mcp-servers` - List MCP servers
- POST `/api/v1/mcp-servers` - Add MCP server
- POST `/api/v1/mcp-servers/{id}/test` - Test MCP connection
- GET `/api/v1/prompts` - List system prompts
- POST `/api/v1/prompts` - Create prompt

**Total:** 30+ endpoints

---

## Step 6: Deploy Documentation

### Option A: Host as Static File (Next.js Public Folder)

**Copy to Next.js public folder:**
```bash
cp docs/api-docs.html nextjs-ui/public/api-docs.html
```

**Access at:**
```
https://your-domain.com/api-docs.html
```

### Option B: Serve via FastAPI (Static Files)

**Mount static files in FastAPI:**
```python
# src/main.py
from fastapi.staticfiles import StaticFiles

app.mount("/docs", StaticFiles(directory="docs"), name="docs")
```

**Access at:**
```
https://your-domain.com/docs/api-docs.html
```

### Option C: Deploy to GitHub Pages (Public Repo)

```bash
# Commit and push
git add docs/api-docs.html
git commit -m "Add API documentation (Redocly)"
git push origin main

# Enable GitHub Pages
# Go to: Repo Settings â†’ Pages â†’ Source: main branch â†’ /docs folder
```

**Access at:**
```
https://your-username.github.io/your-repo/api-docs.html
```

---

## Step 7: Automate with CI/CD (Optional)

### GitHub Actions Workflow

Create `.github/workflows/api-docs.yml`:

```yaml
name: Generate API Docs

on:
  push:
    branches: [main]
    paths:
      - 'src/api/**'
      - 'src/schemas/**'

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js 22
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Install Redocly CLI
        run: npm install -g @redocly/cli@2.11.1

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Export OpenAPI spec
        run: python scripts/export_openapi.py

      - name: Validate OpenAPI spec
        run: redocly lint docs/openapi.json

      - name: Generate HTML docs
        run: redocly build-docs docs/openapi.json --output docs/api-docs.html

      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add docs/api-docs.html
          git commit -m "Update API documentation [skip ci]" || echo "No changes"
          git push
```

**This workflow:**
1. Triggers on changes to API files
2. Exports OpenAPI spec from FastAPI
3. Validates spec with Redocly
4. Generates HTML documentation
5. Commits and pushes to repo

---

## Troubleshooting

### Issue 1: `redocly: command not found`

**Cause:** Redocly CLI not in PATH

**Fix:**
```bash
# Check if installed globally
npm list -g @redocly/cli

# If not, install globally
npm install -g @redocly/cli@2.11.1

# Or use npx (no install needed)
npx @redocly/cli@2.11.1 build-docs docs/openapi.json --output docs/api-docs.html
```

### Issue 2: `Error: Cannot find module 'node:crypto'`

**Cause:** Node.js version too old (< 22.12.0)

**Fix:**
```bash
# Check Node.js version
node --version

# Upgrade to Node.js 22
brew install node@22  # macOS
# OR use nvm
nvm install 22
nvm use 22
```

### Issue 3: `OpenAPI validation failed`

**Cause:** FastAPI spec has errors

**Fix:**
1. Run `redocly lint docs/openapi.json` to see specific errors
2. Fix errors in FastAPI code (add docstrings, fix schemas)
3. Re-export OpenAPI spec
4. Re-run validation

### Issue 4: `docs/api-docs.html is 5MB (too large)`

**Cause:** Large number of endpoints or verbose descriptions

**Fix:**
```bash
# Option A: Minify HTML (gzip compression)
gzip -9 docs/api-docs.html
# Creates docs/api-docs.html.gz (typically 80% smaller)

# Option B: Split into multiple files (advanced)
# Use Redocly CLI's `--split` option (requires Redocly config)
```

### Issue 5: Authentication not showing in docs

**Cause:** FastAPI security scheme not defined

**Fix:**
```python
# src/main.py
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi

app = FastAPI()

def custom_openapi():
    if app.openapi_schema:
        return app.openapi_schema

    openapi_schema = get_openapi(
        title="AI Agents Platform API",
        version="1.0.0",
        description="API for managing AI agents, executions, and platform configuration.",
        routes=app.routes,
    )

    # Add security scheme (JWT Bearer token)
    openapi_schema["components"]["securitySchemes"] = {
        "BearerAuth": {
            "type": "http",
            "scheme": "bearer",
            "bearerFormat": "JWT",
            "description": "JWT token obtained from /api/v1/auth/login"
        }
    }

    # Apply security to all routes (except /auth/*)
    for path in openapi_schema["paths"]:
        if not path.startswith("/api/v1/auth"):
            for method in openapi_schema["paths"][path]:
                if method != "parameters":
                    openapi_schema["paths"][path][method]["security"] = [{"BearerAuth": []}]

    app.openapi_schema = openapi_schema
    return app.openapi_schema

app.openapi = custom_openapi
```

---

## Maintenance

### Update Cadence
- **On every API change:** Re-generate docs (automated via CI/CD)
- **Manual check:** Once per sprint (verify no broken links, outdated descriptions)

### Versioning
- If API has breaking changes, create separate docs: `docs/api-docs-v1.html`, `docs/api-docs-v2.html`
- Update link in Quick Start Guide and Migration Guide

---

## Example: Manual Generation

```bash
# Full workflow (run this whenever API changes)

# 1. Start API
docker-compose up -d api

# 2. Download OpenAPI spec
curl http://localhost:8000/api/v1/openapi.json -o docs/openapi.json

# 3. Validate
redocly lint docs/openapi.json

# 4. Generate HTML
redocly build-docs docs/openapi.json --output docs/api-docs.html

# 5. Open in browser
open docs/api-docs.html

# 6. Commit
git add docs/api-docs.html docs/openapi.json
git commit -m "Update API documentation"
git push
```

---

## Links & Resources

- **Redocly CLI Docs:** https://redocly.com/docs/cli/
- **Redocly GitHub:** https://github.com/Redocly/redocly-cli
- **FastAPI OpenAPI Docs:** https://fastapi.tiangolo.com/tutorial/metadata/
- **OpenAPI 3.1 Spec:** https://spec.openapis.org/oas/v3.1.0

---

**Generated by:** Bob (Scrum Master)
**Date:** January 2025
**Version:** 1.0

**Status:** âœ… Ready to execute
